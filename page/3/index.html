<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="magicwt的博客">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="magicwt的博客">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="magicwt的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/">





  <title>magicwt的博客</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">magicwt的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/08/24/postgresqlpostgis-e5-ae-89-e8-a3-85/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/08/24/postgresqlpostgis-e5-ae-89-e8-a3-85/" itemprop="url">PostgreSQL+PostGIS安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-08-24T20:08:39+08:00">
                2015-08-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/关系数据库/" itemprop="url" rel="index">
                    <span itemprop="name">关系数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>PostgreSQL(<a href="http://www.postgresql.org/)与MySQL类似，也是一款开源、免费数据库。PostGIS(http://www.postgis.org/)是一款PostgreSQL插件，为PostgreSQL提供GIS支持。在开发页面点击热力图时，需要以(x,y)坐标方式存储点击位置，所以使用PostgreSQL+PostGIS存储点击数据。" target="_blank" rel="noopener">http://www.postgresql.org/)与MySQL类似，也是一款开源、免费数据库。PostGIS(http://www.postgis.org/)是一款PostgreSQL插件，为PostgreSQL提供GIS支持。在开发页面点击热力图时，需要以(x,y)坐标方式存储点击位置，所以使用PostgreSQL+PostGIS存储点击数据。</a></p>
<h2 id="安装PostgreSQL"><a href="#安装PostgreSQL" class="headerlink" title="安装PostgreSQL"></a>安装PostgreSQL</h2><p>[blockquote]groupadd postgres<br>useradd -g postgres postgres<br>passwd postgres<br>tar -zxvf postgresql-9.5alpha2.tar.gz<br>cd postgresql-9.5alpha2<br>./configure –prefix=/opt/postgresql<br>make<br>make install<br>cd /opt/<br>chown -R postgres:postgres postgresql<br>su - postgres<br>/opt/postgresql/bin/initdb -D /opt/postgresql/data<br>/opt/postgresql/bin/pg_ctl -D /opt/postgresql/data -l /opt/postgresql/logfile start[/blockquote]<br><a href="http://magicwt.com/wp-content/uploads/2015/11/110.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/110-300x31.png" alt="1"></a><br>使用“/opt/postgresql/bin/psql -U postgres”可以登录数据库，执行相关操作。</p>
<h2 id="安装PostGIS"><a href="#安装PostGIS" class="headerlink" title="安装PostGIS"></a>安装PostGIS</h2><p>从源码安装，需要先安装GEOS，Proj.4，GDAL，LibXML2和JSON-C(<a href="http://postgis.net/source/)。" target="_blank" rel="noopener">http://postgis.net/source/)。</a><br>[blockquote]tar -jxvf geos-3.5.0.tar.bz2<br>cd geos-3.5.0<br>./configure<br>make<br>make install<br>tar -zxvf proj.4-4.9.1.tar.gz<br>cd proj.4-4.9.1<br>./configure<br>make<br>make install<br>tar -zxvf gdal-1.10.0.tar.gz<br>cd gdal-1.10.0<br>./configure<br>make<br>make install<br>tar -zxvf libxml2-2.9.2.tar.gz<br>cd libxml2-2.9.2<br>./configure<br>make<br>make install<br>tar -zxvf json-c-json-c-0.11-20130402.tar.gz<br>cd json-c-json-c-0.11-20130402<br>./configure<br>make<br>make install<br>tar -zxvf postgis-2.1.8.tar.gz<br>cd postgis-2.1.8<br>./configure –with-pgconfig=/opt/postgresql/bin/pg_config<br>make<br>make install<br>su - postgres<br>/opt/postgresql/bin/createdb postgis<br>/opt/postgresql/bin/psql -d postgis -U postgres -f /opt/postgresql/share/contrib/postgis-2.1/postgis.sql[/blockquote]<br>执行上述语句有可能报错，打开日志文件/opt/postgresql/logfile，会有如下错误：<br>[blockquote]ERROR: could not load library “/opt/postgresql/lib/postgis-2.1.so”: libgeos_c.so.1: cannot open shared object file: No such file or directory[/blockquote]<br>执行“ldd /opt/postgresql/lib/postgis-2.1.so”，缺少两个so文件：<br>[blockquote]linux-vdso.so.1 =&gt; (0x00007fff3d1fe000)<br>libgeos_c.so.1 =&gt; not found<br>libproj.so.9 =&gt; not found<br>libjson-c.so.2 =&gt; /lib64/libjson-c.so.2 (0x00007fb8f08f1000)<br>libxml2.so.2 =&gt; /lib64/libxml2.so.2 (0x00007fb8f0588000)<br>libm.so.6 =&gt; /lib64/libm.so.6 (0x00007fb8f0285000)<br>libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fb8efec4000)<br>libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007fb8efcc0000)<br>libz.so.1 =&gt; /lib64/libz.so.1 (0x00007fb8efaa9000)<br>liblzma.so.5 =&gt; /lib64/liblzma.so.5 (0x00007fb8ef884000)<br>/lib64/ld-linux-x86-64.so.2 (0x00007fb8f0dac000)<br>libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007fb8ef668000)[/blockquote]<br>执行以下语句可解决：<br>[blockquote]ln -s /usr/local/lib/libgeos_c.so.1 /lib64/libgeos_c.so.1<br>ln -s /usr/local/lib/libproj.so.9 /lib64/libproj.so.9[/blockquote]</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>[blockquote]postgis=# CREATE TABLE IF NOT EXISTS click (id int primary key,pt geometry);<br>postgis=# insert into click values (1,’POINT(30 40)’);<br>postgis=# select * from click;<br> id |                     pt<br>—-+——————————————–<br>  1 | 01010000000000000000003E400000000000004440 [/blockquote]</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/08/15/storm-e8-af-bb-e4-b9-a6-e7-ac-94-e8-ae-b0/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/08/15/storm-e8-af-bb-e4-b9-a6-e7-ac-94-e8-ae-b0/" itemprop="url">storm读书笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-08-15T10:47:52+08:00">
                2015-08-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是storm"><a href="#什么是storm" class="headerlink" title="什么是storm"></a><span class="s1" style="line-height: 1.5;"><strong>什么是</strong></span><span class="s2" style="line-height: 1.5;">storm</span></h1><ul>
<li><span class="s2">分布式实时计算系统；</span></li>
<li><span class="s2">与hadoop为批处理提供map和reduce这两种操作原语类似，storm为实时处理也提供了spout和bolt这两种操作原语；</span></li>
<li><p><span class="s2">storm的特点：</span></p>
<ol>
<li><span class="s2">可扩展性，通过增加集群机器、调整计算并行度，即可以扩展计算性能；</span></li>
<li><span class="s2">保证数据不丢失，每条消息至少能被执行一次；</span></li>
<li>健壮性，集群状态保存在zookeeper中，节点不保存状态，节点故障不影响系统运行；</li>
<li>容错性，计算任务错误时，能够及时重新分配、运行计算任务，保证计算任务永远运行；</li>
<li>支持多种开发语言，java、python等。</li>
</ol>
</li>
</ul>
<h1 id="storm的计算模型"><a href="#storm的计算模型" class="headerlink" title="storm的计算模型"></a><span class="s2"><strong>storm的计算模型</strong></span></h1><ul>
<li><span class="s2">tuple，元组，strom中的数据模型，tuple由多个key-value组成；</span></li>
<li><span class="s2">stream，流，多个tuple组成的序列，storm的计算过程就是输入流，对流进行转换、计算的过程；</span></li>
<li><span class="s2">spout，输入流的操作；</span></li>
<li><span class="s2">bolt，转换流的操作；</span></li>
<li><span class="s2">topology，拓扑，由多个spout和bolt操作组成，实现某个具体计算任务。</span></li>
</ul>
<p><a href="http://magicwt.com/wp-content/uploads/2015/08/1.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/08/1-300x228.png" alt="1"></a></p>
<p>以word count为例，其spout生成sentence流，bolt 1接收sentence流，进行分词操作，生成word流，bolt 2接收word流，计算每个词出现的次数</p>
<h1 id="storm的部署"><a href="#storm的部署" class="headerlink" title=" storm的部署"></a><span class="s2"> storm</span><span class="s1"><strong>的部署<img src="http://magicwt.com/wp-content/uploads/2015/08/2-300x231.png" alt="2"></strong></span></h1><ul>
<li><span class="s2">一个nimbus节点，多个supervisor节点，所有的节点都是fail-fast和无状态，状态保存在zookeeper和本地磁盘；</span></li>
<li><span class="s2">nimbus，类似于hadoop中的JobTracker，负责在集群中分发代码，分配计算任务，监控失败等；</span></li>
<li><span class="s2">supervisor，类似于hadoop中的的TaskTracker，负责在集群中按照nimbus的分配，启动和停止</span> <span class="s2">计算任务。</span></li>
</ul>
<p><a href="http://magicwt.com/wp-content/uploads/2015/08/3.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/08/3-300x178.png" alt="3"></a></p>
<p><span class="s2">通过storm提供的ui模块可以查看集群信息，从上述图中可以看出集群包含4个supervisor节点。</span></p>
<h1 id="storm的api"><a href="#storm的api" class="headerlink" title="storm的api"></a><span class="s2">storm</span><span class="s1"><strong>的</strong></span><span class="s2">api</span></h1><ul>
<li><span class="s2">ISpout：</span></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public interface ISpout extends Serializable &#123;   </span><br><span class="line">    void open(Map conf, TopologyContext context, SpoutOutputCollector collector);   //work进程初始化spout时运行该方法；</span><br><span class="line">    void nextTuple();   //使用collector发送tuple；</span><br><span class="line">    void ack(Object msgId);   //某个tuple处理成功后，运行该方法；</span><br><span class="line">    void fail(Object msgId);   //某个tuple处理失败后，运行该方法；</span><br><span class="line">    void close();//关闭spout时运行该方法</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><span class="s2">IBolt：</span></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public interface IBolt extends Serializable &#123;</span><br><span class="line">    void prepare(Map stormConf, TopologyContext context, OutputCollector collector); //work进程初始化bolt时运行该方法；</span><br><span class="line">    void execute(Tuple input);//处理tuple</span><br><span class="line">    void cleanup();//关闭bolt时运行该方法</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><span class="s2">TopologyBuilder：</span></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class TopologyBuilder &#123;</span><br><span class="line">    public StormTopology createTopology() &#123;…&#125;//创建topology</span><br><span class="line">    public BoltDeclarer setBolt(String id, IRichBolt bolt) &#123;…&#125;//设置bolt</span><br><span class="line">    public BoltDeclarer setBolt(String id, IRichBolt bolt, Number parallelism_hint) &#123;...&#125;</span><br><span class="line">    public BoltDeclarer setBolt(String id, IBasicBolt bolt) &#123;...&#125;</span><br><span class="line">    public BoltDeclarer setBolt(String id, IBasicBolt bolt, Number parallelism_hint) &#123;...&#125;</span><br><span class="line">    public SpoutDeclarer setSpout(String id, IRichSpout spout) &#123;…&#125;//设置spout</span><br><span class="line">    public SpoutDeclarer setSpout(String id, IRichSpout spout, Number parallelism_hint) &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><span class="s2">StormSubmitter：</span></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class StormSubmitter &#123; </span><br><span class="line">    public static void submitTopology(String name, Map stormConf, StormTopology topology) throws AlreadyAliveException, InvalidTopologyException &#123;…&#125;//向集群中提交topology</span><br><span class="line">    public static void submitTopology(String name, Map stormConf, StormTopology topology, SubmitOptions opts, ProgressListener progressListener) throws AlreadyAliveException, InvalidTopologyException &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><span class="s2">LocalCluster：</span></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class LocalCluster implements ILocalCluster &#123;</span><br><span class="line">    public void submitTopology(String var1, Map var2, StormTopology var3) &#123;…&#125;//在本地提交运行toplogy，多用于测试</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="storm的数据可靠性"><a href="#storm的数据可靠性" class="headerlink" title="storm的数据可靠性"></a><span class="s4"><strong>storm</strong></span><span class="s2"><strong>的数据可靠性</strong></span></h1><ul>
<li><span class="s2">什么是storm的数据可靠性（数据完全被处理）？</span></li>
</ul>
<p><span class="s5">仍以</span><span class="s2">word count为例，spout从外部队列取消息生成sentence tuple，bolt 1生成word tuple，bolt2 生成word count tuple，这些tuple组成tuple树，sentence tuple是树的根节点。</span></p>
<p><span class="s6">当tuple</span><span class="s2">树的所有叶子节点都被确认成功处理时，根节点才会被确认成功处理，这时可以向外部队列发送消息确认，否则会重新从外部队列获取消息再次处理。</span></p>
<p><a href="http://magicwt.com/wp-content/uploads/2015/08/4.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/08/4-300x232.png" alt="4"></a></p>
<ul>
<li><span class="s2">代码中如何保证数据可靠性？</span></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class SplitSentence extends BaseRichBolt &#123;</span><br><span class="line">    OutputCollector _collector;</span><br><span class="line"></span><br><span class="line">    public void prepare(Map conf, TopologyContext context, OutputCollector collector) &#123;</span><br><span class="line">        _collector = collector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void execute(Tuple tuple) &#123;</span><br><span class="line">        String sentence = tuple.getString(0);</span><br><span class="line">        for(String word: sentence.split(&quot; &quot;)) &#123;</span><br><span class="line">            _collector.emit(tuple, new Values(word));//发送新tuple</span><br><span class="line">        &#125;</span><br><span class="line">        _collector.ack(tuple);//确认原tuple</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer declarer) &#123;</span><br><span class="line">        declarer.declare(new Fields(&quot;word&quot;));</span><br><span class="line">    &#125;        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><span class="s2">其中_collector.ack(tuple)用于确认输入tuple是否被正常处理。</span></p>
<ul>
<li><span class="s2">_collector.emit(oldTuple, newTuple)与_collector.emit(newTuple)的区别</span></li>
</ul>
<p><span class="s2">前者会执行anchor操作，即在tuple树中构建oldTuple和newTuple的父子关系，newTuple及其后续tuple需要被确认成功处理，tuple树根节点才会被确认成功处理。</span></p>
<p><span class="s2">后者不会执行anchor操作，即在tuple树中只要oldTuple及其前续tuple被确认成功处理，tuple树根节点就会被确认成功处理，而不用监控后续tuple。</span></p>
<ul>
<li><span class="s2">数据可靠性的实现原理</span></li>
</ul>
<p><span class="s2">topology在负责spout和bolt的进程外，还有一个负责ack的进程，用于在emit和ack操作时，更新tuple树，ack进程确认tuple被成功处理是采用异或来实现的。</span></p>
<blockquote>
<p><span class="s2">tuple1 xor tuple1 xor tuple2 xor tuple2 = 0</span></p>
</blockquote>
<p><span class="s2">异或结果为0说明所有的tuple都被正常处理。</span></p>
<h1 id="storm的并行计算"><a href="#storm的并行计算" class="headerlink" title="storm的并行计算"></a><span class="s4"><strong>storm</strong></span><span class="s2"><strong>的并行计算</strong></span></h1><ul>
<li><p><span class="s2">三类实体：</span></p>
<ol>
<li>worker：集群中的每台机器运行多个worker进程（默认值4）；</li>
<li>executor：每个worker processe进程运行多个executor线程；</li>
<li>task：每个executor运行多个task（即spout和bolt）。</li>
</ol>
</li>
<li><p><span class="s2">并行计算实例：</span></p>
</li>
</ul>
<p><a href="http://magicwt.com/wp-content/uploads/2015/08/5.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/08/5-300x127.png" alt="5"></a></p>
<p><span class="s2">该topology由1个spout、2个bolt组成，需要设置blue-spout并行度为2，green-bolt并行度为2，yellow-bolt并行度为6，以下是在并行度配置代码：</span></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Config conf = new Config();</span><br><span class="line">conf.setNumWorkers(2); //使用两个worker进程运行topology</span><br><span class="line">topologyBuilder.setSpout(&quot;blue-spout&quot;, new BlueSpout(), 2); //使用2个executor线程运行blue-spout</span><br><span class="line">topologyBuilder.setBolt(&quot;green-bolt&quot;, new GreenBolt(), 2).setNumTasks(4).shuffleGrouping(“blue-spout”);//使用2个executor线程运行green-bolt，并使用4个task</span><br><span class="line">topologyBuilder.setBolt(&quot;yellow-bolt&quot;, new YellowBolt(), 6).shuffleGrouping(“green-bolt”);//使用6个executor线程运行yellow-bolt</span><br><span class="line">StormSubmitter.submitTopology(&quot;mytopology&quot;,conf,topologyBuilder.createTopology());</span><br></pre></td></tr></table></figure>
<p><span class="s2">运行的进程、线程状态如图所示，共分配2个worker进程，10个executor线程，12个task，每个</span> <span class="s2">进程各运行5个线程。</span></p>
<p><a href="http://magicwt.com/wp-content/uploads/2015/08/6.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/08/6-122x300.png" alt="6"></a></p>
<h1 id="storm的分组策略"><a href="#storm的分组策略" class="headerlink" title="storm的分组策略"></a><span class="s2"><strong>storm</strong></span><span class="s1"><strong>的分组策略</strong></span></h1><ul>
<li><span class="s2">shuffle grouping：随机分组；</span></li>
<li><span class="s2">fields grouping：按字段分组；</span></li>
<li><span class="s2">all grouping：广播分组，发送到bolt的所有</span><span class="s3">task</span><span class="s2">中；</span></li>
<li><span class="s2">global grouping</span><span class="s3">：</span><span class="s2">发送到</span><span class="s3">bolt</span><span class="s2">的同一个task</span><span class="s3">(task id</span><span class="s2">最小</span><span class="s3">)</span><span class="s2">中</span><span class="s5">；</span></li>
<li><span class="s2">none grouping：同shuffle group</span><span class="s3">ing</span><span class="s2">；</span></li>
<li><span class="s2">direct grouping：制定发送给某个task。</span></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/08/07/e5-9f-ba-e4-ba-8eseleniumphantomjs-e6-a8-a1-e6-8b-9f-e6-b5-8f-e8-a7-88-e5-99-a8-e8-ae-bf-e9-97-ae/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/08/07/e5-9f-ba-e4-ba-8eseleniumphantomjs-e6-a8-a1-e6-8b-9f-e6-b5-8f-e8-a7-88-e5-99-a8-e8-ae-bf-e9-97-ae/" itemprop="url">基于Selenium+PhantomJS模拟浏览器访问</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-08-07T23:42:34+08:00">
                2015-08-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><h3 id="Selenium"><a href="#Selenium" class="headerlink" title="Selenium"></a>Selenium</h3><p>Selenium（<a href="http://docs.seleniumhq.org/）是一个Web应用自动化测试工具集，可以在多个浏览器平台上执行测试用例。Selenium包含以下几个工具：" target="_blank" rel="noopener">http://docs.seleniumhq.org/）是一个Web应用自动化测试工具集，可以在多个浏览器平台上执行测试用例。Selenium包含以下几个工具：</a><br>1）Selenium 1 (Selenium RC or Remote Control)：Selenium 1的核心是一个JavaScript库，通过该库可以和浏览器中的页面进行交互。Selenium RC基于该库，可以使用多种语言开发测试用例，在多个浏览器平台上执行测试用例。<br>2）Selenium 2 (Selenium WebDriver)：Selenium 1基于JavaScript库，因此受限于浏览器对于JavaScript的安全限制，Selenium 1对于浏览器中的页面交互也存在着很多限制。Selenium 2基于WebDriver，而WebDriver基于浏览器和操作系统提供的原生方法，因此Selenium 2可以直接操作浏览器，避免了JavaScript的安全限制。Selenium 2也可以使用多种语言开发测试用例，在多个浏览器平台上执行测试用例。<br>3）Selenium IDE：Selenium IDE是一个FireFox插件，可以记录用户操作并导出成可重复执行的脚本。<br>4）Selenium-Grid：Selenium-Grid可以用来扩展Selenium RC，例如可以在不同的机器上并行执行测试用例。<br>由于存在较多限制，已不推荐使用Selenium RC，而推荐使用Selenium WebDriver。Selenium WebDriver支持的浏览器有：<br>1）Google Chrome；<br>2）Internet Explorer 6, 7, 8, 9, 10；<br>3）Firefox；<br>4）Safari；<br>5）Opera；<br>6）HtmlUnit；<br>7）PhantomJS；<br>8）Android；<br>9）iOS。</p>
<h3 id="PhantomJS"><a href="#PhantomJS" class="headerlink" title="PhantomJS"></a>PhantomJS</h3><p>PhantomJS（<a href="http://phantomjs.org/）是一个基于WebKit的JavaScript" target="_blank" rel="noopener">http://phantomjs.org/）是一个基于WebKit的JavaScript</a> API，它原生支持各种Web标准，例如DOM解析、CSS选择器、JSON、Canvas、SVG等。PhantomJS可用于：<br>1）无GUI浏览器下的Web站点测试；<br>2）网页截屏；<br>3）基于DOM API访问和操作网页；<br>4）监控网页加载。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="Selenium-1"><a href="#Selenium-1" class="headerlink" title="Selenium"></a>Selenium</h3><p>Selenium支持的语言有：<br>1）Java；<br>2）C#；<br>3）Python；<br>4）Ruby；<br>5）PHP；<br>6）Perl；<br>7）JavaScript。<br>这里介绍Python Selenium包的安装。操作系统为Linux，并已安装Python 2.7.5和pip，直接使用pip安装Selenium：<br>[blockquote]pip install selenium[/blockquote]</p>
<h3 id="PhantomJS-1"><a href="#PhantomJS-1" class="headerlink" title="PhantomJS"></a>PhantomJS</h3><p>下载PhantomJS的可执行包phantomjs-1.9.8-linux-x86_64.bz2，解压后将bin/phantomjs拷贝至/bin下即可。Shell中输入phantomjs可打开REPL，也可以使用phantomjs执行代码文件：<br>[blockquote]phantomjs hello.js[/blockquote]<br>hello.js代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">console.log(&apos;Hello, world!&apos;);</span><br><span class="line">phantom.exit();</span><br></pre></td></tr></table></figure></p>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><p>基于Selenium+PhantomJS模拟浏览器访问网页，输入用户名和密码并点击登录按钮，网页HTML代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;tr&gt;</span><br><span class="line">  &lt;td&gt;用户名：&lt;/td&gt;</span><br><span class="line">  &lt;td&gt;&lt;input type=&quot;text&quot; id=&quot;username&quot; placeholder=&quot;用户名&quot;&gt;&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;tr&gt;</span><br><span class="line">  &lt;td&gt;密码：&lt;/td&gt;</span><br><span class="line">  &lt;td&gt;&lt;input type=&quot;password&quot; id=&quot;password&quot; placeholder=&quot;密码&quot;&gt;&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;tr&gt;</span><br><span class="line">  &lt;td colspan=&quot;2&quot;&gt;&lt;button id=&quot;logon&quot;&gt;登录&lt;/button&gt;&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br></pre></td></tr></table></figure></p>
<p>Python代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from selenium import webdriver</span><br><span class="line"></span><br><span class="line">driver = webdriver.PhantomJS()</span><br><span class="line">driver.set_page_load_timeout(300)</span><br><span class="line">driver.get(&apos;http://xxx.xxx.xxx.xxx/login.html&apos;)</span><br><span class="line">driver.find_element_by_id(&apos;username&apos;).send_keys(u&apos;username&apos;)</span><br><span class="line">driver.find_element_by_id(&apos;password&apos;).send_keys(u&apos;password&apos;)</span><br><span class="line">driver.find_element_by_id(&apos;logon&apos;).click()</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/08/05/simpledateformat-e7-ba-bf-e7-a8-8b-e5-ae-89-e5-85-a8-e9-97-ae-e9-a2-98/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/08/05/simpledateformat-e7-ba-bf-e7-a8-8b-e5-ae-89-e5-85-a8-e9-97-ae-e9-a2-98/" itemprop="url">SimpleDateFormat线程安全问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-08-05T01:31:36+08:00">
                2015-08-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在需要进行日期与字符串相互转换的类中，经常会声明一个静态的SimpleDateFormat变量，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private static SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br></pre></td></tr></table></figure></p>
<p>然后就可以直接使用sdf的format和parse方法进行日期与字符串的相互转换，但是SimpleDateFormat并不是线程安全的，我们使用如下代码验证SimpleDateFormat的线程安全问题：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line"></span><br><span class="line">    private static SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br><span class="line">    private static String[] dates = new String[]&#123;&quot;2015-07-01 10:45:52&quot;, &quot;2015-07-02 09:34:11&quot;,</span><br><span class="line">            &quot;2015-07-01 07:12:32&quot;, &quot;2015-07-03 15:06:54&quot;, &quot;2015-07-02 21:12:38&quot;,</span><br><span class="line">            &quot;2015-07-01 01:59:01&quot;, &quot;2015-07-02 13:51:18&quot;, &quot;2015-07-03 10:05:08&quot;&#125;;</span><br><span class="line"></span><br><span class="line">    public static class MyThread extends Thread &#123;</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            for (int i=0; i&lt;100; i++) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + &quot;\t&quot; + sdf.format(sdf.parse(dates[new Random().nextInt(8)])));</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws ParseException &#123;</span><br><span class="line">        MyThread t1 = new MyThread();</span><br><span class="line">        MyThread t2 = new MyThread();</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MyThread线程循环100次，每次从dates数组中随机取出一个日期字符串，依次进行parse和format操作后再输出最终的日期字符串，若声明一个MyThread线程运行，则输出如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/12/12.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/12-300x223.png" alt="1"></a><br>输出的日期字符串都在dates数组中，说明parse和format操作均正常。若声明两个MyThread线程运行，则输出如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/12/13.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/13-300x141.png" alt="1"></a><br>输出的日期字符串有不在dates数组中的，且还存在异常，说明parse和format操作并不是线程安全的。<br>在多线程下若要使用SimpleDateFormat，一种方法是每次进行日期与字符串转换时，声明一个SimpleDateFormat变量，但这样会产生过多的变量实例，另一种方法是使用ThreadLocal为每个线程保存一个SimpleDateFormat变量实例，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class DateUtil &#123;</span><br><span class="line"></span><br><span class="line">    private static ThreadLocal&lt;SimpleDateFormat&gt; threadLocal = new ThreadLocal&lt;SimpleDateFormat&gt;() &#123;</span><br><span class="line">        protected synchronized SimpleDateFormat initialValue() &#123;</span><br><span class="line">            return new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    public static SimpleDateFormat get() &#123;</span><br><span class="line">        return threadLocal.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Date parse(String s) throws ParseException &#123;</span><br><span class="line">        return get().parse(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String format(Date d) &#123;</span><br><span class="line">        return get().format(d);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同时修改MyThread，使用DateUtil进行日期与字符串转换，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public static class MyThread extends Thread &#123;</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            for (int i=0; i&lt;100; i++) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + &quot;\t&quot; + DateUtil.format(DateUtil.parse(dates[new Random().nextInt(8)])));</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>再声明两个MyThread线程运行，则输出正常。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/20/openresty-e7-ae-80-e4-bb-8b-e4-b8-8e-e5-ae-9e-e8-b7-b5/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/04/20/openresty-e7-ae-80-e4-bb-8b-e4-b8-8e-e5-ae-9e-e8-b7-b5/" itemprop="url">OpenResty简介与实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-04-20T23:33:37+08:00">
                2015-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>OpenResty（亦称ngx_openresty，<a href="http://openresty.org/）是一个基于Nginx的" target="_blank" rel="noopener">http://openresty.org/）是一个基于Nginx的</a> Web 应用服务器。它集成了Nginx内核、LuaJIT、Lua语言实现的库以及许多第三方的Nginx模块。开发者可以使用Lua语言对Nginx中的C模块和Lua模块进行脚本编程，从而构建高性能的Web应用。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>[blockquote]tar xvf ngx_openresty-1.7.7.2.tar.gz<br>cd ngx_openresty-1.7.7.2/<br>./configure<br>make<br>make install[/blockquote]<br>OpenResty依赖perl 5.6.1+、libreadline、libpcre、libssl，因此在configure时，可能会由于缺少依赖报如下错误：<br>1）“./configure: error: the HTTP rewrite module requires the PCRE library.”<br>需要安装libpcre：<br>[blockquote]yum install pcre-devel.x86_64[/blockquote]<br>2）“./configure: error: SSL modules require the OpenSSL library.”<br>需要安装libssl：<br>[blockquote]yum install openssl-devel.x86_64[/blockquote]<br>安装成功后，OpenResty默认安装至/usr/local/openresty。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>使用OpenResty开发接口，该接口实现以下逻辑：<br>1）接口根据传入的key返回value；<br>2）接口先尝试从Redis中读取key所对应的value，若读取到value，则直接返回；<br>3）若读取不到value，则接口再尝试从MySQL中读取key所对应的value，若读取到value，则将key-value写入Redis，并返回value。<br>在OpenResty安装目录的nginx/conf中新建Lua脚本文件value.lua，代码如下所示，其实现了上述逻辑：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">-- ################## 解析参数key ########################</span><br><span class="line">local cjson = require &quot;cjson&quot;</span><br><span class="line">local key = tostring(ngx.var.arg_key)</span><br><span class="line">if key == &apos;nil&apos; then</span><br><span class="line">	ngx.say(cjson.encode(&#123;status = false, msg = &apos;need parameter key&apos;&#125;))</span><br><span class="line">	return</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- ################## 初始化Redis和MySQL ########################</span><br><span class="line">local mysql = require &apos;resty.mysql&apos;</span><br><span class="line">local conn = mysql:new()</span><br><span class="line">local props = &#123;</span><br><span class="line">    host = &quot;xxx.xxx.xxx.xxx&quot;,</span><br><span class="line">    port = 3306,</span><br><span class="line">    database = &quot;xxx&quot;,</span><br><span class="line">    user = &quot;xxx&quot;,</span><br><span class="line">    password = &quot;xxx&quot;</span><br><span class="line">&#125;</span><br><span class="line">-- 使用connect方法创建连接，该方法会先尝试从连接池中获取已有连接</span><br><span class="line">local res, err, errno, sqlstate = conn:connect(props)</span><br><span class="line">if not res then</span><br><span class="line">	print(&quot;connect to mysql error : &quot;, err, &quot; , errno : &quot;, errno, &quot; , sqlstate : &quot;, sqlstate)</span><br><span class="line">	ngx.say(cjson.encode(&#123;status = false, msg = &apos;internal error&apos;&#125;))</span><br><span class="line">	return</span><br><span class="line">end</span><br><span class="line">local redis = require &apos;resty.redis&apos;</span><br><span class="line">local redis_client = redis:new()</span><br><span class="line">-- 使用connect方法创建连接，该方法会先尝试从连接池中获取已有连接</span><br><span class="line">local ok, err = redis_client:connect(&apos;xxx.xxx.xxx.xxx&apos;, 6379)</span><br><span class="line">if not ok then</span><br><span class="line">	print(&quot;connect to redis error:&quot;, err)</span><br><span class="line">	ngx.say(cjson.encode(&#123;status = false, msg = &apos;internal error&apos;&#125;))</span><br><span class="line">	return</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 释放Redis连接</span><br><span class="line">function close_redis()</span><br><span class="line">	local pool_max_idle_time = 10000</span><br><span class="line">    local pool_size = 1024</span><br><span class="line">	if redis_client then</span><br><span class="line">		-- 使用set_keepalived方法将连接释放到连接池中，并可以指定连接池中连接的最长空闲时间和连接池中的连接数</span><br><span class="line">		redis_client:set_keepalive(pool_max_idle_time, pool_size)</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 释放MySQL连接</span><br><span class="line">function close_mysql()</span><br><span class="line">    local pool_max_idle_time = 10000</span><br><span class="line">    local pool_size = 5</span><br><span class="line">    if conn then</span><br><span class="line">    	-- 使用set_keepalived方法将连接释放到连接池中，并可以指定连接池中连接的最长空闲时间和连接池中的连接数</span><br><span class="line">		conn:set_keepalive(pool_max_idle_time, pool_size)</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function get(key)</span><br><span class="line">    -- 先尝试从Redis中根据key获取value	</span><br><span class="line">	local value = redis_client:get(key)</span><br><span class="line">	if not value or value == ngx.null then</span><br><span class="line">		-- 若Redis中不存在该key，则尝试从MySQL中根据key获取value</span><br><span class="line">		local rows = conn:query(&quot;select v from key_value where k=&apos;&quot; .. key .. &quot;&apos;&quot;)</span><br><span class="line">		if rows and rows[1] then</span><br><span class="line">			value = rows[1].v</span><br><span class="line">				if value and value ~= ngx.null then</span><br><span class="line">					-- 若MySQL中存在该key，则将该key和value添加到Redis中</span><br><span class="line">					redis_client:set(key, value)</span><br><span class="line">				end</span><br><span class="line">		end	</span><br><span class="line">	end</span><br><span class="line">	return value</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">local value = get(key)</span><br><span class="line">if not value or value == ngx.null then</span><br><span class="line">	ngx.say(cjson.encode(&#123;status = false, msg = &apos;no value&apos;&#125;))</span><br><span class="line">else</span><br><span class="line">	ngx.say(cjson.encode(&#123;status = true, msg = &apos;success&apos;, value = value&#125;))	</span><br><span class="line">end</span><br><span class="line">close_redis()</span><br><span class="line">close_mysql()</span><br></pre></td></tr></table></figure></p>
<p>配置nginx/conf/nginx.conf，对于地址为“/api/value”的请求使用value.lua处理：<br>[blockquote]server {<br>&nbsp;&nbsp;&nbsp;&nbsp;listen       8080;<br>&nbsp;&nbsp;&nbsp;&nbsp;server_name  localhost;<br>&nbsp;&nbsp;&nbsp;&nbsp;location /api/value {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;content_by_lua_file conf/value.lua;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;…<br>}[/blockquote]<br>启动Nginx，浏览器中访问“api/value?key=v1”，成功返回value：<br><a href="http://magicwt.com/wp-content/uploads/2015/04/1.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/04/1-300x92.png" alt="1"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/15/e4-bd-bf-e7-94-a8resin-e9-83-a8-e7-bd-b2web-service/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/04/15/e4-bd-bf-e7-94-a8resin-e9-83-a8-e7-bd-b2web-service/" itemprop="url">使用Resin部署Web Service</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-04-15T20:29:47+08:00">
                2015-04-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Resin是一款非常流行的Web Application服务器，可以部署servlet和JSP，同时，Resin也可以作为Web Service服务器。使用Resin部署Web Service的步骤如下。</p>
<h2 id="配置Resin"><a href="#配置Resin" class="headerlink" title="配置Resin"></a>配置Resin</h2><p>在Resin配置文件中添加以下语句使其支持Web Service：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;system-property javax.xml.stream.XMLInputFactory=&quot;com.sun.xml.internal.stream.XMLInputFactoryImpl&quot; /&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="配置web-xml"><a href="#配置web-xml" class="headerlink" title="配置web.xml"></a>配置web.xml</h2><p>配置servlet，对Http请求使用WSSpringServlet实例进行处理：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;servlet&gt;</span><br><span class="line">    &lt;servlet-name&gt;JAXWSServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;servlet-class&gt;com.sun.xml.ws.transport.http.servlet.WSSpringServlet&lt;/servlet-class&gt;</span><br><span class="line">    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-name&gt;JAXWSServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;</span><br><span class="line">&lt;/servlet-mapping&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="配置Spring上下文"><a href="#配置Spring上下文" class="headerlink" title="配置Spring上下文"></a>配置Spring上下文</h2><p>绑定URL和Web Service：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">       xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot;</span><br><span class="line">       xmlns:ws=&quot;http://jax-ws.dev.java.net/spring/core&quot;</span><br><span class="line">       xmlns:wss=&quot;http://jax-ws.dev.java.net/spring/servlet&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</span><br><span class="line">                           http://www.springframework.org/schema/beans/spring-beans-3.1.xsd</span><br><span class="line">                           http://www.springframework.org/schema/context</span><br><span class="line">                           http://www.springframework.org/schema/context/spring-context-3.1.xsd</span><br><span class="line">                           http://www.springframework.org/schema/mvc</span><br><span class="line">                           http://www.springframework.org/schema/mvc/spring-mvc-3.1.xsd</span><br><span class="line">                           http://jax-ws.dev.java.net/spring/core</span><br><span class="line">                           http://jax-ws.dev.java.net/spring/core.xsd</span><br><span class="line">                           http://jax-ws.dev.java.net/spring/servlet</span><br><span class="line">                           http://jax-ws.dev.java.net/spring/servlet.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.vshangping.server.webservice&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;wss:binding url=&quot;/testWebService&quot;&gt;</span><br><span class="line">        &lt;wss:service&gt;</span><br><span class="line">            &lt;ws:service bean=&quot;#testWebService&quot; /&gt;</span><br><span class="line">        &lt;/wss:service&gt;</span><br><span class="line">    &lt;/wss:binding&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="实现Web-Service"><a href="#实现Web-Service" class="headerlink" title="实现Web Service"></a>实现Web Service</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Service(&quot;testWebService&quot;)</span><br><span class="line">@WebService(targetNamespace = &quot;com.vshangping.server.webservice&quot;,  serviceName = &quot;TestWebService&quot;)</span><br><span class="line">public class TestWebService &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private MachineService machineService;</span><br><span class="line"></span><br><span class="line">    public Machine getMachine(Integer id) &#123;</span><br><span class="line">        return machineService.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译打包后部署到Resin中，访问/webservice/testWebService，如下所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/11/112.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/112-300x38.png" alt="1"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/12/e4-bd-bf-e7-94-a8mybatis-generator-e7-94-9f-e6-88-90-e4-bb-a3-e7-a0-81/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/04/12/e4-bd-bf-e7-94-a8mybatis-generator-e7-94-9f-e6-88-90-e4-bb-a3-e7-a0-81/" itemprop="url">使用MyBatis Generator逆向生成数据库读写代码</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-04-12T23:46:32+08:00">
                2015-04-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>MyBatis（前身是iBATIS）是一个基于Java的持久层框架，而MyBatis Generator (MBG，<a href="http://www.mybatis.org/generator/)是一个根据数据库表结构为MyBatis和iBATIS逆向生成相关Java代码和配置文件的工具。" target="_blank" rel="noopener">http://www.mybatis.org/generator/)是一个根据数据库表结构为MyBatis和iBATIS逆向生成相关Java代码和配置文件的工具。</a><br>MBG可以生成：<br>1）Java POJO，与数据库表结构对应；<br>2）MyBatis和iBATIS规范的SQL映射配置文件，每个配置文件包含对一个表实现简单CRUD操作的SQL语句；<br>3）MyBatis和iBATIS规范的Java客户端接口，提供对数据的增、删、查、改方法。</p>
<h2 id="示例数据库"><a href="#示例数据库" class="headerlink" title="示例数据库"></a>示例数据库</h2><p><a href="http://magicwt.com/wp-content/uploads/2015/04/数据库表模型.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/04/数据库表模型.png" alt="数据库表模型"></a><br>示例数据库包含3张表：<br>1）课程表（course），存储课程名称、学分信息，主键为自增整数；<br>2）学生表（student），存储学生姓名、性别、年龄等信息，主键为自增整数；<br>3）得分表（score），存储某位学生某门课程的分数，使用课程id和学生id作为联合主键。</p>
<h2 id="使用MBG逆向生成代码"><a href="#使用MBG逆向生成代码" class="headerlink" title="使用MBG逆向生成代码"></a>使用MBG逆向生成代码</h2><p>使用MBG生成代码时，需要指定配置文件（generatorConfig.xml），如下所示，其中指定了数据库连接方式，Java POJO、SQL映射配置文件、Java客户端接口的生成方式和生成路径等：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE generatorConfiguration</span><br><span class="line">        PUBLIC &quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;</span><br><span class="line">        &quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;generatorConfiguration&gt;</span><br><span class="line">	&lt;classPathEntry location=&quot;/Users/tao/develop/mysql-connector-java-5.1.12.jar&quot; /&gt;</span><br><span class="line">	&lt;context id=&quot;test&quot; targetRuntime=&quot;MyBatis3&quot;&gt;</span><br><span class="line">		&lt;commentGenerator&gt;</span><br><span class="line">			&lt;property name=&quot;suppressAllComments&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">		&lt;/commentGenerator&gt;</span><br><span class="line">		&lt;jdbcConnection driverClass=&quot;com.mysql.jdbc.Driver&quot; connectionURL=&quot;jdbc:mysql://xxx.xxx.xxx.xxx:3306/test&quot; userId=&quot;xxx&quot; password=&quot;xxx&quot;&gt;</span><br><span class="line">		&lt;/jdbcConnection&gt;</span><br><span class="line">		&lt;javaTypeResolver&gt;</span><br><span class="line">			&lt;property name=&quot;forceBigDecimals&quot; value=&quot;false&quot; /&gt;</span><br><span class="line">		&lt;/javaTypeResolver&gt;</span><br><span class="line">		&lt;javaModelGenerator targetPackage=&quot;com.magicwt.bean&quot; targetProject=&quot;/Users/tao/develop/test/src&quot;&gt;</span><br><span class="line">			&lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot; /&gt;</span><br><span class="line">			&lt;property name=&quot;trimStrings&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">		&lt;/javaModelGenerator&gt;</span><br><span class="line">		&lt;sqlMapGenerator targetPackage=&quot;com.magicwt.mapper&quot; targetProject=&quot;/Users/tao/develop/test/src&quot;&gt;</span><br><span class="line">			&lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot; /&gt;</span><br><span class="line">		&lt;/sqlMapGenerator&gt;</span><br><span class="line">		&lt;javaClientGenerator type=&quot;XMLMAPPER&quot; targetPackage=&quot;com.magicwt.dao&quot; targetProject=&quot;/Users/tao/develop/test/src&quot;&gt;</span><br><span class="line">			&lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot; /&gt;</span><br><span class="line">		&lt;/javaClientGenerator&gt;</span><br><span class="line">		&lt;table tableName=&quot;%&quot; enableCountByExample=&quot;false&quot; enableUpdateByExample=&quot;false&quot; enableDeleteByExample=&quot;false&quot; enableSelectByExample=&quot;false&quot; selectByExampleQueryId=&quot;false&quot;&gt;&lt;/table&gt;	</span><br><span class="line">	&lt;/context&gt;</span><br><span class="line">&lt;/generatorConfiguration&gt;</span><br></pre></td></tr></table></figure></p>
<p>指定配置文件后，MBG支持以下4种生成代码方式：<br>1）使用命令行生成代码；<br>2）作为Ant任务生成代码；<br>3）作为Maven插件生成代码；<br>4）使用Java接口编程生成代码。<br>这里使用命令行方式，从<a href="https://github.com/mybatis/generator/releases下载jar包，命令行下执行jar包：" target="_blank" rel="noopener">https://github.com/mybatis/generator/releases下载jar包，命令行下执行jar包：</a><br>[blockquote]java -jar mybatis-generator-core-1.3.2.jar -configfile generatorConfig.xml[/blockquote]<br>执行成功后，便会生成如下代码：<br>1）Java POJO：Course.java，Student.java，ScoreKey.java，Score.java，其中Course.java对应于course表，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package com.magicwt.bean;</span><br><span class="line"></span><br><span class="line">public class Course &#123;</span><br><span class="line">    private Integer id;</span><br><span class="line"></span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    private Byte credit;</span><br><span class="line"></span><br><span class="line">    public Integer getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId(Integer id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name = name == null ? null : name.trim();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Byte getCredit() &#123;</span><br><span class="line">        return credit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCredit(Byte credit) &#123;</span><br><span class="line">        this.credit = credit;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2）SQL映射配置文件：CourseMapper.xml，StudentMapper.xml，ScoreMapper.xml，其中CourseMapper.xml包含对course表实现CRUD操作的SQL语句，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;</span><br><span class="line">&lt;mapper namespace=&quot;com.magicwt.dao.CourseMapper&quot; &gt;</span><br><span class="line">  &lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;com.magicwt.bean.Course&quot; &gt;</span><br><span class="line">    &lt;id column=&quot;id&quot; property=&quot;id&quot; jdbcType=&quot;INTEGER&quot; /&gt;</span><br><span class="line">    &lt;result column=&quot;name&quot; property=&quot;name&quot; jdbcType=&quot;VARCHAR&quot; /&gt;</span><br><span class="line">    &lt;result column=&quot;credit&quot; property=&quot;credit&quot; jdbcType=&quot;TINYINT&quot; /&gt;</span><br><span class="line">  &lt;/resultMap&gt;</span><br><span class="line">  &lt;sql id=&quot;Base_Column_List&quot; &gt;</span><br><span class="line">    id, name, credit</span><br><span class="line">  &lt;/sql&gt;</span><br><span class="line">  &lt;select id=&quot;selectByPrimaryKey&quot; resultMap=&quot;BaseResultMap&quot; parameterType=&quot;java.lang.Integer&quot; &gt;</span><br><span class="line">    select </span><br><span class="line">    &lt;include refid=&quot;Base_Column_List&quot; /&gt;</span><br><span class="line">    from course</span><br><span class="line">    where id = #&#123;id,jdbcType=INTEGER&#125;</span><br><span class="line">  &lt;/select&gt;</span><br><span class="line">  &lt;delete id=&quot;deleteByPrimaryKey&quot; parameterType=&quot;java.lang.Integer&quot; &gt;</span><br><span class="line">    delete from course</span><br><span class="line">    where id = #&#123;id,jdbcType=INTEGER&#125;</span><br><span class="line">  &lt;/delete&gt;</span><br><span class="line">  &lt;insert id=&quot;insert&quot; parameterType=&quot;com.magicwt.bean.Course&quot; &gt;</span><br><span class="line">    insert into course (id, name, credit</span><br><span class="line">      )</span><br><span class="line">    values (#&#123;id,jdbcType=INTEGER&#125;, #&#123;name,jdbcType=VARCHAR&#125;, #&#123;credit,jdbcType=TINYINT&#125;</span><br><span class="line">      )</span><br><span class="line">  &lt;/insert&gt;</span><br><span class="line">  &lt;insert id=&quot;insertSelective&quot; parameterType=&quot;com.magicwt.bean.Course&quot; &gt;</span><br><span class="line">    insert into course</span><br><span class="line">    &lt;trim prefix=&quot;(&quot; suffix=&quot;)&quot; suffixOverrides=&quot;,&quot; &gt;</span><br><span class="line">      &lt;if test=&quot;id != null&quot; &gt;</span><br><span class="line">        id,</span><br><span class="line">      &lt;/if&gt;</span><br><span class="line">      &lt;if test=&quot;name != null&quot; &gt;</span><br><span class="line">        name,</span><br><span class="line">      &lt;/if&gt;</span><br><span class="line">      &lt;if test=&quot;credit != null&quot; &gt;</span><br><span class="line">        credit,</span><br><span class="line">      &lt;/if&gt;</span><br><span class="line">    &lt;/trim&gt;</span><br><span class="line">    &lt;trim prefix=&quot;values (&quot; suffix=&quot;)&quot; suffixOverrides=&quot;,&quot; &gt;</span><br><span class="line">      &lt;if test=&quot;id != null&quot; &gt;</span><br><span class="line">        #&#123;id,jdbcType=INTEGER&#125;,</span><br><span class="line">      &lt;/if&gt;</span><br><span class="line">      &lt;if test=&quot;name != null&quot; &gt;</span><br><span class="line">        #&#123;name,jdbcType=VARCHAR&#125;,</span><br><span class="line">      &lt;/if&gt;</span><br><span class="line">      &lt;if test=&quot;credit != null&quot; &gt;</span><br><span class="line">        #&#123;credit,jdbcType=TINYINT&#125;,</span><br><span class="line">      &lt;/if&gt;</span><br><span class="line">    &lt;/trim&gt;</span><br><span class="line">  &lt;/insert&gt;</span><br><span class="line">  &lt;update id=&quot;updateByPrimaryKeySelective&quot; parameterType=&quot;com.magicwt.bean.Course&quot; &gt;</span><br><span class="line">    update course</span><br><span class="line">    &lt;set &gt;</span><br><span class="line">      &lt;if test=&quot;name != null&quot; &gt;</span><br><span class="line">        name = #&#123;name,jdbcType=VARCHAR&#125;,</span><br><span class="line">      &lt;/if&gt;</span><br><span class="line">      &lt;if test=&quot;credit != null&quot; &gt;</span><br><span class="line">        credit = #&#123;credit,jdbcType=TINYINT&#125;,</span><br><span class="line">      &lt;/if&gt;</span><br><span class="line">    &lt;/set&gt;</span><br><span class="line">    where id = #&#123;id,jdbcType=INTEGER&#125;</span><br><span class="line">  &lt;/update&gt;</span><br><span class="line">  &lt;update id=&quot;updateByPrimaryKey&quot; parameterType=&quot;com.magicwt.bean.Course&quot; &gt;</span><br><span class="line">    update course</span><br><span class="line">    set name = #&#123;name,jdbcType=VARCHAR&#125;,</span><br><span class="line">      credit = #&#123;credit,jdbcType=TINYINT&#125;</span><br><span class="line">    where id = #&#123;id,jdbcType=INTEGER&#125;</span><br><span class="line">  &lt;/update&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure></p>
<p>3）Java客户端接口，CourseMapper.java，StudentMapper.java，ScoreMapper.java，其中CourseMapper.java提供对Course对象的增、删、查、改方法，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package com.magicwt.dao;</span><br><span class="line"></span><br><span class="line">import com.magicwt.bean.Course;</span><br><span class="line"></span><br><span class="line">public interface CourseMapper &#123;</span><br><span class="line">    int deleteByPrimaryKey(Integer id);</span><br><span class="line"></span><br><span class="line">    int insert(Course record);</span><br><span class="line"></span><br><span class="line">    int insertSelective(Course record);</span><br><span class="line"></span><br><span class="line">    Course selectByPrimaryKey(Integer id);</span><br><span class="line"></span><br><span class="line">    int updateByPrimaryKeySelective(Course record);</span><br><span class="line"></span><br><span class="line">    int updateByPrimaryKey(Course record);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="使用所生成代码读写数据库"><a href="#使用所生成代码读写数据库" class="headerlink" title="使用所生成代码读写数据库"></a>使用所生成代码读写数据库</h2><p>示例工程使用Maven构建，并使用Spring管理上下文，代码目录如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/04/04D80B70-DB28-4373-AADD-5D0150179FB8.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/04/04D80B70-DB28-4373-AADD-5D0150179FB8-155x300.png" alt="04D80B70-DB28-4373-AADD-5D0150179FB8"></a><br>除MBG生成的代码和配置文件外，还需要context.xml和configuration.xml分别配置Spring和MyBatis，context.xml和configuration.xml如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;</span><br><span class="line">    http://www.springframework.org/schema/beans</span><br><span class="line">    http://www.springframework.org/schema/beans/spring-beans-3.2.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 配置数据库连接池 --&gt;</span><br><span class="line">    &lt;bean id=&quot;dataSource&quot; class=&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;driverClass&quot; value=&quot;com.mysql.jdbc.Driver&quot; /&gt;</span><br><span class="line">        &lt;property name=&quot;jdbcUrl&quot; value=&quot;jdbc:mysql://123.57.154.17:3306/test?characterEncoding=UTF-8&amp;autoReconnect=true&quot; /&gt;</span><br><span class="line">        &lt;property name=&quot;user&quot; value=&quot;server_test&quot; /&gt;</span><br><span class="line">        &lt;property name=&quot;password&quot; value=&quot;4abE9r4Imx12&quot; /&gt;</span><br><span class="line">        &lt;property name=&quot;initialPoolSize&quot; value=&quot;1&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 配置会话工厂 --&gt;</span><br><span class="line">    &lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;</span><br><span class="line">        &lt;property name=&quot;configLocation&quot; value=&quot;classpath:configuration.xml&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;courseDao&quot; class=&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot; /&gt;</span><br><span class="line">        &lt;property name=&quot;mapperInterface&quot; value=&quot;com.magicwt.dao.CourseMapper&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;studentDao&quot; class=&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot; /&gt;</span><br><span class="line">        &lt;property name=&quot;mapperInterface&quot; value=&quot;com.magicwt.dao.StudentMapper&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;scoreDao&quot; class=&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot; /&gt;</span><br><span class="line">        &lt;property name=&quot;mapperInterface&quot; value=&quot;com.magicwt.dao.ScoreMapper&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span><br><span class="line">        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line"></span><br><span class="line">    &lt;typeAliases&gt;</span><br><span class="line">        &lt;typeAlias alias=&quot;Course&quot; type=&quot;com.magicwt.bean.Course&quot;/&gt;</span><br><span class="line">        &lt;typeAlias alias=&quot;Student&quot; type=&quot;com.magicwt.bean.Student&quot;/&gt;</span><br><span class="line">        &lt;typeAlias alias=&quot;Score&quot; type=&quot;com.magicwt.bean.Score&quot;/&gt;</span><br><span class="line">    &lt;/typeAliases&gt;</span><br><span class="line"></span><br><span class="line">    &lt;mappers&gt;</span><br><span class="line">        &lt;mapper resource=&quot;com/magicwt/mapper/CourseMapper.xml&quot;/&gt;</span><br><span class="line">        &lt;mapper resource=&quot;com/magicwt/mapper/StudentMapper.xml&quot;/&gt;</span><br><span class="line">        &lt;mapper resource=&quot;com/magicwt/mapper/ScoreMapper.xml&quot;/&gt;</span><br><span class="line">    &lt;/mappers&gt;</span><br><span class="line"></span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<p>编写测试类对course表执行插入操作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class DaoTest &#123;</span><br><span class="line"></span><br><span class="line">    private ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    @Before</span><br><span class="line">    public void prepare() &#123;</span><br><span class="line">        context = new ClassPathXmlApplicationContext(new String[] &#123;&quot;context.xml&quot;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void test() &#123;</span><br><span class="line">        CourseMapper courseDao = (CourseMapper) context.getBean(&quot;courseDao&quot;);</span><br><span class="line">        Course course = new Course();</span><br><span class="line">        course.setName(&quot;微积分&quot;);</span><br><span class="line">        course.setCredit(new Byte(&quot;4&quot;));</span><br><span class="line">        courseDao.insert(course);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行后，在course表中成功插入一条记录：<br><a href="http://magicwt.com/wp-content/uploads/2015/04/C6987E31-E4AA-4E30-85B0-74E0D4A80569.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/04/C6987E31-E4AA-4E30-85B0-74E0D4A80569-300x35.png" alt="C6987E31-E4AA-4E30-85B0-74E0D4A80569"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/03/13/283-move-zeroes/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/03/13/283-move-zeroes/" itemprop="url">Move Zeroes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-03-13T10:18:55+08:00">
                2015-03-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据结构与算法/" itemprop="url" rel="index">
                    <span itemprop="name">数据结构与算法</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>Given an array nums, write a function to move all 0’s to the end of it while maintaining the relative order of the non-zero elements.<br>For example, given nums = [0, 1, 0, 3, 12], after calling your function, nums should be [1, 3, 12, 0, 0].<br>Note:<br>1.You must do this in-place without making a copy of the array.<br>2.Minimize the total number of operations</p>
</blockquote>
<p>给定一个数组，把所有0移到数组末尾，同时保证非0数的相对顺序不变。不能使用额外的空间，且保证操作次数最小。 比如，数组[0,1,0,3,12]，处理后得到的结果应该为[1,3,12,0,0]。<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2015/03/13/283-move-zeroes/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </p></div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/02/16/kafka-e7-ae-80-e4-bb-8b/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/16/kafka-e7-ae-80-e4-bb-8b/" itemprop="url">Kafka简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-02-16T11:37:25+08:00">
                2015-02-16
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>节选自Kafka官方文档（<a href="http://kafka.apache.org/documentation.html）" target="_blank" rel="noopener">http://kafka.apache.org/documentation.html）</a></p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Kafka是一个分布式、分区消息服务，基本概念包括：<br>1）topic，消息流；<br>2）producer，向topic发布消息；<br>3）consumer，订阅topic，接收、处理消息；<br>4）broker，Kafka集群由多个broker组成。<br><a href="http://magicwt.com/wp-content/uploads/2015/02/producer_consumer.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/02/producer_consumer.png" alt="producer_consumer"></a></p>
<h3 id="Topic"><a href="#Topic" class="headerlink" title="Topic"></a>Topic</h3><p>topic包含多个分区，如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/02/log_anatomy.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/02/log_anatomy-300x193.png" alt="log_anatomy"></a><br>每个分区是一个有序的消息队列，消息按照从旧到新的顺序排列，新的消息不断追加到尾部。每个消息使用递增的id（offset）来唯一标识。<br>消息在Kafka中会被保存一段时间，而不管它是否被消费，这个保存时间可以设置。如果保存时间设置为2天，那么在2天内，消息都可以被消费，2天后消息将被删除。<br>每个消费者需要保存当前所消费消息在分区中的位置（offset）。通常情况下，消费者在消费消息时递增offset表示消息已被消费。另外，消费者也可以灵活地设置offset，例如，设置到较旧的offset，重复消费已消费过的消息。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/11/21/infobright-e7-ae-80-e4-bb-8b-e4-b8-8e-e5-ae-9e-e8-b7-b5/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/11/21/infobright-e7-ae-80-e4-bb-8b-e4-b8-8e-e5-ae-9e-e8-b7-b5/" itemprop="url">Infobright简介与实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-11-21T14:46:45+08:00">
                2014-11-21
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/关系数据库/" itemprop="url" rel="index">
                    <span itemprop="name">关系数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>infobright（<a href="https://www.infobright.org/）是一款基于MySQL的数据仓库，它采用列式存储，压缩比高，查询速度快。" target="_blank" rel="noopener">https://www.infobright.org/）是一款基于MySQL的数据仓库，它采用列式存储，压缩比高，查询速度快。</a><br>infobright提供社区（ICE）和商业(IEE)两个版本，ICE版本不支持DML，无法执行insert、update、delete和alter操作。<br>在工作中，我们每天会通过hadoop统计出前一天全站每个页面的PV和UV，约有数几千万条记录。我们使用infobright来存储这些数据并提供快速查询。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>在Linux 64位系统中，下载infobright-4.0.7-0-x86_64-ice.rpm，执行以下语句进行安装：<br>[blockquote]rpm -ivh infobright-4.0.7-0-x86_64-ice.rpm[/blockquote]<br>infobright默认安装在/usr/local/infobright-4.0.7-x86_64，执行该目录下的postconfig.sh可以修改相关配置，默认配置如下所示：<br>[blockquote]Current config file: [/etc/my-ib.cnf]<br>Current brighthouse.ini file: [/usr/local/infobright-4.0.7-x86_64/data/brighthouse.ini]<br>Current datadir: [/usr/local/infobright-4.0.7-x86_64/data]<br>Current CacheFolder in brighthouse.ini file: [/usr/local/infobright-4.0.7-x86_64/cache]<br>Current socket: [/tmp/mysql-ib.sock]<br>Current port: [5029][/blockquote]<br>修改相关配置后，执行以下语句启动服务：<br>[blockquote]/usr/local/infobright-4.0.7-x86_64/bin/mysqld_safe &amp;[/blockquote]</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">create table if not exists  url_stat_20141117 (  </span><br><span class="line">    refer_type int ,</span><br><span class="line">    id int ,  </span><br><span class="line">    id_type int ,</span><br><span class="line">    url_type int , </span><br><span class="line">    url text ,     </span><br><span class="line">    uv int ,  </span><br><span class="line">    pv int  </span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><a href="http://magicwt.com/wp-content/uploads/2014/12/1.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2014/12/1-300x76.png" alt="1"></a><br>infobright的存储引擎为BRIGHTHOUSE。</p>
<h3 id="装载数据"><a href="#装载数据" class="headerlink" title="装载数据"></a>装载数据</h3><p>hadoop统计前一天全站每个页面的PV和UV，统计结果存储在文件中，每行包含7列，每列使用“\t”分隔，并且与表字段一一对应。<br><a href="http://magicwt.com/wp-content/uploads/2014/12/11.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2014/12/11-300x10.png" alt="1"></a><br><a href="http://magicwt.com/wp-content/uploads/2014/12/12.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2014/12/12-300x22.png" alt="1"></a><br>原始文件大小一般接近10G，使用以下语句加载数据至infobright：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">load data infile &apos;/opt/data/url_stat_20141117.txt&apos;  into table url_stat_20141117 fields terminated by &apos;\t&apos; enclosed by &apos;NULL&apos;  lines terminated by &apos;\n&apos;;</span><br></pre></td></tr></table></figure></p>
<p>对于表url_stat_20141117，infobright在data目录下使用文件url_stat_20141117.frm保存schema信息，使用目录url_stat_20141117.bht保存数据。装载数据后，url_stat_20141117.bht中的文件总大小约为1.3G，与原始文件相比，压缩比接近10:1。表中记录约有7000多万条。<br><a href="http://magicwt.com/wp-content/uploads/2014/11/1.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2014/11/1-300x280.png" alt="1"></a><br><a href="http://magicwt.com/wp-content/uploads/2014/12/14.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2014/12/14-300x83.png" alt="1"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">magicwt</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">90</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">49</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/magicwt" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:wang-t04@mails.tsinghua.edu.cn" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">magicwt</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
