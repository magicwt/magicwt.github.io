<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="magicwt的博客">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="magicwt的博客">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="magicwt的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/6/">





  <title>magicwt的博客</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">magicwt的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2013/09/11/swfupload-e6-96-87-e4-bb-b6-e4-b8-8a-e4-bc-a0-e6-97-b6-e4-bb-8e-e5-90-8e-e5-8f-b0-e8-bf-94-e5-9b-9e-e4-b8-ad-e6-96-87-e4-b9-b1-e7-a0-81-e7-9a-84-e9-97-ae-e9-a2-98/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/09/11/swfupload-e6-96-87-e4-bb-b6-e4-b8-8a-e4-bc-a0-e6-97-b6-e4-bb-8e-e5-90-8e-e5-8f-b0-e8-bf-94-e5-9b-9e-e4-b8-ad-e6-96-87-e4-b9-b1-e7-a0-81-e7-9a-84-e9-97-ae-e9-a2-98/" itemprop="url">SWFUpload文件上传时从后台返回中文乱码的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-09-11T11:52:58+08:00">
                2013-09-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>SWFUpload是一款使用Flash和Javascript开发的文件上传工具，最近在使用其实现文件上传功能时，发现从后台返回的中文经常乱码。<br>SWFUpload上传成功后，对后台返回结果的处理方法是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">function uploadSuccess(file, serverData) &#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中file是上传文件信息，serverData是从后台返回的数据。我们发现serverData中的中文出现乱码。而后台处理图片上传的Struts2 Action类返回时的代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">servletResponse.getOutputStream().println(serverData);</span><br></pre></td></tr></table></figure></p>
<p>后来发现就是上面这个地方出了问题。之前使用的是ServletOutputStream字节流的println方法，这个方法会将serverData字符串按照默认编码转化为字节流，而SWFUpload使用的是UTF-8编码，从而导致编码不一致，引起中文乱码。<br>后来想了两个解决方法：<br>1）对于字节流，手工对serverData按照UTF-8进行编码，并采用write方法输出字节流；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">servletResponse.getOutputStream().write(serverData.getBytes(&quot;UTF-8&quot;));</span><br></pre></td></tr></table></figure></p>
<p>2）采用字符流，并指定字符流的编码为UTF-8。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">servletResponse.setCharacterEncoding(&quot;UTF-8&quot;);</span><br><span class="line">servletResponse.getWriter().print(serverData);</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2013/09/07/spring-struts2-hessian-e9-9b-86-e6-88-90-e7-9a-84-e4-b8-80-e4-b8-aa-e9-97-ae-e9-a2-98/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/09/07/spring-struts2-hessian-e9-9b-86-e6-88-90-e7-9a-84-e4-b8-80-e4-b8-aa-e9-97-ae-e9-a2-98/" itemprop="url">Spring Struts2 Hessian集成的一个问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-09-07T11:28:25+08:00">
                2013-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在做系统改造的时候，还遇到了一个问题是，如何集成Spring Struts2和Hessian。</p>
<p>当配置Spring和Struts2的时候，在web.xml做了如下配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;context-param&gt;</span><br><span class="line">   &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br><span class="line">   &lt;param-value&gt;classpath:/spring/*.xml&lt;/param-value&gt;</span><br><span class="line">&lt;/context-param&gt;</span><br><span class="line">	&lt;listener&gt;</span><br><span class="line">  	&lt;listener-class&gt;</span><br><span class="line">    org.springframework.web.context.ContextLoaderListener</span><br><span class="line">  &lt;/listener-class&gt;</span><br><span class="line">&lt;/listener&gt;</span><br></pre></td></tr></table></figure></p>
<p>通过设置listener加载Spring的上下文环境，并在struts.xml中设置对象工厂为Spring:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;constant name=&quot;struts.objectFactory&quot; value=&quot;spring&quot; /&gt;</span><br></pre></td></tr></table></figure></p>
<p>这样，Struts2就可以使用Spring上下文环境中的action bean了。</p>
<p>但在配置Hessian的时候，以前在web.xml中是这样配置的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;servlet&gt;</span><br><span class="line">  &lt;servlet-name&gt;Remoting&lt;/servlet-name&gt;</span><br><span class="line">  &lt;servlet-class&gt;</span><br><span class="line">    org.springframework.web.servlet.DispatcherServlet</span><br><span class="line">  &lt;/servlet-class&gt;</span><br><span class="line">  &lt;init-param&gt;</span><br><span class="line">    &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br><span class="line">    &lt;param-value&gt;classpath:/spring/*.xml&lt;/param-value&gt;</span><br><span class="line">  &lt;/init-param&gt;</span><br><span class="line">  &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">   &lt;servlet-name&gt;Remoting&lt;/servlet-name&gt;</span><br><span class="line">   &lt;url-pattern&gt;/remoting/*&lt;/url-pattern&gt;</span><br><span class="line">&lt;/servlet-mapping&gt;</span><br></pre></td></tr></table></figure></p>
<p>在初始化Hessian的servlet的时候又一次把Spring配置文件作为参数，这样又会重新生成一个Spring上下文环境，导致Spring中bean的重复。</p>
<p>为了解决这个问题，在配置Hessian时，做了一下修改，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;servlet&gt;</span><br><span class="line">   &lt;servlet-name&gt;Remoting&lt;/servlet-name&gt;</span><br><span class="line">   &lt;servlet-class&gt;</span><br><span class="line">     org.springframework.web.servlet.DispatcherServlet</span><br><span class="line">   &lt;/servlet-class&gt;</span><br><span class="line">   &lt;init-param&gt;</span><br><span class="line">      &lt;!-- &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br><span class="line">      &lt;param-value&gt;classpath:/spring/*.xml&lt;/param-value&gt; --&gt;</span><br><span class="line">      &lt;!-- 该servlet的spring上下文采用WebApplicationContext，不再重复生成上下文 --&gt;</span><br><span class="line">      &lt;param-name&gt;contextAttribute&lt;/param-name&gt;</span><br><span class="line">      &lt;param-value&gt;</span><br><span class="line">        org.springframework.web.context.WebApplicationContext.ROOT</span><br><span class="line">      &lt;/param-value&gt;</span><br><span class="line">   &lt;/init-param&gt;</span><br><span class="line">   &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br></pre></td></tr></table></figure></p>
<p>即在初始化Hessian时不再传入Spring配置文件，而是传入通过listener初始化的Spring WebApplicationContext上下文环境，即使用同一个上下文环境。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2013/09/05/e6-9c-ac-e5-9c-b0jar-e5-8c-85-e6-b7-bb-e5-8a-a0-e5-88-b0maven-e4-be-9d-e8-b5-96-e4-b8-ad/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/09/05/e6-9c-ac-e5-9c-b0jar-e5-8c-85-e6-b7-bb-e5-8a-a0-e5-88-b0maven-e4-be-9d-e8-b5-96-e4-b8-ad/" itemprop="url">本地jar包添加到maven依赖中</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-09-05T23:40:22+08:00">
                2013-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>对于本地jar包，如果要添加到maven依赖中，可以使用如下方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;groupId&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;artifactId&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;version&lt;/version&gt;</span><br><span class="line">    &lt;scope&gt;system&lt;/scope&gt;</span><br><span class="line">    &lt;systemPath&gt;本地jar包路径&lt;/systemPath&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
<p>指定scope为system，maven会直接使用systemPath指定路径下的jar包。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2013/08/22/ssh-e9-94-99-e8-af-af-e8-a7-a3-e5-86-b3/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/08/22/ssh-e9-94-99-e8-af-af-e8-a7-a3-e5-86-b3/" itemprop="url">SSH错误解决</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-08-22T11:43:39+08:00">
                2013-08-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天在修改系统的一个Action类时（系统架构是struts2+spring+hibernate），报了以下错误：<br>JSONWriter can not access a member of class org.springframework.aop.TruePointcut with modifiers “public”<br>后来发现是由于我在该Action类中新增加了一个对象属性，并添加了get和set方法，通过spring注入，但由于该Action类使用了struts2支持的json格式字符串返回，会将我新增加的这个对象属性也添加到返回的json字符串，导致struts2报错，该错误的解决方法有2个：<br>1）在新增对象属性的get方法上添加标注“@JSON(serialize=false)”；<br>2）去掉新增对象属性的get方法；<br>这样，在返回json格式字符串时，不会再添加这个对象属性，也就不会再报错了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2013/08/10/e5-bc-80-e6-ba-90-e5-8e-8b-e5-8a-9b-e6-b5-8b-e8-af-95-e5-b7-a5-e5-85-b7jmeter-e4-bd-bf-e7-94-a8-e4-bb-8b-e7-bb-8d/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/08/10/e5-bc-80-e6-ba-90-e5-8e-8b-e5-8a-9b-e6-b5-8b-e8-af-95-e5-b7-a5-e5-85-b7jmeter-e4-bd-bf-e7-94-a8-e4-bb-8b-e7-bb-8d/" itemprop="url">开源压力测试工具JMeter使用介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-08-10T12:11:11+08:00">
                2013-08-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近需要对改造的redis缓存接口做压力测试，使用了开源压力测试工具JMeter，分享一下自己的使用经验，希望能对需要进行压力测试的开发同学有所帮助。<br><strong>JMeter介绍</strong><br>JMeter是Apache软件基金会下的一款开源压力测试工具，官方网址是：<a href="http://jmeter.apache.org/。JMeter可以测试静态、动态资源的性能，这些资源包括文件、Servlets" target="_blank" rel="noopener">http://jmeter.apache.org/。JMeter可以测试静态、动态资源的性能，这些资源包括文件、Servlets</a> 、Perl脚本、Java对象、数据库、FTP服务器等，并生成图形报告。JMeter使用Java开发，既支持可视化界面操作，也支持命令行操作。<br><strong>Java请求测试（界面操作）</strong><br>由于需要对改造的redis缓存接口测试，因此使用了JMeter的Java请求测试，安装和使用步骤如下所示（以Windows操作系统为例，并默认已安装、配置Java运行环境）。<br>1）从官网上下载JMeter并解压，例如解压至C:\apache-jmeter-2.9。<br>2）配置JMeter环境变量，增加变量JMETER_HOME，值为“C:\apache-jmeter-2.9”，修改变量CLASSPATH，增加“%JMETER_HOME%\lib\ext\ApacheJMeter_core.jar;% JMETER_HOME%\lib\jorphan.jar;%JMETER_HOME%\lib\logkit-1.2.jar;”</p>
<p>3）执行JMeter目录下的bin\jmeter.bat，显示JMeter界面说明安装成功。<br><a href="http://magicwt.com/wp-content/uploads/2015/11/120114940.gif" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/120114940-300x169.gif" alt="120114940"></a><br>4）新建Java工程，在该工程中，引入JMeter目录下lib中的jar包，继承JMeter的AbstractJavaSamplerClient类，在子类中重写setupTest、teardownTest、getDefaultParameters、runTest方法，实现对缓存接口的get、set、hGet、hSet方法进行测试，子类代码如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package com.sohu.cms.test;</span><br><span class="line">import org.apache.jmeter.config.Arguments; </span><br><span class="line">import org.apache.jmeter.protocol.java.sampler.AbstractJavaSamplerClient; </span><br><span class="line">import org.apache.jmeter.protocol.java.sampler.JavaSamplerContext; </span><br><span class="line">import org.apache.jmeter.samplers.SampleResult; </span><br><span class="line">import org.springframework.context.ApplicationContext;</span><br><span class="line">import org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line">import com.sohu.cms.datacache.DataCache;</span><br><span class="line">import com.sohu.cms.datacache.DataCacheManager;</span><br><span class="line">/**</span><br><span class="line"> * 继承jmeter的AbstractJavaSamplerClient类，</span><br><span class="line"> * 重写setupTest、teardownTest、getDefaultParameters、runTest方法</span><br><span class="line"> * 对缓存接口的get、set、hGet、hSet方法进行测试</span><br><span class="line"> * @author wang</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class TestDataCacheClient extends AbstractJavaSamplerClient&#123;</span><br><span class="line">    private static long start = 0; </span><br><span class="line">    private static long end = 0; </span><br><span class="line"></span><br><span class="line">    private static DataCacheManager dataCacheManager;</span><br><span class="line">    private static DataCache dataCache;</span><br><span class="line">    private static int size = 8192;</span><br><span class="line">    private static String method = &quot;get&quot;;</span><br><span class="line">    private static Object key = &quot;TEST_KEY&quot;;</span><br><span class="line">    private static Object field = &quot;TEST_FIELD&quot;;</span><br><span class="line">    private static Object value = new Byte[size];</span><br><span class="line"></span><br><span class="line">    //此处初始化我们改造的redis缓存接口dataCache</span><br><span class="line">    static &#123;</span><br><span class="line">        ApplicationContext context = new ClassPathXmlApplicationContext(new String[]&#123;&quot;applicationContext.xml&quot;&#125;);</span><br><span class="line">        dataCacheManager = (DataCacheManager) context.getBean(&quot;dataCacheManager&quot;);</span><br><span class="line">        dataCache = dataCacheManager.getObjectDataCache(); </span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 测试开始</span><br><span class="line">     */ </span><br><span class="line">    public void setupTest(JavaSamplerContext arg0) &#123;       </span><br><span class="line">        start = System.currentTimeMillis(); </span><br><span class="line">    &#125; </span><br><span class="line">    /**</span><br><span class="line">     * 测试结束</span><br><span class="line">     */ </span><br><span class="line">    public void teardownTest(JavaSamplerContext arg0) &#123;</span><br><span class="line">        end = System.currentTimeMillis(); </span><br><span class="line">        System.out.println(&quot;[method=&quot; + method + &quot;] [size=&quot; + size + &quot;] [time:&quot; + (end - start) / 1000); </span><br><span class="line">    &#125; </span><br><span class="line">    /**</span><br><span class="line">     * 添加参数默认值，参数默认值会在界面中显示</span><br><span class="line">     */</span><br><span class="line">    public Arguments getDefaultParameters() &#123;</span><br><span class="line">        //添加两个参数，</span><br><span class="line">        //size为测试value值的字节大小，默认为8192字节</span><br><span class="line">        //method为需要进行测试的缓存接口方法，默认为get</span><br><span class="line">        Arguments args = new Arguments();</span><br><span class="line">        args.addArgument(&quot;size&quot;, &quot;8192&quot;);</span><br><span class="line">        args.addArgument(&quot;method&quot;,&quot;get&quot;);</span><br><span class="line">        return args; </span><br><span class="line">    &#125; </span><br><span class="line">    /**</span><br><span class="line">     * 测试</span><br><span class="line">     */ </span><br><span class="line">    public SampleResult runTest(JavaSamplerContext arg0) &#123;</span><br><span class="line">        //获取界面或测试计划配置文件（jmx）中传入的参数</span><br><span class="line">        if (arg0.getParameter(&quot;method&quot;) != null) method = arg0.getParameter(&quot;method&quot;);</span><br><span class="line">        if (arg0.getIntParameter(&quot;size&quot;) &gt; 0) size = arg0.getIntParameter(&quot;size&quot;);</span><br><span class="line">        value = new Byte[size];</span><br><span class="line"></span><br><span class="line">        SampleResult sr = new SampleResult(); </span><br><span class="line">        try &#123;</span><br><span class="line">            boolean result = true;</span><br><span class="line">            //根据传入的method参数测试相应的缓存接口方法</span><br><span class="line">            if (method.equals(&quot;get&quot;))&#123;</span><br><span class="line">                //测试用例的核心逻辑</span><br><span class="line">                //测试用例开始</span><br><span class="line">                sr.sampleStart();</span><br><span class="line">                //测试用例执行</span><br><span class="line">                result = get();</span><br><span class="line">                //测试用例结果</span><br><span class="line">                sr.setSuccessful(result);</span><br><span class="line">                //测试用例结束</span><br><span class="line">                sr.sampleEnd();</span><br><span class="line">            &#125; else if (method.equals(&quot;set&quot;)) &#123;</span><br><span class="line">                sr.sampleStart();</span><br><span class="line">                result = set();</span><br><span class="line">                sr.setSuccessful(result);</span><br><span class="line">                sr.sampleEnd();</span><br><span class="line">            &#125; else if (method.equals(&quot;hGet&quot;)) &#123;</span><br><span class="line">                sr.sampleStart();</span><br><span class="line">                result = hGet();</span><br><span class="line">                sr.setSuccessful(result);</span><br><span class="line">                sr.sampleEnd();</span><br><span class="line">            &#125; else if (method.equals(&quot;hSet&quot;)) &#123;</span><br><span class="line">                sr.sampleStart();</span><br><span class="line">                result = hSet();</span><br><span class="line">                sr.setSuccessful(result);</span><br><span class="line">                sr.sampleEnd();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123; </span><br><span class="line">             e.printStackTrace(); </span><br><span class="line">        &#125; </span><br><span class="line">        return sr; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 缓存接口get方法测试用例</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public boolean get() &#123;</span><br><span class="line">        boolean result = true;</span><br><span class="line">        try &#123;</span><br><span class="line">            dataCache.get(key);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">            result = false;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 缓存接口set方法测试用例</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public boolean set() &#123;</span><br><span class="line">        boolean result = true;</span><br><span class="line">        try &#123;</span><br><span class="line">            dataCache.put(key, value);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">            result = false;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 缓存接口hGet方法测试用例</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public boolean hGet() &#123;</span><br><span class="line">        boolean result = true;</span><br><span class="line">        try &#123;</span><br><span class="line">            dataCache.hGet(key, field);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">            result = false;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 缓存接口hSet方法测试用例</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public boolean hSet() &#123;</span><br><span class="line">        boolean result = true;</span><br><span class="line">        try &#123;</span><br><span class="line">            result = dataCache.hSet(key, field, value);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">            result = false;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5）将工程以jar包形式导出，置于JMeter目录lib\ext下，并将工程依赖的jar包置于JMeter目录lib下，启动JMeter。右键“测试计划”添加“线程组”。右键“线程组”添加“Java请求”，右键“Java请求”添加“聚合报告”。<br><a href="http://magicwt.com/wp-content/uploads/2015/11/120427371.gif" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/120427371-300x185.gif" alt="120427371"></a></p>
<p><a href="http://magicwt.com/wp-content/uploads/2015/11/120429563.gif" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/120429563-300x196.gif" alt="120429563"></a></p>
<p><a href="http://magicwt.com/wp-content/uploads/2015/11/120431779.gif" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/120431779-300x279.gif" alt="120431779"></a><br>6）在“Java请求”中选择所写的测试类，并可以设置相关参数，在“线程组”中可以设置并发线程数和循环次数，点击上方“启动”按钮开始测试，测试完成后，可以在“聚合报告”中查看到测试结果。<br><a href="http://magicwt.com/wp-content/uploads/2015/11/120525177.gif" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/120525177-300x59.gif" alt="120525177"></a></p>
<p><a href="http://magicwt.com/wp-content/uploads/2015/11/120527349.gif" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/120527349-300x150.gif" alt="120527349"></a></p>
<p><a href="http://magicwt.com/wp-content/uploads/2015/11/120529448.gif" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/120529448-300x23.gif" alt="120529448"></a><br><strong>Java请求测试（命令行操作）</strong><br>JMeter也支持命令行操作，在服务器上进行测试时，我们就采用了这种方式。一个简单的JMeter命令行操作如下所示（在JMeter目录bin下执行）。<br>[blockquote]Windows下： JMeter-n –t test.jmx -l result.jtl<br>Linux下： ./jmeter.sh -n –t test.jmx -l result.jtl[/blockquote]<br>其中-n 表示命令行执行，test.jmx为测试计划配置文件，result.jtl为测试结果。<br>可在界面中进行测试计划配置，然后保存便可生成jmx格式文件，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;jmeterTestPlan version=&quot;1.2&quot; properties=&quot;2.4&quot; jmeter=&quot;2.9 r1437961&quot;&gt;</span><br><span class="line">  &lt;hashTree&gt;</span><br><span class="line">    &lt;TestPlan guiclass=&quot;TestPlanGui&quot; testclass=&quot;TestPlan&quot; testname=&quot;测试计划&quot; enabled=&quot;true&quot;&gt;</span><br><span class="line">      &lt;stringProp name=&quot;TestPlan.comments&quot;&gt;&lt;/stringProp&gt;</span><br><span class="line">      &lt;boolProp name=&quot;TestPlan.functional_mode&quot;&gt;false&lt;/boolProp&gt;</span><br><span class="line">      &lt;boolProp name=&quot;TestPlan.serialize_threadgroups&quot;&gt;false&lt;/boolProp&gt;</span><br><span class="line">      &lt;elementProp name=&quot;TestPlan.user_defined_variables&quot; elementType=&quot;Arguments&quot; guiclass=&quot;ArgumentsPanel&quot; testclass=&quot;Arguments&quot; testname=&quot;用户定义的变量&quot; enabled=&quot;true&quot;&gt;</span><br><span class="line">        &lt;collectionProp name=&quot;Arguments.arguments&quot;/&gt;</span><br><span class="line">      &lt;/elementProp&gt;</span><br><span class="line">      &lt;stringProp name=&quot;TestPlan.user_define_classpath&quot;&gt;&lt;/stringProp&gt;</span><br><span class="line">    &lt;/TestPlan&gt;</span><br><span class="line">    &lt;hashTree&gt;</span><br><span class="line">      &lt;ThreadGroup guiclass=&quot;ThreadGroupGui&quot; testclass=&quot;ThreadGroup&quot; testname=&quot;线程组&quot; enabled=&quot;true&quot;&gt;</span><br><span class="line">        &lt;stringProp name=&quot;ThreadGroup.on_sample_error&quot;&gt;continue&lt;/stringProp&gt;</span><br><span class="line">        &lt;elementProp name=&quot;ThreadGroup.main_controller&quot; elementType=&quot;LoopController&quot; guiclass=&quot;LoopControlPanel&quot; testclass=&quot;LoopController&quot; testname=&quot;循环控制器&quot; enabled=&quot;true&quot;&gt;</span><br><span class="line">          &lt;boolProp name=&quot;LoopController.continue_forever&quot;&gt;false&lt;/boolProp&gt;</span><br><span class="line">          &lt;!-- 循环次数 --&gt;</span><br><span class="line">          &lt;stringProp name=&quot;LoopController.loops&quot;&gt;100&lt;/stringProp&gt;</span><br><span class="line">        &lt;/elementProp&gt;</span><br><span class="line">        &lt;!-- 并发线程数 --&gt;</span><br><span class="line">        &lt;stringProp name=&quot;ThreadGroup.num_threads&quot;&gt;100&lt;/stringProp&gt;</span><br><span class="line">        &lt;stringProp name=&quot;ThreadGroup.ramp_time&quot;&gt;100&lt;/stringProp&gt;</span><br><span class="line">        &lt;longProp name=&quot;ThreadGroup.start_time&quot;&gt;1376103961000&lt;/longProp&gt;</span><br><span class="line">        &lt;longProp name=&quot;ThreadGroup.end_time&quot;&gt;1376103961000&lt;/longProp&gt;</span><br><span class="line">        &lt;boolProp name=&quot;ThreadGroup.scheduler&quot;&gt;false&lt;/boolProp&gt;</span><br><span class="line">        &lt;stringProp name=&quot;ThreadGroup.duration&quot;&gt;&lt;/stringProp&gt;</span><br><span class="line">        &lt;stringProp name=&quot;ThreadGroup.delay&quot;&gt;&lt;/stringProp&gt;</span><br><span class="line">      &lt;/ThreadGroup&gt;</span><br><span class="line">      &lt;hashTree&gt;</span><br><span class="line">        &lt;JavaSampler guiclass=&quot;JavaTestSamplerGui&quot; testclass=&quot;JavaSampler&quot; testname=&quot;Java请求&quot; enabled=&quot;true&quot;&gt;</span><br><span class="line">          &lt;elementProp name=&quot;arguments&quot; elementType=&quot;Arguments&quot; guiclass=&quot;ArgumentsPanel&quot; testclass=&quot;Arguments&quot; enabled=&quot;true&quot;&gt;</span><br><span class="line">            &lt;!-- 自定义参数 --&gt;</span><br><span class="line">            &lt;collectionProp name=&quot;Arguments.arguments&quot;&gt;</span><br><span class="line">              &lt;elementProp name=&quot;size&quot; elementType=&quot;Argument&quot;&gt;</span><br><span class="line">                &lt;stringProp name=&quot;Argument.name&quot;&gt;size&lt;/stringProp&gt;</span><br><span class="line">                &lt;stringProp name=&quot;Argument.value&quot;&gt;8192&lt;/stringProp&gt;</span><br><span class="line">                &lt;stringProp name=&quot;Argument.metadata&quot;&gt;=&lt;/stringProp&gt;</span><br><span class="line">              &lt;/elementProp&gt;</span><br><span class="line">              &lt;elementProp name=&quot;method&quot; elementType=&quot;Argument&quot;&gt;</span><br><span class="line">                &lt;stringProp name=&quot;Argument.name&quot;&gt;method&lt;/stringProp&gt;</span><br><span class="line">                &lt;stringProp name=&quot;Argument.value&quot;&gt;set&lt;/stringProp&gt;</span><br><span class="line">                &lt;stringProp name=&quot;Argument.metadata&quot;&gt;=&lt;/stringProp&gt;</span><br><span class="line">              &lt;/elementProp&gt;</span><br><span class="line">            &lt;/collectionProp&gt;</span><br><span class="line">          &lt;/elementProp&gt;</span><br><span class="line">          &lt;stringProp name=&quot;classname&quot;&gt;com.sohu.cms.test.TestDataCacheClient&lt;/stringProp&gt;</span><br><span class="line">        &lt;/JavaSampler&gt;</span><br><span class="line">        &lt;hashTree&gt;</span><br><span class="line">          &lt;ResultCollector guiclass=&quot;StatVisualizer&quot; testclass=&quot;ResultCollector&quot; testname=&quot;聚合报告&quot; enabled=&quot;true&quot;&gt;</span><br><span class="line">            &lt;boolProp name=&quot;ResultCollector.error_logging&quot;&gt;false&lt;/boolProp&gt;</span><br><span class="line">            &lt;objProp&gt;</span><br><span class="line">              &lt;name&gt;saveConfig&lt;/name&gt;</span><br><span class="line">              &lt;value class=&quot;SampleSaveConfiguration&quot;&gt;</span><br><span class="line">                &lt;time&gt;true&lt;/time&gt;</span><br><span class="line">                &lt;latency&gt;true&lt;/latency&gt;</span><br><span class="line">                &lt;timestamp&gt;true&lt;/timestamp&gt;</span><br><span class="line">                &lt;success&gt;true&lt;/success&gt;</span><br><span class="line">                &lt;label&gt;true&lt;/label&gt;</span><br><span class="line">                `true`</span><br><span class="line">                &lt;message&gt;true&lt;/message&gt;</span><br><span class="line">                &lt;threadName&gt;true&lt;/threadName&gt;</span><br><span class="line">                &lt;dataType&gt;true&lt;/dataType&gt;</span><br><span class="line">                &lt;encoding&gt;false&lt;/encoding&gt;</span><br><span class="line">                &lt;assertions&gt;true&lt;/assertions&gt;</span><br><span class="line">                &lt;subresults&gt;true&lt;/subresults&gt;</span><br><span class="line">                &lt;responseData&gt;false&lt;/responseData&gt;</span><br><span class="line">                &lt;samplerData&gt;false&lt;/samplerData&gt;</span><br><span class="line">                &lt;xml&gt;false&lt;/xml&gt;</span><br><span class="line">                &lt;fieldNames&gt;false&lt;/fieldNames&gt;</span><br><span class="line">                &lt;responseHeaders&gt;false&lt;/responseHeaders&gt;</span><br><span class="line">                &lt;requestHeaders&gt;false&lt;/requestHeaders&gt;</span><br><span class="line">                &lt;responseDataOnError&gt;false&lt;/responseDataOnError&gt;</span><br><span class="line">                &lt;saveAssertionResultsFailureMessage&gt;false&lt;/saveAssertionResultsFailureMessage&gt;</span><br><span class="line">                &lt;assertionsResultsToSave&gt;0&lt;/assertionsResultsToSave&gt;</span><br><span class="line">                &lt;bytes&gt;true&lt;/bytes&gt;</span><br><span class="line">              &lt;/value&gt;</span><br><span class="line">            &lt;/objProp&gt;</span><br><span class="line">            &lt;stringProp name=&quot;filename&quot;&gt;&lt;/stringProp&gt;</span><br><span class="line">          &lt;/ResultCollector&gt;</span><br><span class="line">          &lt;hashTree/&gt;</span><br><span class="line">        &lt;/hashTree&gt;</span><br><span class="line">      &lt;/hashTree&gt;</span><br><span class="line">    &lt;/hashTree&gt;</span><br><span class="line">  &lt;/hashTree&gt;</span><br><span class="line">&lt;/jmeterTestPlan&gt;</span><br></pre></td></tr></table></figure>
<p>result.ftl为按行输出的测试执行结果，如下所示，可在界面操作的聚合报告导入该文件从而生成聚合报告。<br>[blockquote]…<br>1376040889436,48,Java请求,,,线程组1-40,,true,0,0<br>1376040889792,9,Java请求,,,线程组1-7,,true,0,0<br>1376040889526,167,Java请求,,,线程组1-57,,true,0,0<br>1376040889791,10,Java请求,,,线程组 1-54,,true,0,0<br>…[/blockquote]</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2013/07/10/e8-bd-achibernate-e7-bc-93-e5-ad-98-e6-9c-ba-e5-88-b6/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/07/10/e8-bd-achibernate-e7-bc-93-e5-ad-98-e6-9c-ba-e5-88-b6/" itemprop="url">[转]Hibernate 缓存机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-07-10T14:35:56+08:00">
                2013-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文地址：<a href="http://www.cnblogs.com/wean/archive/2012/05/16/2502724.html" target="_blank" rel="noopener">http://www.cnblogs.com/wean/archive/2012/05/16/2502724.html</a></p>
<h2 id="一、why（为什么要用Hibernate缓存？）"><a href="#一、why（为什么要用Hibernate缓存？）" class="headerlink" title="一、why（为什么要用Hibernate缓存？）"></a>一、why（为什么要用Hibernate缓存？）</h2><p>Hibernate是一个持久层框架，经常访问物理数据库。<br>为了降低应用程序对物理数据源访问的频次，从而提高应用程序的运行性能。<br>缓存内的数据是对物理数据源中的数据的复制，应用程序在运行时从缓存读写数据，在特定的时刻或事件会同步缓存和物理数据源的数据。</p>
<h2 id="二、what（Hibernate缓存原理是怎样的？）"><a href="#二、what（Hibernate缓存原理是怎样的？）" class="headerlink" title="二、what（Hibernate缓存原理是怎样的？）"></a>二、what（Hibernate缓存原理是怎样的？）</h2><p>Hibernate缓存包括两大类：Hibernate一级缓存和Hibernate二级缓存。</p>
<h3 id="1-Hibernate一级缓存又称为“Session的缓存”。"><a href="#1-Hibernate一级缓存又称为“Session的缓存”。" class="headerlink" title="1.Hibernate一级缓存又称为“Session的缓存”。"></a>1.Hibernate一级缓存又称为“Session的缓存”。</h3><p>Session内置不能被卸载，Session的缓存是事务范围的缓存（Session对象的生命周期通常对应一个数据库事务或者一个应用事务）。<br>一级缓存中，持久化类的每个实例都具有唯一的OID。</p>
<h3 id="2-Hibernate二级缓存又称为“SessionFactory的缓存”。"><a href="#2-Hibernate二级缓存又称为“SessionFactory的缓存”。" class="headerlink" title="2.Hibernate二级缓存又称为“SessionFactory的缓存”。"></a>2.Hibernate二级缓存又称为“SessionFactory的缓存”。</h3><p>由于SessionFactory对象的生命周期和应用程序的整个过程对应，因此Hibernate二级缓存是进程范围或者集群范围的缓存，有可能出现并发问题，因此需要采用适当的并发访问策略，该策略为被缓存的数据提供了事务隔离级别。<br>第二级缓存是可选的，是一个可配置的插件，默认下SessionFactory不会启用这个插件。<br>Hibernate提供了org.hibernate.cache.CacheProvider接口,它充当缓存插件与Hibernate之间的适配器。<br>什么样的数据适合存放到第二级缓存中？<br>1) 很少被修改的数据<br>2) 不是很重要的数据，允许出现偶尔并发的数据<br>3) 不会被并发访问的数据<br>4) 常量数据<br>不适合存放到第二级缓存的数据？<br>1) 经常被修改的数据<br>2) 绝对不允许出现并发访问的数据，如财务数据，绝对不允许出现并发<br>3) 与其他应用共享的数据。</p>
<h3 id="3-Session的延迟加载实现要解决两个问题：正常关闭连接和确保请求中访问的是同一个session。"><a href="#3-Session的延迟加载实现要解决两个问题：正常关闭连接和确保请求中访问的是同一个session。" class="headerlink" title="3.Session的延迟加载实现要解决两个问题：正常关闭连接和确保请求中访问的是同一个session。"></a>3.Session的延迟加载实现要解决两个问题：正常关闭连接和确保请求中访问的是同一个session。</h3><p>Hibernate session就是java.sql.Connection的一层高级封装，一个session对应了一个Connection。<br>http请求结束后正确的关闭session（过滤器实现了session的正常关闭）；延迟加载必须保证是同一个session（session绑定在ThreadLocal）。</p>
<h3 id="4-Hibernate查找对象如何应用缓存？"><a href="#4-Hibernate查找对象如何应用缓存？" class="headerlink" title="4.Hibernate查找对象如何应用缓存？"></a>4.Hibernate查找对象如何应用缓存？</h3><p>当Hibernate根据ID访问数据对象的时候，首先从Session一级缓存中查；<br>查不到，如果配置了二级缓存，那么从二级缓存中查；<br>如果都查不到，再查询数据库，把结果按照ID放入到缓存删除、更新、增加数据的时候，同时更新缓存。</p>
<h3 id="5-一级缓存与二级缓存的对比图。"><a href="#5-一级缓存与二级缓存的对比图。" class="headerlink" title="5.一级缓存与二级缓存的对比图。"></a>5.一级缓存与二级缓存的对比图。</h3><table border="1"><br><tbody><br><tr><br><td></td><br><td>一级缓存</td><br><td>二级缓存</td><br></tr><br><tr><br><td>存放数据的形式</td><br><td>相互关联的持久化对象</td><br><td>对象的散装数据</td><br></tr><br><tr><br><td>缓存的范围</td><br><td>事务范围，每个事务都拥有单独的一级缓存</td><br><td>进程范围或集群范围，缓存被同一个进程或集群范围内所有事务共享</td><br></tr><br><tr><br><td>并发访问策略</td><br><td>由于每个事务都拥有单独的一级缓存不会出现并发问题，因此无须提供并发访问策略</td><br><td>由于多个事务会同时访问二级缓存中的相同数据，因此必须提供适当的并发访问策略，来保证特定的事务隔离级别</td><br></tr><br><tr><br><td>数据过期策略</td><br><td>处于一级缓存中的对象永远不会过期，除非应用程序显示清空或者清空特定对象</td><br><td>必须提供数据过期策略，如基于内存的缓存中对象的最大数目，允许对象处于缓存中的最长时间，以及允许对象处于缓存中的最长空闲时间</td><br></tr><br><tr><br><td valign="top" width="124">物理介质</td><br><td valign="top" width="222">内存</td><br><td valign="top" width="222">内存和硬盘，对象的散装数据首先存放到基于内存的缓存中，当内存中对象的数目达到数据过期策略的maxElementsInMemory值，就会把其余的对象写入基于硬盘的缓存中</td><br></tr><br><tr><br><td valign="top" width="124">缓存软件实现</td><br><td valign="top" width="222">在Hibernate的Session的实现中包含</td><br><td valign="top" width="222">由第三方提供，Hibernate仅提供了缓存适配器，用于把特定的缓存插件集成到Hibernate中</td><br></tr><br><tr><br><td>启用缓存<strong>的</strong>方式</td><br><td>只要通过Session接口来执行保存，更新，删除，加载，查询，Hibernate就会启用一级缓存，对于批量操作，如不希望启用一级缓存，直接通过JDBCAPI来执行</td><br><td>用户可以再单个类或类的单个集合的粒度上配置第二级缓存，如果类的实例被经常读，但很少被修改，就可以考虑使用二级缓存，只有为某个类或集合配置了二级缓存，Hibernate在运行时才会把它的实例加入到二级缓存中</td><br></tr><br><tr><br><td>用户管理缓存的方式</td><br><td>一级缓存的物理介质为内存，由于内存的容量有限，必须通过恰当的检索策略和检索方式来限制加载对象的数目，Session的evit()方法可以显示的清空缓存中特定对象，但不推荐</td><br><td>二级缓存的物理介质可以使内存和硬盘，因此第二级缓存可以存放大容量的数据，数据过期策略的maxElementsInMemory属性可以控制内存中的对象数目，管理二级缓存主要包括两个方面：选择需要使用第二级缓存的持久化类，设置合适的并发访问策略；选择缓存适配器，设置合适的数据过期策略。SessionFactory的evit()方法也可以显示的清空缓存中特定对象，但不推荐</td><br></tr><br></tbody><br></table>

<h2 id="三、how（Hibernate的缓存机制如何应用？）"><a href="#三、how（Hibernate的缓存机制如何应用？）" class="headerlink" title="三、how（Hibernate的缓存机制如何应用？）"></a>三、how（Hibernate的缓存机制如何应用？）</h2><h3 id="1-一级缓存的管理："><a href="#1-一级缓存的管理：" class="headerlink" title="1. 一级缓存的管理："></a>1. 一级缓存的管理：</h3><p>evit(Object obj) 将指定的持久化对象从一级缓存中清除,释放对象所占用的内存资源,指定对象从持久化状态变为脱管状态,从而成为游离对象。<br>clear() 将一级缓存中的所有持久化对象清除,释放其占用的内存资源。<br>contains(Object obj) 判断指定的对象是否存在于一级缓存中。<br>flush() 刷新一级缓存区的内容,使之与数据库数据保持同步。</p>
<h3 id="2-一级缓存应用："><a href="#2-一级缓存应用：" class="headerlink" title="2.一级缓存应用："></a>2.一级缓存应用：</h3><p>save()。当session对象调用save()方法保存一个对象后，该对象会被放入到session的缓存中。<br>get()和load()。当session对象调用get()或load()方法从数据库取出一个对象后，该对象也会被放入到session的缓存中。 使用HQL和QBC等从数据库中查询数据。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public class Client</span><br><span class="line">&#123;</span><br><span class="line">    public static void main(String[] args)</span><br><span class="line">    &#123;</span><br><span class="line">        Session session = HibernateUtil.getSessionFactory().openSession();</span><br><span class="line">        Transaction tx = null;</span><br><span class="line">        try</span><br><span class="line">        &#123;</span><br><span class="line">            /*开启一个事务*/</span><br><span class="line">            tx = session.beginTransaction();</span><br><span class="line">            /*从数据库中获取id=&quot;402881e534fa5a440134fa5a45340002&quot;的Customer对象*/</span><br><span class="line">            Customer customer1 = (Customer)session.get(Customer.class, &quot;402881e534fa5a440134fa5a45340002&quot;);</span><br><span class="line">            System.out.println(&quot;customer.getUsername is&quot;+customer1.getUsername());</span><br><span class="line">            /*事务提交*/</span><br><span class="line">            tx.commit();</span><br><span class="line"></span><br><span class="line">            System.out.println(&quot;-------------------------------------&quot;);</span><br><span class="line"></span><br><span class="line">            /*开启一个新事务*/</span><br><span class="line">            tx = session.beginTransaction();</span><br><span class="line">            /*从数据库中获取id=&quot;402881e534fa5a440134fa5a45340002&quot;的Customer对象*/</span><br><span class="line">            Customer customer2 = (Customer)session.get(Customer.class, &quot;402881e534fa5a440134fa5a45340002&quot;);</span><br><span class="line">            System.out.println(&quot;customer2.getUsername is&quot;+customer2.getUsername());</span><br><span class="line">            /*事务提交*/</span><br><span class="line">            tx.commit();</span><br><span class="line"></span><br><span class="line">            System.out.println(&quot;-------------------------------------&quot;);</span><br><span class="line"></span><br><span class="line">            /*比较两个get()方法获取的对象是否是同一个对象*/</span><br><span class="line">            System.out.println(&quot;customer1 == customer2 result is &quot;+(customer1==customer2));</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            if(tx!=null)</span><br><span class="line">            &#123;</span><br><span class="line">                tx.rollback();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        finally</span><br><span class="line">        &#123;</span><br><span class="line">            session.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果<br>[blockquote]Hibernate:<br>select<br>customer0_.id as id0_0_,<br>customer0_.username as username0_0_,<br>customer0_.balance as balance0_0_<br>from<br>customer customer0_<br>where<br>customer0_.id=?</p>
<h2 id="customer-getUsername-islisi"><a href="#customer-getUsername-islisi" class="headerlink" title="customer.getUsername islisi"></a>customer.getUsername islisi</h2><h2 id="customer2-getUsername-islisi"><a href="#customer2-getUsername-islisi" class="headerlink" title="customer2.getUsername islisi"></a>customer2.getUsername islisi</h2><p>customer1 == customer2 result is true[/blockquote]<br>输出结果中只包含了一条SELECT SQL语句，而且customer1 == customer2 result is true说明两个取出来的对象是同一个对象。其原理是：第一次调用get()方法， Hibernate先检索缓存中是否有该查找对象，发现没有，Hibernate发送SELECT语句到数据库中取出相应的对象，然后将该对象放入缓存中，以便下次使用，第二次调用get()方法，Hibernate先检索缓存中是否有该查找对象，发现正好有该查找对象，就从缓存中取出来，不再去数据库中检索。</p>
<h3 id="3-二级缓存的管理："><a href="#3-二级缓存的管理：" class="headerlink" title="3.二级缓存的管理："></a>3.二级缓存的管理：</h3><p>evict(Class arg0, Serializable arg1)将某个类的指定ID的持久化对象从二级缓存中清除,释放对象所占用的资源。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sessionFactory.evict(Customer.class, new Integer(1));</span><br></pre></td></tr></table></figure></p>
<p>evict(Class arg0) 将指定类的所有持久化对象从二级缓存中清除,释放其占用的内存资源。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sessionFactory.evict(Customer.class);</span><br></pre></td></tr></table></figure></p>
<p>evictCollection(String arg0) 将指定类的所有持久化对象的指定集合从二级缓存中清除,释放其占用的内存资源。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sessionFactory.evictCollection(&quot;Customer.orders&quot;);</span><br></pre></td></tr></table></figure></p>
<h3 id="4-二级缓存的配置"><a href="#4-二级缓存的配置" class="headerlink" title="4.二级缓存的配置"></a>4.二级缓存的配置</h3><p>常用的二级缓存插件<br>EHCache org.hibernate.cache.EhCacheProvider<br>OSCache org.hibernate.cache.OSCacheProvider<br>SwarmCahe org.hibernate.cache.SwarmCacheProvider<br>JBossCache org.hibernate.cache.TreeCacheProvider<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- EHCache的配置,hibernate.cfg.xml --&gt; </span><br><span class="line">&lt;hibernate-configuration&gt;</span><br><span class="line">    &lt;session-factory&gt;</span><br><span class="line">       &lt;!-- 设置二级缓存插件EHCache的Provider类--&gt;</span><br><span class="line">       &lt;property name=&quot;hibernate.cache.provider_class&quot;&gt;</span><br><span class="line">          org.hibernate.cache.EhCacheProvider</span><br><span class="line">       &lt;/property&gt;</span><br><span class="line">       &lt;!-- 启动&quot;查询缓存&quot; --&gt;</span><br><span class="line">       &lt;property name=&quot;hibernate.cache.use_query_cache&quot;&gt;</span><br><span class="line">          true</span><br><span class="line">       &lt;/property&gt;</span><br><span class="line">    &lt;/session-factory&gt;</span><br><span class="line">  &lt;/hibernate-configuration&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- ehcache.xml --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;ehcache&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">        缓存到硬盘的路径</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;diskStore path=&quot;d:/ehcache&quot;&gt;&lt;/diskStore&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">        默认设置</span><br><span class="line">        maxElementsInMemory : 在內存中最大緩存的对象数量。</span><br><span class="line">        eternal : 缓存的对象是否永远不变。</span><br><span class="line">        timeToIdleSeconds ：可以操作对象的时间。</span><br><span class="line">        timeToLiveSeconds ：缓存中对象的生命周期，时间到后查询数据会从数据库中读取。</span><br><span class="line">        overflowToDisk ：内存满了，是否要缓存到硬盘。</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;defaultCache maxElementsInMemory=&quot;200&quot; eternal=&quot;false&quot; </span><br><span class="line">        timeToIdleSeconds=&quot;50&quot; timeToLiveSeconds=&quot;60&quot; overflowToDisk=&quot;true&quot;&gt;&lt;/defaultCache&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">        指定缓存的对象。</span><br><span class="line">        下面出现的的属性覆盖上面出现的，没出现的继承上面的。</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;cache name=&quot;com.suxiaolei.hibernate.pojos.Order&quot; maxElementsInMemory=&quot;200&quot; eternal=&quot;false&quot; </span><br><span class="line">        timeToIdleSeconds=&quot;50&quot; timeToLiveSeconds=&quot;60&quot; overflowToDisk=&quot;true&quot;&gt;&lt;/cache&gt;</span><br><span class="line">&lt;/ehcache&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- *.hbm.xml --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&apos;UTF-8&apos;?&gt;</span><br><span class="line">&lt;!DOCTYPE hibernate-mapping PUBLIC</span><br><span class="line"> &quot;-//Hibernate/Hibernate Mapping DTD 3.0//EN&quot;</span><br><span class="line"> &quot;http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd&quot; &gt;</span><br><span class="line">&lt;hibernate-mapping&gt;</span><br><span class="line">   &lt;class&gt;</span><br><span class="line">       &lt;!-- 设置该持久化类的二级缓存并发访问策略 read-only read-write nonstrict-read-write transactional--&gt;</span><br><span class="line">       &lt;cache usage=&quot;read-write&quot;/&gt;    </span><br><span class="line">   &lt;/class&gt;</span><br><span class="line">&lt;/hibernate-mapping&gt;</span><br></pre></td></tr></table></figure>
<p>若存在一对多的关系，想要在在获取一方的时候将关联的多方缓存起来，需要在集合属性下添加<cache>子标签，这里需要将关联的对象的hbm文件中必须在存在<class>标签下也添加<cache>标签，不然Hibernate只会缓存OID。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;hibernate-mapping&gt;</span><br><span class="line">    &lt;class name=&quot;com.suxiaolei.hibernate.pojos.Customer&quot; table=&quot;customer&quot;&gt;</span><br><span class="line">        &lt;!-- 主键设置 --&gt;</span><br><span class="line">        &lt;id name=&quot;id&quot; type=&quot;string&quot;&gt;</span><br><span class="line">            &lt;column name=&quot;id&quot;&gt;&lt;/column&gt;</span><br><span class="line">            &lt;generator class=&quot;uuid&quot;&gt;&lt;/generator&gt;</span><br><span class="line">        &lt;/id&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 属性设置 --&gt;</span><br><span class="line">        &lt;property name=&quot;username&quot; column=&quot;username&quot; type=&quot;string&quot;&gt;&lt;/property&gt;</span><br><span class="line">        &lt;property name=&quot;balance&quot; column=&quot;balance&quot; type=&quot;integer&quot;&gt;&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">        &lt;set name=&quot;orders&quot; inverse=&quot;true&quot; cascade=&quot;all&quot; lazy=&quot;false&quot; fetch=&quot;join&quot;&gt;</span><br><span class="line">            &lt;cache usage=&quot;read-only&quot;/&gt;</span><br><span class="line">            &lt;key column=&quot;customer_id&quot; &gt;&lt;/key&gt;</span><br><span class="line">            &lt;one-to-many class=&quot;com.suxiaolei.hibernate.pojos.Order&quot;/&gt;</span><br><span class="line">        &lt;/set&gt;</span><br><span class="line">    &lt;/class&gt;</span><br><span class="line">&lt;/hibernate-mapping&gt;</span><br></pre></td></tr></table></figure></cache></class></cache></p>
<script>// <![CDATA[
jQuery(function(){jQuery(".copyright").hide();});
// ]]></script>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2013/07/09/hibernate-e7-9a-84-e5-bb-b6-e8-bf-9f-e5-8a-a0-e8-bd-bd/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/07/09/hibernate-e7-9a-84-e5-bb-b6-e8-bf-9f-e5-8a-a0-e8-bd-bd/" itemprop="url">Hibernate的延迟加载</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-07-09T01:14:13+08:00">
                2013-07-09
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Hibernate通过延迟加载在真正需要使用数据时从数据库表中加载，这样可以加快程序运行速度，减少内存开销。Hibernate在以下三种情况会默认使用延迟加载：<br>1）load方法延迟加载；<br>2）实体属性延迟加载；<br>3）集合属性延迟加载。</p>
<h2 id="数据库示例"><a href="#数据库示例" class="headerlink" title="数据库示例"></a>数据库示例</h2><p><a href="http://magicwt.com/wp-content/uploads/2013/07/1.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2013/07/1.png" alt="1"></a><br>示例数据库包含3张表：<br>1）文章表（post），存储文章标题、内容，主键为自增整数；<br>2）分类表（category），存储分类名称，主键为自增整数；<br>3）标签表（score），存储标签名称，主键为自增整数；<br>4）文章标签表（post_tag），存储文章包含的标签，使用文章id和标签id作为联合主键。<br>每篇文章属于一个分类，并包含多个标签。</p>
<h2 id="延迟加载示例"><a href="#延迟加载示例" class="headerlink" title="延迟加载示例"></a>延迟加载示例</h2><p>创建Post类与post表映射。<br>Post.java：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package com.magicwt.bean;</span><br><span class="line"></span><br><span class="line">import java.util.Set;</span><br><span class="line"></span><br><span class="line">public class Post &#123;</span><br><span class="line"></span><br><span class="line">    //与主键id映射</span><br><span class="line">    private int id;</span><br><span class="line">    //与字段title映射</span><br><span class="line">    private String title;</span><br><span class="line">    //与字段content映射</span><br><span class="line">    private String content;</span><br><span class="line">    //关联Category实体</span><br><span class="line">    private Category category;</span><br><span class="line">    //关联Tag实体</span><br><span class="line">    private Set&lt;Tag&gt; tags;</span><br><span class="line"></span><br><span class="line">    public int getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId(int id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getTitle() &#123;</span><br><span class="line">        return title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setTitle(String title) &#123;</span><br><span class="line">        this.title = title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getContent() &#123;</span><br><span class="line">        return content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setContent(String content) &#123;</span><br><span class="line">        this.content = content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Category getCategory() &#123;</span><br><span class="line">        return category;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCategory(Category category) &#123;</span><br><span class="line">        this.category = category;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Set&lt;Tag&gt; getTags() &#123;</span><br><span class="line">        return tags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setTags(Set&lt;Tag&gt; tags) &#123;</span><br><span class="line">        this.tags = tags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Post.hbm.xml：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&apos;1.0&apos; encoding=&apos;utf-8&apos;?&gt;</span><br><span class="line">&lt;!DOCTYPE hibernate-mapping PUBLIC</span><br><span class="line">    &quot;-//Hibernate/Hibernate Mapping DTD 3.0//EN&quot;</span><br><span class="line">    &quot;http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd&quot;&gt;</span><br><span class="line">&lt;hibernate-mapping&gt;</span><br><span class="line">    &lt;class name=&quot;com.magicwt.bean.Post&quot; table=&quot;post&quot;&gt;</span><br><span class="line">        &lt;id name=&quot;id&quot;&gt;</span><br><span class="line">            &lt;column name=&quot;id&quot; sql-type=&quot;int&quot; not-null=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;/id&gt;</span><br><span class="line">        &lt;property name=&quot;title&quot;&gt;</span><br><span class="line">            &lt;column name=&quot;title&quot; sql-type=&quot;varchar&quot; length=&quot;16&quot;/&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">        &lt;property name=&quot;content&quot;&gt;</span><br><span class="line">            &lt;column name=&quot;content&quot; sql-type=&quot;text&quot; length=&quot;65535&quot;/&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">        &lt;!-- 实体属性，对应于一个分类实体 --&gt;</span><br><span class="line">        &lt;one-to-one name=&quot;category&quot; class=&quot;com.magicwt.bean.Category&quot; constrained=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;!-- 集合属性，对应于多个标签实体 --&gt;</span><br><span class="line">        &lt;set name=&quot;tags&quot; table=&quot;post_tag&quot; inverse=&quot;true&quot;&gt;</span><br><span class="line">            &lt;key column=&quot;post_id&quot;/&gt;</span><br><span class="line">            &lt;many-to-many column=&quot;tag_id&quot; class=&quot;com.magicwt.bean.Tag&quot;/&gt;</span><br><span class="line">        &lt;/set&gt;</span><br><span class="line">    &lt;/class&gt;</span><br><span class="line">&lt;/hibernate-mapping&gt;</span><br></pre></td></tr></table></figure></p>
<p>创建Category类与category表映射。<br>Category.java：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package com.magicwt.bean;</span><br><span class="line"></span><br><span class="line">public class Category &#123;</span><br><span class="line"></span><br><span class="line">    //与主键id映射</span><br><span class="line">    private int id;</span><br><span class="line">    //与字段name映射</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    public int getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId(int id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Category.hbm.xml：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&apos;1.0&apos; encoding=&apos;utf-8&apos;?&gt;</span><br><span class="line">&lt;!DOCTYPE hibernate-mapping PUBLIC</span><br><span class="line">    &quot;-//Hibernate/Hibernate Mapping DTD 3.0//EN&quot;</span><br><span class="line">    &quot;http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd&quot;&gt;</span><br><span class="line">&lt;hibernate-mapping&gt;</span><br><span class="line">    &lt;class name=&quot;com.magicwt.bean.Category&quot; table=&quot;category&quot;&gt;</span><br><span class="line">        &lt;id name=&quot;id&quot;&gt;</span><br><span class="line">            &lt;column name=&quot;id&quot; sql-type=&quot;int&quot; not-null=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;/id&gt;</span><br><span class="line">        &lt;property name=&quot;name&quot;&gt;</span><br><span class="line">            &lt;column name=&quot;name&quot; sql-type=&quot;varchar&quot; length=&quot;16&quot;/&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">    &lt;/class&gt;</span><br><span class="line">&lt;/hibernate-mapping&gt;</span><br></pre></td></tr></table></figure></p>
<p>创建Tag类与tag表映射。<br>Tag.java：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package com.magicwt.bean;</span><br><span class="line"></span><br><span class="line">public class Tag &#123;</span><br><span class="line"></span><br><span class="line">    //与主键id映射</span><br><span class="line">    private int id;</span><br><span class="line">    //与字段name映射</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    public int getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId(int id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Tag.hbm.xml：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&apos;1.0&apos; encoding=&apos;utf-8&apos;?&gt;</span><br><span class="line">&lt;!DOCTYPE hibernate-mapping PUBLIC</span><br><span class="line">    &quot;-//Hibernate/Hibernate Mapping DTD 3.0//EN&quot;</span><br><span class="line">    &quot;http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd&quot;&gt;</span><br><span class="line">&lt;hibernate-mapping&gt;</span><br><span class="line">    &lt;class name=&quot;com.magicwt.bean.Tag&quot; table=&quot;tag&quot;&gt;</span><br><span class="line">        &lt;id name=&quot;id&quot;&gt;</span><br><span class="line">            &lt;column name=&quot;id&quot; sql-type=&quot;int&quot; not-null=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;/id&gt;</span><br><span class="line">        &lt;property name=&quot;name&quot;&gt;</span><br><span class="line">            &lt;column name=&quot;name&quot; sql-type=&quot;varchar&quot; length=&quot;16&quot;/&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">    &lt;/class&gt;</span><br><span class="line">&lt;/hibernate-mapping&gt;</span><br></pre></td></tr></table></figure></p>
<p>Hibernate配置文件hibernate.cfg.xml：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&apos;1.0&apos; encoding=&apos;utf-8&apos;?&gt;</span><br><span class="line">&lt;!DOCTYPE hibernate-configuration PUBLIC</span><br><span class="line">        &quot;-//Hibernate/Hibernate Configuration DTD 3.0//EN&quot;</span><br><span class="line">        &quot;http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd&quot;&gt;</span><br><span class="line">&lt;hibernate-configuration&gt;</span><br><span class="line">    &lt;session-factory&gt;</span><br><span class="line">        &lt;property name=&quot;connection.driver_class&quot;&gt;com.mysql.jdbc.Driver&lt;/property&gt;</span><br><span class="line">        &lt;property name=&quot;connection.url&quot;&gt;jdbc:mysql://xxx.xxx.xxx.xxx:3306/test&lt;/property&gt;</span><br><span class="line">        &lt;property name=&quot;connection.username&quot;&gt;xxx&lt;/property&gt;</span><br><span class="line">        &lt;property name=&quot;connection.password&quot;&gt;xxx&lt;/property&gt;</span><br><span class="line">        &lt;property name=&quot;dialect&quot;&gt;org.hibernate.dialect.MySQL5Dialect&lt;/property&gt;</span><br><span class="line">        &lt;property name=&quot;show_sql&quot;&gt;true&lt;/property&gt;</span><br><span class="line">        &lt;property name=&quot;hibernate.format_sql&quot;&gt;true&lt;/property&gt;</span><br><span class="line">        &lt;mapping resource=&quot;mapper/Category.hbm.xml&quot;/&gt;</span><br><span class="line">        &lt;mapping resource=&quot;mapper/Post.hbm.xml&quot;/&gt;</span><br><span class="line">        &lt;mapping resource=&quot;mapper/Tag.hbm.xml&quot;/&gt;</span><br><span class="line">    &lt;/session-factory&gt;</span><br><span class="line">&lt;/hibernate-configuration&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="load方法延迟加载"><a href="#load方法延迟加载" class="headerlink" title="load方法延迟加载"></a>load方法延迟加载</h3><p>创建测试类Test：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package com.magicwt;</span><br><span class="line"></span><br><span class="line">import com.magicwt.bean.Post;</span><br><span class="line">import org.hibernate.SessionFactory;</span><br><span class="line">import org.hibernate.cfg.Configuration;</span><br><span class="line">import org.hibernate.classic.Session;</span><br><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SessionFactory sessionFactory = (new Configuration()).configure().buildSessionFactory();</span><br><span class="line">        Session session = sessionFactory.openSession();</span><br><span class="line">        //使用load方法加载id为1的文章</span><br><span class="line">        Post post = (Post)session.load(Post.class, Integer.valueOf(1));</span><br><span class="line">        //输出post实例的类名</span><br><span class="line">        System.out.println(&quot;class of post: &quot; + post.getClass().getCanonicalName());</span><br><span class="line">        //取出文章标题并输出</span><br><span class="line">        System.out.println(post.getTitle());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行main方法，输出如下：<br>[blockquote]class of post: com.magicwt.bean.Post$$EnhancerByCGLIB$$70a21d16<br>Hibernate:<br>&nbsp;&nbsp;&nbsp;&nbsp;select<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.id as id1_0_,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.title as title1_0_,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.content as content1_0_<br>&nbsp;&nbsp;&nbsp;&nbsp;from<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post post0_<br>&nbsp;&nbsp;&nbsp;&nbsp;where<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.id=?<br>title of post: 测试标题1[/blockquote]<br>从中可以看出，load方法返回的是通过动态代理实现的代理类实例。通过断点可以观察到，执行“post.getTitle()”前，post实例各属性都是默认值（null或0），执行“post.getTitle()”后，才真正从数据库表中取出数据并输出。<br>将load方法修改为get方法并重新执行，输出如下：<br>[blockquote]Hibernate:<br>&nbsp;&nbsp;&nbsp;&nbsp;select<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.id as id1_0_,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.title as title1_0_,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.content as content1_0_<br>&nbsp;&nbsp;&nbsp;&nbsp;from<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post post0_<br>&nbsp;&nbsp;&nbsp;&nbsp;where<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.id=?<br>class of post: com.magicwt.bean.Post<br>title of post: 测试标题1[/blockquote]<br>从中可以看出，get方法返回的是Post类实例。通过断点可以观察到，get方法返回的post实例各属性已从数据库表中取出对应的值，get方法并没有延迟加载。</p>
<h3 id="实体属性延迟加载"><a href="#实体属性延迟加载" class="headerlink" title="实体属性延迟加载"></a>实体属性延迟加载</h3><p>修改测试类Test：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package com.magicwt;</span><br><span class="line"></span><br><span class="line">import com.magicwt.bean.Post;</span><br><span class="line">import org.hibernate.SessionFactory;</span><br><span class="line">import org.hibernate.cfg.Configuration;</span><br><span class="line">import org.hibernate.classic.Session;</span><br><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SessionFactory sessionFactory = (new Configuration()).configure().buildSessionFactory();</span><br><span class="line">        Session session = sessionFactory.openSession();</span><br><span class="line">        //使用load方法加载id为1的文章</span><br><span class="line">        Post post = (Post)session.get(Post.class, Integer.valueOf(1));</span><br><span class="line">        //输出post实例的类名</span><br><span class="line">        System.out.println(&quot;class of post: &quot; + post.getClass().getCanonicalName());</span><br><span class="line">        //输出post实例category属性的类名</span><br><span class="line">        System.out.println(&quot;class of category: &quot; + post.getCategory().getClass().getCanonicalName());</span><br><span class="line">        //输出分类名称</span><br><span class="line">        System.out.println(&quot;name of category:&quot; + post.getCategory().getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行main方法，输出如下：<br>[blockquote]Hibernate:<br>&nbsp;&nbsp;&nbsp;&nbsp;select<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.id as id1_0_,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.title as title1_0_,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.content as content1_0_<br>&nbsp;&nbsp;&nbsp;&nbsp;from<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post post0_<br>&nbsp;&nbsp;&nbsp;&nbsp;where<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.id=?<br>class of post: com.magicwt.bean.Post<br>class of category: com.magicwt.bean.Category$$EnhancerByCGLIB$$483428f6<br>Hibernate:<br>&nbsp;&nbsp;&nbsp;&nbsp;select<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;category0_.id as id0_0_,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;category0_.name as name0_0_<br>&nbsp;&nbsp;&nbsp;&nbsp;from<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;category category0_<br>&nbsp;&nbsp;&nbsp;&nbsp;where<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;category0_.id=?<br>name of category: 测试分类1[/blockquote]<br>从中可以看出，get方法返回的post实例，其属性category是代理类实例，并没有真正读取category表中的数据，只有在输出分类名称时，才读取category表中的数据。</p>
<h3 id="集合属性延迟加载"><a href="#集合属性延迟加载" class="headerlink" title="集合属性延迟加载"></a>集合属性延迟加载</h3><p>修改测试类Test：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package com.magicwt;</span><br><span class="line"></span><br><span class="line">import com.magicwt.bean.Post;</span><br><span class="line">import com.magicwt.bean.Tag;</span><br><span class="line">import org.hibernate.SessionFactory;</span><br><span class="line">import org.hibernate.cfg.Configuration;</span><br><span class="line">import org.hibernate.classic.Session;</span><br><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SessionFactory sessionFactory = (new Configuration()).configure().buildSessionFactory();</span><br><span class="line">        Session session = sessionFactory.openSession();</span><br><span class="line">        //使用load方法加载id为1的文章</span><br><span class="line">        Post post = (Post)session.get(Post.class, Integer.valueOf(1));</span><br><span class="line">        //输出post实例的类名</span><br><span class="line">        System.out.println(&quot;class of post: &quot; + post.getClass().getCanonicalName());</span><br><span class="line">        //输出post实例tags属性的类名</span><br><span class="line">        System.out.println(&quot;class of tags: &quot; + post.getTags().getClass().getCanonicalName());</span><br><span class="line">        //输出标签名称</span><br><span class="line">        for (Tag tag : post.getTags()) &#123;</span><br><span class="line">            System.out.println(&quot;name of tag: &quot; + tag.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行main方法，输出如下：<br>[blockquote]Hibernate:<br>&nbsp;&nbsp;&nbsp;&nbsp;select<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.id as id1_0_,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.title as title1_0_,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.content as content1_0_<br>&nbsp;&nbsp;&nbsp;&nbsp;from<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post post0_<br>&nbsp;&nbsp;&nbsp;&nbsp;where<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post0_.id=?<br>class of post: com.magicwt.bean.Post<br>class of tags: org.hibernate.collection.PersistentSet<br>Hibernate:<br>&nbsp;&nbsp;&nbsp;&nbsp;select<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tags0_.post_id as post1_1_,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tags0_.tag_id as tag2_1_,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tag1_.id as id3_0_,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tag1_.name as name3_0_<br>&nbsp;&nbsp;&nbsp;&nbsp;from<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post_tag tags0_<br>&nbsp;&nbsp;&nbsp;&nbsp;left outer join<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tag tag1_<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on tags0_.tag_id=tag1_.id<br>&nbsp;&nbsp;&nbsp;&nbsp;where<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tags0_.post_id=?<br>name of tag: 测试标签1<br>name of tag: 测试标签2[/blockquote]<br>从中可以看出，get方法返回的post实例，其属性tags是PersistentSet实例，并没有真正读取tag表中的数据，只有在输出标签名称时，才读取tag表中的数据。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2013/06/30/keepalived-e4-bb-8b-e7-bb-8d/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/06/30/keepalived-e4-bb-8b-e7-bb-8d/" itemprop="url">Keepalived介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-06-30T12:43:49+08:00">
                2013-06-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/服务器/" itemprop="url" rel="index">
                    <span itemprop="name">服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Keepalived介绍"><a href="#Keepalived介绍" class="headerlink" title="Keepalived介绍"></a>Keepalived介绍</h2><p>Keepalived是一款高可用软件，它的功能主要包括两方面：<br>1）通过IP漂移，实现服务的高可用：服务器集群共享一个虚拟IP，同一时间只有一个服务器占有虚拟IP并对外提供服务，若该服务器不可用，则虚拟IP漂移至另一台服务器并对外提供服务；<br>2）对LVS应用服务层的应用服务器集群进行状态监控：若应用服务器不可用，则keepalived将其从集群中摘除，若应用服务器恢复，则keepalived将其重新加入集群中。<br>Keepalived可以单独使用，即通过IP漂移实现服务的高可用，也可以结合LVS使用，即一方面通过IP漂移实现LVS负载均衡层的高可用，另一方面实现LVS应用服务层的状态监控，如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/11/13.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/13-300x242.png" alt="1"></a></p>
<h2 id="Keepalived原理"><a href="#Keepalived原理" class="headerlink" title="Keepalived原理"></a>Keepalived原理</h2><p>Keepalived的实现基于VRRP（Virtual Router Redundancy Protocol，虚拟路由器冗余协议），而VRRP是为了解决静态路由的高可用。VRRP的基本架构如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/11/21.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/21-300x282.png" alt="2"></a><br>虚拟路由器由多个VRRP路由器组成，每个VRRP路由器都有各自的IP和共同的VRID(0-255)，其中一个VRRP路由器通过竞选成为MASTER，占有VIP，对外提供路由服务，其他成为BACKUP，MASTER以IP组播（组播地址：224.0.0.18）形式发送VRRP协议包，与BACKUP保持心跳连接，若MASTER不可用（或BACKUP接收不到VRRP协议包），则BACKUP通过竞选产生新的MASTER并继续对外提供路由服务，从而实现高可用。</p>
<h2 id="Keepalived安装配置"><a href="#Keepalived安装配置" class="headerlink" title="Keepalived安装配置"></a>Keepalived安装配置</h2><p>下载地址：<a href="http://www.keepalived.org/download.html" target="_blank" rel="noopener">http://www.keepalived.org/download.html</a><br>Linux下以默认配置安装：<br>[blockquote]tar –zxvf keepalived-1.2.7.tar.gz<br>cd keepalived-1.2.7<br>./configure<br>make<br>make install[/blockquote]<br>或：<br>[blockquote]yum install keepalived[/blockquote]<br>执行脚本：<br>[blockquote]/etc/init.d/keepalived start|stop|restart[/blockquote]<br>由于keepalived服务之间需要使用VRRP协议进行通信，因此需要进行防火墙配置：<br>[blockquote]iptables –I INPUT –i eth0 –d 224.0.0.0/8 –j ACCEPT<br>iptables –A INPUT –i eth0 –p vrrp –j ACCEPT<br>iptables –A OUTPUT –p vrrp –o eth0 –j ACCEPT[/blockquote]<br>配置文件：<br>[blockquote]/etc/keepalived/keepalived.conf[/blockquote]<br>Keeaplived的配置包含三部分：<br>1）全局配置，配置邮件等；<br>2）VRRPD配置，配置VRRP实例；<br>3）LVS配置，配置LVS的应用服务器；<br>若只是单独使用keepalived，通过IP漂移实现服务的高可用，则只需要配置前两部分就可以，若结合LVS使用，实现LVS负载均衡层的高可用、应用服务层的状态监控，则还需要配置第三部分。</p>
<h2 id="Keepalived应用示例"><a href="#Keepalived应用示例" class="headerlink" title="Keepalived应用示例"></a>Keepalived应用示例</h2><h3 id="1）单独使用（IP漂移）"><a href="#1）单独使用（IP漂移）" class="headerlink" title="1）单独使用（IP漂移）"></a>1）单独使用（IP漂移）</h3><p><a href="http://magicwt.com/wp-content/uploads/2015/11/31.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/31-300x254.png" alt="3"></a><br>如图所示，两台机器192.168.80.128、192.168.80.129共享虚拟IP 192.168.80.130，192.168.80.128、192.168.80.129的keepalived配置分别如下所示：<br>[blockquote]global_defs {<br>router_id LVS_DEVEL<br>}</p>
<p>vrrp_instance_VI_1{<br><span style="color: #ff0000;">state MASTER</span><br>interface eth0<br>virtual_router_id 201<br><span style="color: #ff0000;">priority 100</span><br>advert_int 1<br>authentication {<br>auth_type PASS<br>auth_pass 1111<br>}<br>virtual_ipaddress {<br>192.168.80.130/24 dev eth0<br>}<br>}[/blockquote]<br>[blockquote]global_defs {<br>router_id LVS_DEVEL<br>}</p>
<p>vrrp_instance_VI_1{<br><span style="color: #ff0000;">state BACKUP</span><br>interface eth0<br>virtual_router_id 201<br><span style="color: #ff0000;">priority 50</span><br>advert_int 1<br>authentication {<br>auth_type PASS<br>auth_pass 1111<br>}<br>virtual_ipaddress {<br>192.168.80.130/24 dev eth0<br>}<br>}[/blockquote]<br>•启动192.168.80.128、192.168.80.129上的keepalived<br>192.168.80.128成为MASTER，占有VIP 192.168.80.130并对外组播VRRP协议包<br><a href="http://magicwt.com/wp-content/uploads/2015/11/41.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/41-300x43.png" alt="4"></a><br><a href="http://magicwt.com/wp-content/uploads/2015/11/51.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/51-300x22.png" alt="5"></a><br>192.168.80.129无变化<br><a href="http://magicwt.com/wp-content/uploads/2015/11/61.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/61-300x34.png" alt="6"></a><br>•关闭192.168.80.128上的keepalived<br>192.168.80.128不再占有VIP 192.168.80.130<br><a href="http://magicwt.com/wp-content/uploads/2015/11/71.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/71-300x36.png" alt="7"></a><br>192.168.80.129成为MASTER，占有VIP 192.168.80.130并对外组播VRRP协议包<br><a href="http://magicwt.com/wp-content/uploads/2015/11/81.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/81-300x41.png" alt="8"></a><br><a href="http://magicwt.com/wp-content/uploads/2015/11/91.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/91-300x21.png" alt="9"></a></p>
<h3 id="2）结合LVS使用"><a href="#2）结合LVS使用" class="headerlink" title="2）结合LVS使用"></a>2）结合LVS使用</h3><p><a href="http://magicwt.com/wp-content/uploads/2015/11/101.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/101-295x300.png" alt="10"></a><br>LVS高可用集群通过VIP 192.168.80.130对外提供服务，负载均衡层有两台服务器192.168.80.132、192.168.80.135，负责分发服务请求至应用服务层，通过keepalived实现这两台服务器的负载均衡高可用（和单独使用keepalived的应用示例相同），应用服务层也有两台服务器192.168.80.133、192.168.80.134，负责对外提供Web应用服务，通过keepalived实现这两台服务器的状态监控。<br>192.168.80.132、192.168.80.135上的keepalived配置在全局配置、VRRPD配置上和单独使用keepalived的应用示例相同，但需要添加LVS配置，如下所示：<br>[blockquote]virtual_server 192.168.80.130 80 {<br>delay_loop 6<br>lb_algowlc<br>lb_kind DR<br>persistence_timeout 50<br>protocolTCP<br><span style="color: #ff0000;">real_server 192.168.80.133 80</span> {<br>weight1<br>TCP_CHECK{<br>connect_timeout 3<br>nb_get_retry 3<br>delay_before_retry 3<br>}<br>}<br><span style="color: #ff0000;">real_server 192.168.80.134 80</span> {<br>weight 1<br>TCP_CHECK{<br>connect_timeout 3<br>nb_get_retry 3<br>delay_before_retry 3<br>}<br>}<br>}[/blockquote]<br>启动服务后，负载均衡层通过VIP对外提供服务，并将服务请求转发至133和134这两台应用服务器上：<br><a href="http://magicwt.com/wp-content/uploads/2015/11/111.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/111-300x65.png" alt="11"></a><br><a href="http://magicwt.com/wp-content/uploads/2015/11/121.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/121-300x75.png" alt="12"></a><br>132和135这两台负载均衡服务器中，132占有VIP 130，并对133和134进行状态监控：<br><a href="http://magicwt.com/wp-content/uploads/2015/11/131.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/131-300x102.png" alt="13"></a><br>•应用服务状态监控<br>若133和134这两台应用服务器中，134服务不可用，则keepalived将其从应用服务器集群中摘除，待其恢复后，又重新加入，在其恢复前，负载均衡层将应用请求均转发至133，保证服务可用。<br><a href="http://magicwt.com/wp-content/uploads/2015/11/14.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/14-300x28.png" alt="14"></a><br><a href="http://magicwt.com/wp-content/uploads/2015/11/15.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/15.png" alt="15"></a><br>•负载均衡服务高可用<br>若132和135这两台负载均衡服务器中，132服务不可用，则keepalived将VIP 130漂移至135，由135负责应用请求转发，保证服务可用。<br><a href="http://magicwt.com/wp-content/uploads/2015/11/16.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/16-300x42.png" alt="16"></a><br><a href="http://magicwt.com/wp-content/uploads/2015/11/17.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/17.png" alt="17"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2013/01/06/157/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/01/06/157/" itemprop="url">ActiveMQ的PHP、Python客户端</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-01-06T15:11:40+08:00">
                2013-01-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>ActiveMQ这款开源消息服务器提供了多语言支持，除了一般的Java客户端以外，还可以使用C/C++、PHP、Python、JavaScript（Ajax）等语言开发客户端。最近由于项目需要，需要提供PHP和Python的主题订阅客户端。这里作为总结，列出这两种语言客户端的简单安装和使用。<br>对于PHP和Python，可以通过使用STOMP协议与消息服务器进行通讯。在ActiveMQ的配置文件activemq.xml中，需要添加以下语句，来提供基于STOMP协议的连接器。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transportConnectors</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">transportConnector</span> <span class="attr">name</span>=<span class="string">"openwire"</span> <span class="attr">uri</span>=<span class="string">"tcp://0.0.0.0:61616"</span>/&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">transportConnector</span> <span class="attr">name</span>=<span class="string">"stomp"</span> <span class="attr">uri</span>=<span class="string">"stomp://0.0.0.0:61613"</span>/&gt;</span><span class="comment">&lt;!--添加stomp连接器--&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">transportConnectors</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2013/01/06/157/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2012/09/23/activemq-e7-9a-84-e5-ae-89-e5-85-a8-e6-9c-ba-e5-88-b6-e4-bd-bf-e7-94-a8-e5-8f-8a-e5-85-b6-e6-ba-90-e4-bb-a3-e7-a0-81-e5-88-86-e6-9e-90/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2012/09/23/activemq-e7-9a-84-e5-ae-89-e5-85-a8-e6-9c-ba-e5-88-b6-e4-bd-bf-e7-94-a8-e5-8f-8a-e5-85-b6-e6-ba-90-e4-bb-a3-e7-a0-81-e5-88-86-e6-9e-90/" itemprop="url">ActiveMQ的安全机制使用及其源代码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2012-09-23T23:09:07+08:00">
                2012-09-23
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>ActiveMQ是目前较为流行的一款开源消息服务器。最近在项目开发中，需要为ActiveMQ开发基于IP的验证和授权机制，因此，对ActiveMQ的安全机制进行了了解，以下将介绍ActiveMQ的安全机制使用及其源代码分析。<br>本文开发环境介绍：<br>操作系统：Windows XP<br>Java：jdk 1.6.0_12<br>maven：maven 3.0.4<br>ActiveMQ：ActiveMQ 5.6.0<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2012/09/23/activemq-e7-9a-84-e5-ae-89-e5-85-a8-e6-9c-ba-e5-88-b6-e4-bd-bf-e7-94-a8-e5-8f-8a-e5-85-b6-e6-ba-90-e4-bb-a3-e7-a0-81-e5-88-86-e6-9e-90/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </p></div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">magicwt</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">90</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">49</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/magicwt" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:wang-t04@mails.tsinghua.edu.cn" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">magicwt</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
