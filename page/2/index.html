<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="magicwt的博客">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="magicwt的博客">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="magicwt的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/">





  <title>magicwt的博客</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">magicwt的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/24/e5-9f-ba-e4-ba-8ezookeeper-e7-9a-84-e6-9c-8d-e5-8a-a1-e6-b3-a8-e5-86-8c-e5-92-8c-e5-8f-91-e7-8e-b0-e5-ae-9e-e8-b7-b5/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/01/24/e5-9f-ba-e4-ba-8ezookeeper-e7-9a-84-e6-9c-8d-e5-8a-a1-e6-b3-a8-e5-86-8c-e5-92-8c-e5-8f-91-e7-8e-b0-e5-ae-9e-e8-b7-b5/" itemprop="url">基于ZooKeeper的服务注册和发现实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-01-24T22:20:47+08:00">
                2016-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h2><p>在分布式架构中，各模块采用多节点部署，对外提供服务，节点数量和服务地址不断会有变化，因此，对于服务调用者，需要动态获取服务地址。ZooKeeper（<a href="http://zookeeper.apache.org/）提供分布式协调服务，服务提供者可以将服务注册至ZooKeeper规定路径中，服务调用者再从ZooKeeper规定路径中动态发现服务，如图所示：" target="_blank" rel="noopener">http://zookeeper.apache.org/）提供分布式协调服务，服务提供者可以将服务注册至ZooKeeper规定路径中，服务调用者再从ZooKeeper规定路径中动态发现服务，如图所示：</a><br><a href="http://magicwt.com/wp-content/uploads/2016/01/注册发现服务架构.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/01/注册发现服务架构-300x154.png" alt="注册发现服务架构"></a></p>
<h2 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h2><p>Curator（<a href="http://curator.apache.org/）进一步封装了ZooKeeper" target="_blank" rel="noopener">http://curator.apache.org/）进一步封装了ZooKeeper</a> API，提供了许多高级功能，包括服务注册和发现。ZooKeeper使用版本3.4.6，Curator使用版本2.9.1，在pom.xml中增加Curator依赖，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.2.5.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;curator-x-discovery&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.9.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
<p>使用Curator进行服务注册，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/* 服务注册 start */</span><br><span class="line">// 创建CuratorFramework实例，封装与ZooKeeper的操作。</span><br><span class="line">CuratorFramework curatorFramework = CuratorFrameworkFactory.newClient(&quot;xxx.xxx.xxx.xxx:2181&quot;, new RetryNTimes(4, 2000));</span><br><span class="line">curatorFramework.start();</span><br><span class="line">// 创建ServiceInstanceBuilder实例，指定服务名称和地址，</span><br><span class="line">// 由ServiceInstanceBuilder实例构建ServiceInstance实例，ServiceInstance实例即服务。</span><br><span class="line">ServiceInstanceBuilder serviceInstanceBuilder = ServiceInstance.builder();</span><br><span class="line">serviceInstanceBuilder.uriSpec(new UriSpec(&quot;&#123;scheme&#125;://&#123;address&#125;:&#123;port&#125;&quot;));</span><br><span class="line">serviceInstanceBuilder.address(&quot;xxx.xxx.xxx.xxx&quot;);</span><br><span class="line">serviceInstanceBuilder.port(8080);</span><br><span class="line">serviceInstanceBuilder.name(&quot;service1&quot;);</span><br><span class="line">ServiceInstance serviceInstance = serviceInstanceBuilder.build();</span><br><span class="line">// 创建serviceDiscoveryBuilder实例，指定服务和服务在Zookeeper中所在路径，</span><br><span class="line">// 由ServiceDiscoveryBuilder实例构建ServiceDiscovery实例，由ServiceDiscovery实例注册服务。</span><br><span class="line">ServiceDiscoveryBuilder serviceDiscoveryBuilder = ServiceDiscoveryBuilder.builder(Void.class);</span><br><span class="line">serviceDiscoveryBuilder.basePath(&quot;test&quot;);</span><br><span class="line">serviceDiscoveryBuilder.client(curatorFramework);</span><br><span class="line">ServiceDiscovery serviceDiscovery = serviceDiscoveryBuilder.build();</span><br><span class="line">serviceDiscovery.start();</span><br><span class="line">//注册服务</span><br><span class="line">serviceDiscovery.registerService(serviceInstance);</span><br><span class="line">/* 服务注册 end */</span><br><span class="line">// 等待30秒，这时在ZooKeeper中可以查看到注册的服务</span><br><span class="line">Thread.sleep(30000);</span><br><span class="line">// 30秒后，进程关闭，ZooKeeper中注册的服务因是临时节点而被删除，说明服务已不可用</span><br></pre></td></tr></table></figure></p>
<p>启动进程，在ZooKeeper中可以查看到注册的服务，在服务“service1”所在路径“/test/service1”下有一个临时节点“ffd66440-e0b0-41a5-b93a-c558c527b3bc”，表示刚启动、注册的服务，如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2016/01/1.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/01/1.png" alt="1"></a><br>30秒后进程关闭，在ZooKeeper中可以查看到，注册的服务因是临时节点而被删除，说明服务已不可用，如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2016/01/1-1.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/01/1-1.png" alt="1"></a></p>
<h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><p>调用ServiceDiscovery实例的queryForInstances方法可以发现服务，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/* 服务发现 start */</span><br><span class="line">// 创建CuratorFramework实例，封装与ZooKeeper的操作。</span><br><span class="line">CuratorFramework curatorFramework = CuratorFrameworkFactory.newClient(&quot;xxx.xxx.xxx.xxx:2181&quot;, new RetryNTimes(4, 2000));</span><br><span class="line">curatorFramework.start();</span><br><span class="line">// 创建serviceDiscoveryBuilder实例，指定服务在Zookeeper中所在路径，</span><br><span class="line">// 由ServiceDiscoveryBuilder实例构建ServiceDiscovery实例，由ServiceDiscovery实例发现服务。</span><br><span class="line">ServiceDiscoveryBuilder serviceDiscoveryBuilder = ServiceDiscoveryBuilder.builder(Void.class);</span><br><span class="line">serviceDiscoveryBuilder.basePath(&quot;test&quot;);</span><br><span class="line">serviceDiscoveryBuilder.client(curatorFramework);</span><br><span class="line">ServiceDiscovery serviceDiscovery = serviceDiscoveryBuilder.build();</span><br><span class="line">serviceDiscovery.start();</span><br><span class="line">Collection&lt;ServiceInstance&gt; collection = serviceDiscovery.queryForInstances(&quot;service1&quot;);</span><br><span class="line">if (collection != null &amp;&amp; collection.size() &gt; 0) &#123;</span><br><span class="line">    System.out.println(&quot;found &quot; + collection.size() + &quot; service1 services&quot;);</span><br><span class="line">    for (ServiceInstance serviceInstance : collection) &#123;</span><br><span class="line">        System.out.println(&quot;id: &quot; + serviceInstance.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">/* 服务发现 end */</span><br></pre></td></tr></table></figure></p>
<p>启动进程，发现服务，如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2016/01/1-2.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/01/1-2.png" alt="1"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/24/e4-b8-80-e7-a7-8d-e5-9f-ba-e4-ba-8enginxhessian-e7-9a-84-e9-ab-98-e5-8f-af-e7-94-a8-e5-88-86-e5-b8-83-e5-bc-8f-e6-9e-b6-e6-9e-84/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/01/24/e4-b8-80-e7-a7-8d-e5-9f-ba-e4-ba-8enginxhessian-e7-9a-84-e9-ab-98-e5-8f-af-e7-94-a8-e5-88-86-e5-b8-83-e5-bc-8f-e6-9e-b6-e6-9e-84/" itemprop="url">一种基于Nginx+Hessian的高可用分布式架构</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-01-24T00:14:35+08:00">
                2016-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>需要为不同角色的用户分别提供管理系统用于管理资源。</p>
<h2 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h2><p>整体架构如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2016/01/架构图1.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/01/架构图1.png" alt="架构图(1)"></a><br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/01/24/e4-b8-80-e7-a7-8d-e5-9f-ba-e4-ba-8enginxhessian-e7-9a-84-e9-ab-98-e5-8f-af-e7-94-a8-e5-88-86-e5-b8-83-e5-bc-8f-e6-9e-b6-e6-9e-84/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </p></div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/10/e5-b7-a5-e4-bd-9c-e6-80-bb-e7-bb-93/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/01/10/e5-b7-a5-e4-bd-9c-e6-80-bb-e7-bb-93/" itemprop="url">工作总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-01-10T10:11:09+08:00">
                2016-01-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/生活点滴/" itemprop="url" rel="index">
                    <span itemprop="name">生活点滴</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>从14年5月至今，转眼一年多过去了，希望通过这篇文章对这段时间的主要工作做个简单的梳理、总结。</p>
<h2 id="主要工作"><a href="#主要工作" class="headerlink" title="主要工作"></a>主要工作</h2><p>搜狐公众平台（mp.sohu.com）是在搜狐门户改革背景下全新打造的分类内容的入驻、发布和分发全平台，通过搜狐网、手机搜狐网和搜狐新闻客户端三端来推广媒体和自媒体优质内容。搜狐公众平台主要流程如下图所示：<br><a href="http://magicwt.com/wp-content/uploads/2016/01/整体.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/01/整体.png" alt="整体"></a><br>在整个流程中，我主要负责文章发文后的推荐工作，围绕文章推荐和流量分发，我主要完成了下述工作：<br><a href="http://magicwt.com/wp-content/uploads/2016/01/主要工作.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/01/主要工作-300x300.png" alt="主要工作"></a><br>1）统计，对用户、文章流量进行离线、实时统计；<br>2）优选，对文章进行筛选、排序，选取优质内容自动更新至三端入口；<br>3）本地，对文章按地域进行归并，自动更新至客户端本地流；<br>4）搜索，对文章构建索引，提供按关键词进行文章搜索；<br>5）相关，计算文章之间的相关度，为每一篇文章提供相关文章列表；<br>6）个性化，计算文章和读者之间的相关度，通过“猜你喜欢”为读者提供个性化推荐文章列表。</p>
<h2 id="技术架构"><a href="#技术架构" class="headerlink" title="技术架构"></a>技术架构</h2><p>整体技术架构如下图所示：<br><a href="http://magicwt.com/wp-content/uploads/2016/01/技术架构3.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/01/技术架构3.png" alt="技术架构(3)"></a><br>1）接口接入，使用Nginx作反向代理，并基于OpenResty在Nginx中通过Lua读取数据实现高可用接口；<br>2）App，使用Java和Python作应用开发，Java应用基于Spring实现上下文管理、MVC和数据库读写等；<br>3）Web容器，使用Resin；<br>4）任务调度，使用Cronhub进行集中式管理；<br>5）日志收集，使用Flume读取Nginx日志并写入Kafka；<br>6）消息队列，使用Kafka；<br>7）数据计算，使用MapReduce作离线计算，使用Storm作实时计算；<br>8）数据存储，使用MySQL作关系存储，使用Redis/SSDB作Key-Value存储，使用HDFS/Hive存储海量日志数据；<br>9）搜索引擎，使用ElasticSearch搭建分布式高可用搜索集群。</p>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><p>1）统计：<br>使用Nginx集群收集访问日志，使用HDFS存储访问数据，使用MapReduce离线处理访问数据，使用Flume+Kafka+Storm实时处理访问数据。通过离线和实时处理，统计平台流量数据。基于AngularJS+RESTful API实现内部数据运营系统。基于OpenResty实现高可用、高吞吐量的流量数据访问接口供前端页面调用。<br>2）优选：<br>基于流量反馈、作者平台表现、文章格式与时效选取优质文章作为热点推荐。<br>3）本地：<br>对平台海量文章基于地名关键词识别本地文章，并基于SimHash算法对文章按内容滤重。开发本地文章运营系统，对识别、滤重后的本地文章进一步人工筛选，提供本地文章接口供客户端调用展示。<br>4）搜索：<br>搭建Elasticsearch集群，对文章按照标题和内容构建索引，并对外提供文章搜索接口。<br>5）相关：<br>使用机器学习库Gensim库基于TF-IDF模型计算文章标题之间的相似度，选取相似度最高的若干篇文章作为相关文章，并对外提供相关文章接口。<br>6）个性化：<br>通过文章分类、关键词构建文章模型，使用Storm实时分析用户访问行为，通过其所访问文章的分类、关键词构建用户模型，计算用户模型与文章模型的余弦相似度，选取相似度最高的若干篇文章作为用户个性化推荐。</p>
<h2 id="未来工作"><a href="#未来工作" class="headerlink" title="未来工作"></a>未来工作</h2><p>未来计划深入算法方面的工作，搭建完整的算法开发框架，包括特征提取、离线训练、离线评测、模型上线、用户分桶、线上评测，目标是通过这套框架，使得算法开发流程规范化、流程化。<br><a href="http://magicwt.com/wp-content/uploads/2016/01/排序2.0.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/01/排序2.0.png" alt="排序2.0"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/04/e5-9f-ba-e4-ba-8eactivemq-e7-9a-84-e6-b6-88-e6-81-af-e6-8e-a8-e9-80-81-e5-ae-9e-e7-8e-b0/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/01/04/e5-9f-ba-e4-ba-8eactivemq-e7-9a-84-e6-b6-88-e6-81-af-e6-8e-a8-e9-80-81-e5-ae-9e-e7-8e-b0/" itemprop="url">基于ActiveMQ的消息推送实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-01-04T20:41:52+08:00">
                2016-01-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p><a href="http://magicwt.com/wp-content/uploads/2015/12/应用场景1.jpg" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/应用场景1-300x261.jpg" alt="应用场景"></a><br>应用场景是当用户在餐饮、娱乐场所消费时，可以用手机关注商户微信公众号，并从公众号中访问商户评论页面，发表评论，评论会实时推送至现场的各个显示屏终端上，因此就需要开发一个评论消息推送系统，该系统具体需要满足：<br>1）能够向所有显示屏终端发送评论消息；<br>2）能够指定向某台显示屏终端发送评论消息。</p>
<h2 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h2><p><a href="http://magicwt.com/wp-content/uploads/2015/12/消息推送1.jpg" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/消息推送1-300x126.jpg" alt="消息推送"></a><br>基于ActiveMQ实现评论消息推送系统，Producer使用OpenWire协议将评论消息发送至Topic，Consumer通过订阅Topic，使用MQTT协议从Topic上取到评论消息。Topic是广播模式，同一个评论消息可以被所有订阅Topic的Consumer接收，这样就可以实现向所有显示屏终端发送评论消息。在conf/activemq.xml中配置ActiveMQ支持使用OpenWire协议和MQTT协议连接，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;transportConnectors&gt;</span><br><span class="line">    &lt;!-- DOS protection, limit concurrent connections to 1000 and frame size to 100MB --&gt;</span><br><span class="line">    &lt;transportConnector name=&quot;openwire&quot; uri=&quot;tcp://0.0.0.0:61616?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600&quot;/&gt;</span><br><span class="line">    &lt;transportConnector name=&quot;mqtt&quot; uri=&quot;mqtt://0.0.0.0:1883?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600&quot;/&gt;</span><br><span class="line">&lt;/transportConnectors&gt;</span><br></pre></td></tr></table></figure></p>
<p>如何向某台显示屏终端发送消息呢？这里参考了博客《使用ActiveMQ+MQTT实现Android点对点消息通知》（<a href="http://blog.csdn.net/kimmking/article/details/17449019）：通过在评论消息中设置一个属性记录这个消息需要发往Consumer的id，然后当消息在ActiveMQ中被分发至Consumer时，采用自定义的分发策略，该策略取出当前所有连接的Consumer，判断Consumer的id是否与消息中记录的值相等，若相等，则将消息发往这个Consumer。自定义分发策略代码如下所示：" target="_blank" rel="noopener">http://blog.csdn.net/kimmking/article/details/17449019）：通过在评论消息中设置一个属性记录这个消息需要发往Consumer的id，然后当消息在ActiveMQ中被分发至Consumer时，采用自定义的分发策略，该策略取出当前所有连接的Consumer，判断Consumer的id是否与消息中记录的值相等，若相等，则将消息发往这个Consumer。自定义分发策略代码如下所示：</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class ClientIdFilterDispatchPolicy extends SimpleDispatchPolicy &#123;</span><br><span class="line">    private String ptpClientId = &quot;PTP_CLIENTID&quot;;</span><br><span class="line">    private String ptpSuffix = &quot;.PTP&quot;;</span><br><span class="line"></span><br><span class="line">    public boolean dispatch(MessageReference node, MessageEvaluationContext msgContext, List&lt;Subscription&gt; consumers) throws Exception &#123;</span><br><span class="line">        Object _clientId = node.getMessage().getProperty(this.ptpClientId);</span><br><span class="line">        if (_clientId == null) super.dispatch(node, msgContext, consumers);</span><br><span class="line"></span><br><span class="line">        ActiveMQDestination _destination = node.getMessage().getDestination();</span><br><span class="line"></span><br><span class="line">        int count = 0;</span><br><span class="line">        for (Subscription sub : consumers) &#123;</span><br><span class="line">            if (!sub.getConsumerInfo().isBrowser()) &#123;</span><br><span class="line">                if (!sub.matches(node, msgContext)) &#123;</span><br><span class="line">                    sub.unmatched(node);</span><br><span class="line">                &#125; else if ((_clientId != null) &amp;&amp; (_destination.isTopic()) &amp;&amp; (_clientId.equals(sub.getContext().getClientId())) &amp;&amp; (_destination.getQualifiedName().endsWith(this.ptpSuffix))) &#123;</span><br><span class="line">                    sub.add(node);</span><br><span class="line">                    count++;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    sub.unmatched(node);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return count &gt; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getPtpClientId() &#123;</span><br><span class="line">        return this.ptpClientId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPtpClientId(String ptpClientId) &#123;</span><br><span class="line">        this.ptpClientId = ptpClientId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getPtpSuffix() &#123;</span><br><span class="line">        return this.ptpSuffix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPtpSuffix(String ptpSuffix) &#123;</span><br><span class="line">        this.ptpSuffix = ptpSuffix;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从代码中可以看出，若消息中包含属性ptpClientId（默认属性名为“PTP_CLIENTID”）且Topic的后缀为ptpSuffix（默认后缀为“.PTP”），则判断是否有Consumer，其id与ptpClientId属性值相等，若有，则将该消息分发给该Consumer。在conf/activemq.xml中配置分发策略，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;destinationPolicy&gt;</span><br><span class="line">    &lt;policyMap&gt;</span><br><span class="line">        &lt;policyEntries&gt;</span><br><span class="line">            &lt;policyEntry topic=&quot;&gt;&quot; &gt;</span><br><span class="line">                &lt;dispatchPolicy&gt;</span><br><span class="line">                    &lt;clientIdFilterDispatchPolicy ptpSuffix=&quot;.push&quot; ptpClientId=&quot;machineId&quot; /&gt;</span><br><span class="line">                &lt;/dispatchPolicy&gt;</span><br><span class="line">                &lt;pendingMessageLimitStrategy&gt;</span><br><span class="line">                    &lt;constantPendingMessageLimitStrategy limit=&quot;1000&quot;/&gt;</span><br><span class="line">                &lt;/pendingMessageLimitStrategy&gt;</span><br><span class="line">            &lt;/policyEntry&gt;</span><br><span class="line">        &lt;/policyEntries&gt;</span><br><span class="line">    &lt;/policyMap&gt;</span><br><span class="line">&lt;/destinationPolicy&gt;</span><br></pre></td></tr></table></figure></p>
<p>从中可以看出，ptpClientId取值为“machineId”，ptpSuffix取值为“.push”。</p>
<h2 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a>消息发送</h2><p>评论消息发送端代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class PushProducer &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(PushProducer.class);</span><br><span class="line"></span><br><span class="line">    private String brokerUrl;</span><br><span class="line">    private Connection connection;</span><br><span class="line">    private Session session;</span><br><span class="line">    private MessageProducer messageProducer;</span><br><span class="line"></span><br><span class="line">    public void init() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(brokerUrl);</span><br><span class="line">            connection = connectionFactory.createConnection();</span><br><span class="line">            connection.start();</span><br><span class="line">            session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            Destination destination = session.createTopic(Constants.PUSH_TOPIC_NAME);</span><br><span class="line">            messageProducer = session.createProducer(destination);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(&quot;init producer error&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void destroy() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (session != null) &#123;</span><br><span class="line">                session.close();</span><br><span class="line">            &#125;</span><br><span class="line">            if (connection != null) &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(&quot;destroy producer error&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean pushToOne(String text, int machineId) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Message message = session.createTextMessage(text);</span><br><span class="line">            message.setStringProperty(Constants.PUSH_CLIENT_ID_KEY, String.valueOf(machineId));</span><br><span class="line">            messageProducer.send(message);</span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(&quot;push message error&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean pushToAll(String text) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Message message = session.createTextMessage(text);</span><br><span class="line">            messageProducer.send(message);</span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(&quot;push message error&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getBrokerUrl() &#123;</span><br><span class="line">        return brokerUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setBrokerUrl(String brokerUrl) &#123;</span><br><span class="line">        this.brokerUrl = brokerUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Connection getConnection() &#123;</span><br><span class="line">        return connection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setConnection(Connection connection) &#123;</span><br><span class="line">        this.connection = connection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Session getSession() &#123;</span><br><span class="line">        return session;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSession(Session session) &#123;</span><br><span class="line">        this.session = session;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public MessageProducer getMessageProducer() &#123;</span><br><span class="line">        return messageProducer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMessageProducer(MessageProducer messageProducer) &#123;</span><br><span class="line">        this.messageProducer = messageProducer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中：<br>1）init方法使用JMS API建立与ActiveMQ的连接与会话，并创建MessageProducer实例。<br>2）destroy方法关闭与ActiveMQ的连接与会话。<br>3）pushToOne方法创建文本消息包含评论，并设置属性“machineId”，使用MessageProducer实例发送消息。<br>4）pushToAll方法创建文本消息包含评论，使用MessageProducer实例发送消息。</p>
<h2 id="消息接收"><a href="#消息接收" class="headerlink" title="消息接收"></a>消息接收</h2><p>评论消息接收端代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public abstract class AuthPushConsumer implements MqttCallback &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(AuthPushConsumer.class);</span><br><span class="line"></span><br><span class="line">    private String brokerUrl;</span><br><span class="line">    private MqttClient mqttClient;</span><br><span class="line">    private int machineId;</span><br><span class="line">    private String password;</span><br><span class="line"></span><br><span class="line">    public AuthPushConsumer() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    public AuthPushConsumer(String brokerUrl, int machineId, String password) &#123;</span><br><span class="line">        this.brokerUrl = brokerUrl;</span><br><span class="line">        this.machineId = machineId;</span><br><span class="line">        this.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void start() throws Exception &#123;</span><br><span class="line">        mqttClient = new MqttClient(brokerUrl, String.valueOf(machineId), new MemoryPersistence());</span><br><span class="line">        MqttConnectOptions options= new MqttConnectOptions();</span><br><span class="line">        options.setCleanSession(true);</span><br><span class="line">        options.setKeepAliveInterval(30);</span><br><span class="line">        options.setUserName(String.valueOf(machineId));</span><br><span class="line">        options.setPassword(password.toCharArray());</span><br><span class="line">        mqttClient.setCallback(this);</span><br><span class="line">        mqttClient.connect(options);</span><br><span class="line">        mqttClient.subscribe(new String[]&#123;Constants.PUSH_TOPIC_NAME, String.valueOf(machineId)&#125;);</span><br><span class="line">        logger.info(&quot;start mqtt client success&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void connectionLost(Throwable throwable) &#123;</span><br><span class="line">        logger.error(&quot;lost connection&quot;);</span><br><span class="line">        if (mqttClient != null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                mqttClient.close();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                logger.error(&quot;close error&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                start();</span><br><span class="line">                break;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                logger.error(&quot;exception&quot;, e);</span><br><span class="line">                if (e.getCause() instanceof ConnectException || &quot;代理程序不可用&quot;.equals(e.getMessage())) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        Thread.sleep(2000);</span><br><span class="line">                    &#125; catch (Exception e1) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void deliveryComplete(IMqttDeliveryToken iMqttDeliveryToken) &#123;</span><br><span class="line">        logger.info(&quot;delivery complete&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void messageArrived(String s, MqttMessage mqttMessage) throws Exception &#123;</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        processMessage(new String(mqttMessage.getPayload()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public abstract void processMessage(String message);</span><br><span class="line"></span><br><span class="line">    public int getMachineId() &#123;</span><br><span class="line">        return machineId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMachineId(int machineId) &#123;</span><br><span class="line">        this.machineId = machineId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getPassword() &#123;</span><br><span class="line">        return password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPassword(String password) &#123;</span><br><span class="line">        this.password = password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中：<br>1）start方法创建MqttClient实例，建立与ActiveMQ的连接，创建时指定id。<br>2）connectionLost方法在连接丢失时被调用，循环调用start方法直至连接恢复。<br>3）messageArrived方法在消息接收时被调用，调用processMessage方法执行具体的业务逻辑，例如在屏幕上显示评论。</p>
<h2 id="权限验证"><a href="#权限验证" class="headerlink" title="权限验证"></a>权限验证</h2><p>为了验证尝试连接的Consumer是否具有权限，开发了权限验证插件，该插件调用远程接口进行权限验证。插件配置如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;plugins&gt;</span><br><span class="line">    &lt;bean xmlns=&quot;http://www.springframework.org/schema/beans&quot; id=&quot;AuthPlugin&quot; class=&quot;com.vshangping.server.activemq.auth.plugin.AuthPlugin&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;machineService&quot;&gt;</span><br><span class="line">            &lt;bean xmlns=&quot;http://www.springframework.org/schema/beans&quot; id=&quot;machineService&quot; name=&quot;machineService&quot; class=&quot;org.springframework.remoting.caucho.HessianProxyFactoryBean&quot;&gt;</span><br><span class="line">                &lt;property name=&quot;serviceUrl&quot; value=&quot;http://xxx.xxx.xxx.xxx/remoting/machineService&quot; /&gt;</span><br><span class="line">                &lt;property name=&quot;serviceInterface&quot; value=&quot;xxx.xxx.server.service.MachineService&quot; /&gt;</span><br><span class="line">                &lt;property name=&quot;chunkedPost&quot; value=&quot;false&quot;/&gt;</span><br><span class="line">            &lt;/bean&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/plugins&gt;</span><br></pre></td></tr></table></figure></p>
<p>插件AuthPlugin代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class AuthPlugin implements BrokerPlugin &#123;</span><br><span class="line"></span><br><span class="line">	private static Logger logger = LoggerFactory.getLogger(AuthPlugin.class);</span><br><span class="line"></span><br><span class="line">	private MachineService machineService;</span><br><span class="line"></span><br><span class="line">	public Broker installPlugin(Broker broker) throws Exception &#123;</span><br><span class="line">		logger.info(&quot;install auth plugin&quot;);</span><br><span class="line">		return new AuthBroker(broker, machineService);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public MachineService getMachineService() &#123;</span><br><span class="line">		return machineService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setMachineService(MachineService machineService) &#123;</span><br><span class="line">		this.machineService = machineService;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从代码中可以看出，该插件主要功能是新建并返回AuthBroker实例，AuthBroker代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class AuthBroker extends BrokerFilter &#123;</span><br><span class="line"></span><br><span class="line">	private static Logger logger = LoggerFactory.getLogger(AuthBroker.class);</span><br><span class="line"></span><br><span class="line">	private MachineService machineService;</span><br><span class="line"></span><br><span class="line">	public AuthBroker(Broker next) &#123;</span><br><span class="line">		super(next);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public AuthBroker(Broker next, MachineService machineService) &#123;</span><br><span class="line">		super(next);</span><br><span class="line">		this.machineService = machineService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void addConnection(ConnectionContext context, ConnectionInfo info) throws Exception &#123;</span><br><span class="line">		if (context.getConnector().toString().equals(&quot;mqtt&quot;)) &#123;</span><br><span class="line">			if (!machineService.checkPassword(Integer.parseInt(info.getUserName()), info.getPassword())) &#123;</span><br><span class="line">				throw new SecurityException(&quot;invalid machine &quot; + info.getUserName());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		logger.info(&quot;connect machine &quot; + info.getUserName());</span><br><span class="line">		super.addConnection(context, info);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public MachineService getMachineService() &#123;</span><br><span class="line">		return machineService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setMachineService(MachineService machineService) &#123;</span><br><span class="line">		this.machineService = machineService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从代码中可以看出，AuthBroker继承自BrokerFilter，重写了addConnection方法，在创建连接时，对于使用MQTT协议的连接，调用远程接口的checkPassword方法，判断账号和密码是否正确，若正确则允许连接。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/03/e4-bd-bf-e7-94-a8hive-e5-ad-98-e5-82-a8-e6-95-b0-e6-8d-ae-e5-ae-9e-e8-b7-b5/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/01/03/e4-bd-bf-e7-94-a8hive-e5-ad-98-e5-82-a8-e6-95-b0-e6-8d-ae-e5-ae-9e-e8-b7-b5/" itemprop="url">使用Hive存储数据实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-01-03T16:51:48+08:00">
                2016-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>数据存储需求是：每天会生成大量文章数据，每条文章数据包含标题、内容、URL、发表时间等多个字段，数据后续不会更新，因此考虑使用Hive作为数据仓库存储这些数据。以下介绍使用Hive存储数据的实践步骤以及注意事项。</p>
<h2 id="1-创建表"><a href="#1-创建表" class="headerlink" title="1.创建表"></a>1.创建表</h2><p>创建外部表toutiao_category，建表语句如下所示，使用外部表是为了考虑数据存储的灵活性，对于外部表，若后续删除表，仅删除表元数据，不会删除表数据，可以继续读取数据进行分析。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">CREATE EXTERNAL TABLE `toutiao_category`(                                      </span><br><span class="line">  `toutiao_has_mp4_video` int,                                                 </span><br><span class="line">  `toutiao_repin_count` int,                                                   </span><br><span class="line">  `abstract` string,                                                           </span><br><span class="line">  `article_ptime` int,                                                         </span><br><span class="line">  `toutiao_recommend` int,                                                     </span><br><span class="line">  `toutiao_article_type` int,                                                  </span><br><span class="line">  `category` string,                                                           </span><br><span class="line">  `docid` bigint,                                                              </span><br><span class="line">  `bury_count` int,                                                            </span><br><span class="line">  `title` string,                                                              </span><br><span class="line">  `content` string,                                                            </span><br><span class="line">  `source` string,                                                             </span><br><span class="line">  `comment_count` int,                                                         </span><br><span class="line">  `article_url` string,                                                        </span><br><span class="line">  `toutiao_middle_mode` string,                                                </span><br><span class="line">  `toutiao_datetime` string,                                                   </span><br><span class="line">  `toutiao_aggr_type` int,                                                     </span><br><span class="line">  `toutiao_article_sub_type` int,                                              </span><br><span class="line">  `toutiao_external_visit_count` int,                                          </span><br><span class="line">  `ctime` int,                                                                 </span><br><span class="line">  `toutiao_favorite_count` int,                                                </span><br><span class="line">  `toutiao_impression_count` int,                                              </span><br><span class="line">  `toutiao_keywords` string,                                                   </span><br><span class="line">  `digg_count` int,                                                            </span><br><span class="line">  `toutiao_more_mode` string,                                                  </span><br><span class="line">  `toutiao_go_detail_count` int,                                               </span><br><span class="line">  `origin_url` string)                                                         </span><br><span class="line">PARTITIONED BY (                                                               </span><br><span class="line">  `date` string)                                                               </span><br><span class="line">ROW FORMAT DELIMITED                                                           </span><br><span class="line">  FIELDS TERMINATED BY &apos;\t&apos;                                                    </span><br><span class="line">  LINES TERMINATED BY &apos;\n&apos;                                                     </span><br><span class="line">STORED AS INPUTFORMAT                                                          </span><br><span class="line">  &apos;com.hadoop.mapred.DeprecatedLzoTextInputFormat&apos;                                   </span><br><span class="line">OUTPUTFORMAT                                                                   </span><br><span class="line">  &apos;org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat&apos;                 </span><br><span class="line">LOCATION                                                                       </span><br><span class="line">  &apos;hdfs://heracles/user/mediadata/hive/warehouse/news/toutiao_category&apos;;</span><br></pre></td></tr></table></figure></p>
<p>建表语句中：<br>1）“PARTITIONED BY (<code>date</code> string)”是按照天进行分区，类似于关系数据库中的分表操作，这样在实际存储表数据时，某一天的数据会单独存储于某个目录下，查询条件包含天时，就会只读取满足条件的天所对应目录下的数据，这样可以加快查询速度；<br>2）“ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’ LINES TERMINATED BY ‘\n’”表示对于存储的数据，按照“\n”划分成行，并对于行，按照“\t”划分出字段，划分出的字段的个数、顺序、属性应与建表语句中的字段说明一致；<br>3）“STORED AS INPUTFORMAT ‘com.hadoop.mapred.DeprecatedLzoTextInputFormat’”，因为数据采用LZO算法压缩，所以存储格式指定为“com.hadoop.mapred.DeprecatedLzoTextInputFormat”；<br>4）“LOCATION ‘hdfs://heracles/user/mediadata/hive/warehouse/crawl_news/toutiao_category’”表示数据在HDFS中存储的根目录。</p>
<h2 id="2-压缩数据"><a href="#2-压缩数据" class="headerlink" title="2.压缩数据"></a>2.压缩数据</h2><p>按行并且每行按照“\t”分割字段导出某一天的文章数据，并使用lzop命令压缩数据：<br>[blockquote]lzop toutiao_category_20160101.txt -odata.lzo[/blockquote]<br>压缩后的数据文件和原有文件相比，大小可以减小50%左右，节约了存储空间。</p>
<h2 id="3-导入数据"><a href="#3-导入数据" class="headerlink" title="3.导入数据"></a>3.导入数据</h2><p>公司集群中的Hive采用BeeLine连接Hive Server，使用BeeLine向toutiao_category表导入数据：<br>[blockquote]/usr/lib/hive/bin/beeline -u “jdbc:hive2://xxx.xxx.xxx.xxx:xxx/mediadata_news;principal=xxx” -e “load data local inpath ‘/data/rsync_dir/news/data.lzo’ overwrite into table toutiao_category partition (date=’20160101’);”[/blockquote]<br>执行后，本地文件“/data/rsync_dir/news/data.lzo”被导入到toutiao_category表的“20160101”分区中：<br>[blockquote]/user/mediadata/hive/warehouse/crawl_news/toutiao_category/date=20160101/data.lzo[/blockquote]</p>
<h2 id="4-为压缩数据创建索引"><a href="#4-为压缩数据创建索引" class="headerlink" title="4.为压缩数据创建索引"></a>4.为压缩数据创建索引</h2><p>对Hive表进行查询时，Hive实际上是将查询SQL转化为MapReduce Job，而对于导入到toutiao_category表的data.lzo文件，由于其是lzo格式，因此MapReduce Job在读取、分析该文件时，只会分配一个Mapper任务，因此为了提高查询速度，对lzo文件创建索引，这样MapReduce Job会对一个lzo文件分配多个Mapper任务：<br>[blockquote]hadoop jar /usr/lib/hadoop/lib/hadoop-lzo-0.6.0.jar com.hadoop.compression.lzo.LzoIndexer /user/mediadata/hive/warehouse/news/toutiao_category/date=20160101/data.lzo[/blockquote]<br>执行后，会增加index文件：<br>[blockquote]/user/mediadata/hive/warehouse/news/toutiao_category/date=20160101/data.lzo.index[/blockquote]</p>
<h2 id="5-查询数据"><a href="#5-查询数据" class="headerlink" title="5.查询数据"></a>5.查询数据</h2><p>使用BeeLine执行SQL查询：<br>[blockquote]0: jdbc:hive2://xxx.xxx.xxx.xxx:xxx/mediadata_n&gt; select ctime from toutiao_category where date=20160101 limit 10;<br>+————-+<br>|    ctime    |<br>+————-+<br>| 1451663999  |<br>| 1451663998  |<br>| 1451663980  |<br>| 1451663967  |<br>| 1451663956  |<br>| 1451663956  |<br>| 1451663955  |<br>| 1451663945  |<br>| 1451663933  |<br>| 1451663933  |<br>+————-+<br>10 rows selected (19.087 seconds)[/blockquote]</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/12/06/e5-9f-ba-e4-ba-8ejenkinsmavengit-e5-ae-9e-e7-8e-b0-e8-87-aa-e5-8a-a8-e5-8c-96-e6-9e-84-e5-bb-ba-e5-92-8c-e9-83-a8-e7-bd-b2/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/12/06/e5-9f-ba-e4-ba-8ejenkinsmavengit-e5-ae-9e-e7-8e-b0-e8-87-aa-e5-8a-a8-e5-8c-96-e6-9e-84-e5-bb-ba-e5-92-8c-e9-83-a8-e7-bd-b2/" itemprop="url">基于Jenkins+Maven+Git实现自动化构建和部署</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-06T16:38:18+08:00">
                2015-12-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="安装jdk1-7"><a href="#安装jdk1-7" class="headerlink" title="安装jdk1.7"></a>安装jdk1.7</h2><p><strong>1）下载jdk-7u79-linux-x64.tar.gz至/usr/local目录，解压并创建软连接：</strong><br>[blockquote]tar -zxvf jdk-7u79-linux-x64.tar.gz<br>ln -s jdk1.7.0_79 jdk[/blockquote]<br><strong>2）在/etc/profile中增加环境变量：</strong><br>[blockquote]export JAVA_HOME=/usr/local/jdk<br>export CLASSPATH=./:$JAVA_HOME/lib:$JAVA_HOME/lib/tools.jar<br>export PATH=$JAVA_HOME/bin:$PATH[/blockquote]<br><strong>3）重新打开shell，输入“java -version”，如下图所示，说明jdk1.7安装成功。</strong><br><a href="http://magicwt.com/wp-content/uploads/2015/08/11.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/08/11-300x32.png" alt="1"></a></p>
<h2 id="安装Maven"><a href="#安装Maven" class="headerlink" title="安装Maven"></a>安装Maven</h2><p><strong>1）下载apache-maven-3.3.9-bin.tar.gz至/usr/local目录，解压并创建软连接：</strong><br>[blockquote]tar -zxvf apache-maven-3.3.9-bin.tar.gz<br>ln -s apache-maven-3.3.9 maven[/blockquote]<br><strong>2）在/etc/profile中增加环境变量：</strong><br>[blockquote]export M2_HOME=/usr/local/maven<br>export M2=$M2_HOME/bin<br>export PATH=$M2:$PATH[/blockquote]<br><strong>3）Maven默认本地库地址是用户目录下的.m2/repository，可以通过修改用户目录下的.m2/settings.xml或Maven安装目录下的conf/settings.xml来修改本地库地址：</strong><br>[blockquote]<localrepository>/usr/local/maven/repo</localrepository>[/blockquote]<br>.m2/settings.xml优先级高于conf/settings.xml，.m2/settings.xml适用于某个用户，conf/settings.xml适用于所有用户。<br><strong>4）重新打开shell，输入“mvn -version”，如下图所示，说明Maven安装成功。</strong><br><a href="http://magicwt.com/wp-content/uploads/2015/12/14.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/14-300x42.png" alt="1"></a></p>
<h2 id="安装Git"><a href="#安装Git" class="headerlink" title="安装Git"></a>安装Git</h2><p><strong>1）直接使用yum方式安装：</strong><br>[blockquote]yum install git[/blockquote]<br><strong>2）安装后输入“git”，如下图所示，说明Git安装成功。</strong><br><a href="http://magicwt.com/wp-content/uploads/2015/12/15.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/15-300x26.png" alt="1"></a></p>
<h2 id="安装启动Jenkins"><a href="#安装启动Jenkins" class="headerlink" title="安装启动Jenkins"></a>安装启动Jenkins</h2><p>下载Jenkins.war，可以将该war包置于Web应用容器（如Tomcat）的应用目录下，通过Tomcat启动Jenkins，也可以直接使用“java -jar”启动Jenkins，使用Jetty作为Web应用容器。<br>启动前，需要在/etc/profile增加Jenkins的环境变量：<br>[blockquote]export JENKINS_HOME=/usr/local/jenkins[/blockquote]<br>使用如下命令启动Jenkins：<br>[blockquote]nohup java -jar /usr/local/jenkins.war &amp;[/blockquote]<br>Jenkins默认使用8080端口，在浏览器下打开如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/12/16.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/16-300x196.png" alt="1"></a></p>
<h2 id="配置Jenkins"><a href="#配置Jenkins" class="headerlink" title="配置Jenkins"></a>配置Jenkins</h2><p><strong>1）配置用户登录</strong><br>在“系统管理-&gt;Configure Global Security”中设置“启用安全”，如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/12/17.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/17-300x256.png" alt="1"></a><br>安全域可以选择“Jenkins专有用户数据库”，并允许用户注册。<br>保存后页面右上角会出现“注册”选项，注册用户后再进入“系统管理-&gt;Configure Global Security”，设置用户的授权策略，如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/12/18.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/18-300x179.png" alt="1"></a><br>授权策略可以选择“安全矩阵”，取消匿名用户的所有权限，为“test”用户赋予所有权限。<br><strong>2）安装Git插件</strong><br>Jenkins默认没有安装Git插件，可以在“系统管理-&gt;管理插件”中选择Git插件进行安装，如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/12/19.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/19-300x37.png" alt="1"></a><br><strong>3）配置jdk和Maven</strong><br>在“系统管理-&gt;系统设置”中配置jdk和Maven，如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/12/111.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/111-300x87.png" alt="1"></a><br><a href="http://magicwt.com/wp-content/uploads/2015/12/110.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/110-300x85.png" alt="1"></a></p>
<h2 id="自动构建和部署项目"><a href="#自动构建和部署项目" class="headerlink" title="自动构建和部署项目"></a>自动构建和部署项目</h2><p>web-test（<a href="https://github.com/magicwt/web-test.git）是一个Java" target="_blank" rel="noopener">https://github.com/magicwt/web-test.git）是一个Java</a> Web项目，使用Maven构建，代码托管在GitHub上，使用Jenkins进行自动构建和部署。<br><strong>1）新建项目</strong><br>选择“构建一个maven项目”，如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/12/112.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/112-300x136.png" alt="1"></a><br><strong>2）Git配置</strong><br>在“源码管理”中选择“Git”，并输入项目的GitHub库地址（事先需要将Jenkins所在服务器的公钥添加到项目的“Deploy Keys”中），如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/12/113.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/113-300x253.png" alt="1"></a><br><strong>3）Maven配置</strong><br>在“构建触发器-&gt;Build”中设置Maven构建目标和选项，在“构建触发器-&gt;Post Steps”中设置构建成功后执行的Shell，Shell的功能是通过scp命令将war包拷贝至部署服务器，解压并重启Web应用进程，如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/12/114.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/114-300x153.png" alt="1"></a><br>Shell代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#!/bin/sh</span><br><span class="line">hudson_basedir=/usr/local/jenkins/workspace/web-test/</span><br><span class="line">module_name=web-test</span><br><span class="line">war_name=test</span><br><span class="line">ip=xxx.xxx.xxx.xxx</span><br><span class="line">resin_sh=/usr/local/resin/bin/httpd_test.sh</span><br><span class="line">webapp_dir=/opt/app</span><br><span class="line">war_source=$hudson_basedir/target/$war_name.war</span><br><span class="line">war_goal=$webapp_dir/$war_name.war</span><br><span class="line">war_goal_dir=$webapp_dir/$war_name</span><br><span class="line">user=root</span><br><span class="line"></span><br><span class="line">function deploy()&#123;     </span><br><span class="line">    echo &quot; ---------------------------- stop resin in $&#123;ip&#125;  ...&quot;</span><br><span class="line">    ssh $&#123;user&#125;@$&#123;ip&#125; &quot;$resin_sh stop&quot;;</span><br><span class="line">    while [ `ssh $&#123;user&#125;@$&#123;ip&#125;  &quot; $resin_sh status | grep java.net.ConnectException | wc -l  &quot; `  = &quot;0&quot; ];do</span><br><span class="line">        echo &quot;waiting for resin stop &quot;</span><br><span class="line">        sleep 1</span><br><span class="line">    done;</span><br><span class="line">    echo &quot;stop resin ok !&quot;</span><br><span class="line">    ssh $&#123;user&#125;@$&#123;ip&#125; &quot;rm -rf $war_goal_dir*&quot;;</span><br><span class="line">    scp $war_source  $&#123;user&#125;@$&#123;ip&#125;:$war_goal;</span><br><span class="line">    ssh $&#123;user&#125;@$&#123;ip&#125; &quot;unzip -oq  $war_goal -d  $war_goal_dir &quot;;</span><br><span class="line">    echo &quot;start resin  ...&quot;</span><br><span class="line">    ssh $&#123;user&#125;@$&#123;ip&#125; &quot;$resin_sh start&quot;;</span><br><span class="line">    echo &quot; ----------------------------- start resin ok !&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main()&#123;</span><br><span class="line">    deploy</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main</span><br></pre></td></tr></table></figure></p>
<p>配置完成后，点击“保存”。<br><strong>4）构建、部署项目</strong><br>在项目中，点击“立即构建”，在“Console Output”可以实时观察构建、部署过程，如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/12/115.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/115-300x194.png" alt="1"></a><br>构建、部署成功后，浏览器下访问Web应用，访问正常。<br><a href="http://magicwt.com/wp-content/uploads/2015/12/116.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/116-300x51.png" alt="1"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/12/03/e4-bd-bf-e7-94-a8pypiserver-e6-90-ad-e5-bb-bapypi-e6-9c-8d-e5-8a-a1-e5-99-a8/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/12/03/e4-bd-bf-e7-94-a8pypiserver-e6-90-ad-e5-bb-bapypi-e6-9c-8d-e5-8a-a1-e5-99-a8/" itemprop="url">使用pypiserver搭建pypi服务器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-03T16:47:22+08:00">
                2015-12-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用Python开发时，经常需要用到“pip install”安装依赖，但是“pip install”需要访问外网，并且默认源<a href="https://pypi.python.org/在国内访问并不是很稳定。为了便于在公司内网服务器上安装依赖，我们使用pypiserver搭建pypi服务器。" target="_blank" rel="noopener">https://pypi.python.org/在国内访问并不是很稳定。为了便于在公司内网服务器上安装依赖，我们使用pypiserver搭建pypi服务器。</a></p>
<h2 id="安装pypiserver"><a href="#安装pypiserver" class="headerlink" title="安装pypiserver"></a>安装pypiserver</h2><p>从<a href="https://pypi.python.org/pypi/pypiserver下载pypiserver-1.1.7.zip，解压后进入目录，执行：" target="_blank" rel="noopener">https://pypi.python.org/pypi/pypiserver下载pypiserver-1.1.7.zip，解压后进入目录，执行：</a><br>[blockquote]python setup.py install[/blockquote]<br>即可完成安装。</p>
<h2 id="启动pypiserver"><a href="#启动pypiserver" class="headerlink" title="启动pypiserver"></a>启动pypiserver</h2><p>启动命令是：<br>[blockquote]/usr/bin/pypi-server -p 8082 /opt/python-packages[/blockquote]<br>其中：<br>1）“-p 8082”，表示使用端口8082；<br>2）“/opt/python-packages”，表示依赖包的存储目录。<br>/opt/python-packages目录下的依赖包如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/12/1.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/1-300x103.png" alt="1"></a><br>在浏览器下访问如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/12/11.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/12/11-300x300.png" alt="1"></a></p>
<h2 id="使用pypiserver"><a href="#使用pypiserver" class="headerlink" title="使用pypiserver"></a>使用pypiserver</h2><p>若使用搭建的pypiserver作为源安装依赖BeautifulSoup，命令如下：<br>[blockquote]pip install BeautifulSoup -i http://ip:port/simple/[/blockquote]</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/11/28/e5-89-8d-e7-ab-af-e5-8c-85-e7-ae-a1-e7-90-86-e5-b7-a5-e5-85-b7bower-e7-ae-80-e4-bb-8b/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/11/28/e5-89-8d-e7-ab-af-e5-8c-85-e7-ae-a1-e7-90-86-e5-b7-a5-e5-85-b7bower-e7-ae-80-e4-bb-8b/" itemprop="url">前端包管理工具Bower简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-11-28T17:32:20+08:00">
                2015-11-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/前端/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>类似于在Java中使用Maven管理依赖，在前端可以使用Bower（<a href="http://bower.io/）管理包。类似于Maven中的pom.xml文件，Bower使用bower.json文件记录所需管理的包。" target="_blank" rel="noopener">http://bower.io/）管理包。类似于Maven中的pom.xml文件，Bower使用bower.json文件记录所需管理的包。</a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>Bower是一个命令行工具，可以使用node的npm命令进行安装：<br>[blockquote]npm install -g bower[/blockquote]<br>Bower依赖node、npm和git，所以需要先安装node和git。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h3><p>可以使用“bower install”命令安装所需要的包，格式如下：<br>[blockquote]bower install <package>[/blockquote]<br>其中package既可以直接使用包名，也可以使用包的GitHub地址，例如JQuery的安装可以使用以下命令：<br>[blockquote]# registered package<br>bower install jquery</package></p>
<h1 id="GitHub-shorthand"><a href="#GitHub-shorthand" class="headerlink" title="GitHub shorthand"></a>GitHub shorthand</h1><p>bower install jquery/jquery</p>
<h1 id="Git-endpoint"><a href="#Git-endpoint" class="headerlink" title="Git endpoint"></a>Git endpoint</h1><p>bower install git://github.com/jquery/jquery.git[/blockquote]<br>执行命令后，JQuery的相关文件会被下载到bower_components目录下。</p>
<h3 id="保存包"><a href="#保存包" class="headerlink" title="保存包"></a>保存包</h3><p>可以使用“bower init”命令保存所需要的包的信息，信息会被保存在bower.json文件中，bower.json示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  name: &apos;test&apos;,</span><br><span class="line">  authors: [</span><br><span class="line">    &apos;magicwt&apos;</span><br><span class="line">  ],</span><br><span class="line">  description: &apos;this is a tset&apos;,</span><br><span class="line">  main: &apos;index.html&apos;,</span><br><span class="line">  license: &apos;MIT&apos;,</span><br><span class="line">  homepage: &apos;http://magicwt.com&apos;,</span><br><span class="line">  ignore: [</span><br><span class="line">    &apos;**/.*&apos;</span><br><span class="line">  ],</span><br><span class="line">  dependencies: &#123;</span><br><span class="line">    jquery: &apos;~2.1.4&apos;</span><br><span class="line">  &#125;,</span><br><span class="line">  keywords: [</span><br><span class="line">    &apos;bower&apos;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="使用包"><a href="#使用包" class="headerlink" title="使用包"></a>使用包</h3><p>Bower官方建议基于Bower API，结合其他前端工具（如Grunt，RequireJS，Yeoman等）来使用所管理的包，另外，也可以在页面中直接使用已安装的包，如直接引用已安装的JQuery：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;script src=&quot;bower_components/jquery/dist/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/06/storm-kafka-kafkaspout-e5-8e-9f-e7-90-86-e5-88-86-e6-9e-90/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/10/06/storm-kafka-kafkaspout-e5-8e-9f-e7-90-86-e5-88-86-e6-9e-90/" itemprop="url">storm-kafka KafkaSpout原理分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-10-06T22:34:31+08:00">
                2015-10-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Storm-Spout"><a href="#Storm-Spout" class="headerlink" title="Storm Spout"></a>Storm Spout</h2><p>通过实现Storm中的ISpout接口，重写其中的nextTuple、ack和fail方法，可以实现tuple流的发送、成功确认、失败重发。ISpout接口代码如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public interface ISpout extends Serializable &#123;</span><br><span class="line">    /**</span><br><span class="line">      * work进程初始化spout时运行该方法</span><br><span class="line">      */</span><br><span class="line">    void open(Map conf, TopologyContext context, SpoutOutputCollector collector);</span><br><span class="line">    /**</span><br><span class="line">     * 关闭时调用，但不保证一定调用（kill -9）</span><br><span class="line">     */</span><br><span class="line">    void close();</span><br><span class="line">    /**</span><br><span class="line">     * activate topology后调用</span><br><span class="line">     */</span><br><span class="line">    void activate();</span><br><span class="line">    /**</span><br><span class="line">     * deactivate topology后调用</span><br><span class="line">     */</span><br><span class="line">    void deactivate();</span><br><span class="line">    /**</span><br><span class="line">     * 在nextTuple中通过调用collector的emit方法发送tuple</span><br><span class="line">     * nextTuple、ack和fail这三个方法在一个线程中被循环调用</span><br><span class="line">     */</span><br><span class="line">    void nextTuple();</span><br><span class="line">    /**</span><br><span class="line">     * msgId标识的消息处理成功后调用该方法</span><br><span class="line">     */</span><br><span class="line">    void ack(Object msgId);</span><br><span class="line">    /**</span><br><span class="line">     * msgId标识的消息处理失败后调用该方法</span><br><span class="line">     * 可以进行消息的重新发送</span><br><span class="line">     */</span><br><span class="line">    void fail(Object msgId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="storm-kafka"><a href="#storm-kafka" class="headerlink" title="storm-kafka"></a>storm-kafka</h2><p>storm-kafka模块目前集成中在storm（<a href="https://github.com/apache/storm）中，为storm提供读取kafka消息队列的支持，其中，KafkaSpout类继承自BaseRichSpout类，用于从kafka消息队列中读取消息发送tuple，对tuple进行成功确认和失败重发，保证kafka消息至少被处理一次。" target="_blank" rel="noopener">https://github.com/apache/storm）中，为storm提供读取kafka消息队列的支持，其中，KafkaSpout类继承自BaseRichSpout类，用于从kafka消息队列中读取消息发送tuple，对tuple进行成功确认和失败重发，保证kafka消息至少被处理一次。</a></p>
<h2 id="KafkaSpout"><a href="#KafkaSpout" class="headerlink" title="KafkaSpout"></a>KafkaSpout</h2><p>KafkaSpout类核心逻辑的序列图如下所示。<br><a href="http://magicwt.com/wp-content/uploads/2015/11/序列图.gif" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/序列图-300x223.gif" alt="序列图"></a><br>从中可以看出，发送tuple，成功确认和失败重发都是由PartitionManager这个类完成。<br>在storm中，可以设置spout的并行度，也就是说可以有多个KafkaSpout实例从一个kafka队列中读取消息，而kafka作为大数据应用场景下的消息队列，其每个队列可以配置为多个partition，每个partition可以由一个消费者读取消息，这样可以保证消息消费的大吞吐量。当在storm集群中使用KafkaSpout类读取消息时，需要控制每个KafkaSpout实例读取kafka队列的哪几个partition，如果实例数等于partition数，那么每个KafkaSpout实例从一个partiton中读取消息。<br>在KafkaSpout类中有一个成员变量PartitionCoordinator _coordinator，_coordinator中有一个成员变量Map&lt;Partition, PartitionManager&gt; _managers。通过在zookeeper上保存信息，_coordinator可以在storm集群中协调各个KafkaSpout实例读取哪几个partition，并通过_managers管理当前所在KafkaSpout实例负责的partition的读取，而PartitionManager类则具体负责某个partition的读取。<br>当KafkaSpout实例执行nextTuple方法时，会从_coordinator中获取到PartitonManager实例，并调用该实例的next方法，而当KafkaSpout实例执行ack方法时，实际调用了PartitonManager的ack方法，而当KafkaSpout实例执行fail方法时，实际调用了PartitonManager的fail方法。PartitionManager的next、ack和fail方法具体流程如下所示。<br><a href="http://magicwt.com/wp-content/uploads/2015/11/next.gif" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/next-290x300.gif" alt="next"></a><br><a href="http://magicwt.com/wp-content/uploads/2015/11/ack.gif" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/ack-212x300.gif" alt="ack"></a><br><a href="http://magicwt.com/wp-content/uploads/2015/11/fail.gif" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/11/fail-175x300.gif" alt="fail"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/01/e4-bd-bf-e7-94-a8daemontools-e5-ae-9e-e7-8e-b0storm-e8-bf-9b-e7-a8-8b-e7-9b-91-e6-8e-a7/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/10/01/e4-bd-bf-e7-94-a8daemontools-e5-ae-9e-e7-8e-b0storm-e8-bf-9b-e7-a8-8b-e7-9b-91-e6-8e-a7/" itemprop="url">使用daemontools实现Storm进程监控</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-10-01T19:18:01+08:00">
                2015-10-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Storm集群如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2015/10/图片1.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/10/图片1-300x148.png" alt="图片1"></a><br>其中包含一个nimbus节点和多个supervisor节点：<br>1）nimbus，负责在集群中分发代码，分配计算任务，监控失败等；<br>2）supervisor，负责在集群中按照nimbus的分配，启动和停止计算任务；<br>3）worker，实际执行spout和bolt任务的进程；<br>在Storm安装目录下，可通过执行以下命令启动nimbus和supervisor进程（需先安装Python）：<br>[blockquote]bin/storm nimbus|supervisor[/blockquote]<br>nimbus和supervisor进程都是无状态和fail-fast的，状态保存在zookeeper和本地磁盘，当任何一个进程失败时，通过重启进程，可以快速恢复。Storm官方建议使用daemontools（<a href="http://cr.yp.to/daemontools.html）监控nimbus和supervisor进程，当有进程失败时，daemontools可以重启进程。" target="_blank" rel="noopener">http://cr.yp.to/daemontools.html）监控nimbus和supervisor进程，当有进程失败时，daemontools可以重启进程。</a></p>
<h2 id="安装daemontools"><a href="#安装daemontools" class="headerlink" title="安装daemontools"></a>安装daemontools</h2><p>摘自<a href="http://cr.yp.to/daemontools/install.html。" target="_blank" rel="noopener">http://cr.yp.to/daemontools/install.html。</a><br>1）创建/package目录:<br>[blockquote]mkdir -p /package<br>chmod 1755 /package<br>cd /package[/blockquote]<br>2）下载daemontools-0.76.tar.gz至/package，解压：<br>[blockquote]gunzip daemontools-0.76.tar<br>tar -xpf daemontools-0.76.tar<br>rm -f daemontools-0.76.tar<br>cd admin/daemontools-0.76[/blockquote]<br>3）编译、启动daemontools:<br>[blockquote]package/install[/blockquote]<br>daemontools会启动2个进程：<br><a href="http://magicwt.com/wp-content/uploads/2015/10/1.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/10/1-300x15.png" alt="1"></a><br>其中svscan默认扫描/service目录，可以在/service中配置需要监控的进程。daemontools使用supervise命令启动需要监控的进程，并在进程失败时，重启进程。</p>
<h2 id="启动nimbus和supervisor进程"><a href="#启动nimbus和supervisor进程" class="headerlink" title="启动nimbus和supervisor进程"></a>启动nimbus和supervisor进程</h2><h3 id="启动nimbus进程"><a href="#启动nimbus进程" class="headerlink" title="启动nimbus进程"></a>启动nimbus进程</h3><p>在nimbus节点的/service目录，创建nimbus和ui子目录，并在nimbus和ui目录中分别创建名称为run的脚本。<br>nimbus目录中的run脚本为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#!/bin/sh</span><br><span class="line">. /etc/profile</span><br><span class="line">/usr/local/bin/python2.7 /opt/software/storm/bin/storm nimbus</span><br></pre></td></tr></table></figure></p>
<p>ui目录中的run脚本为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#!/bin/sh</span><br><span class="line">. /etc/profile</span><br><span class="line">/usr/local/bin/python2.7 /opt/software/storm/bin/storm ui</span><br></pre></td></tr></table></figure></p>
<p>run脚本其实就是使用storm命令启动nimbus和ui进程。<br>daemontools扫描到上述配置后，使用supervise命令执行run脚本，启动nimbus和ui进程：<br><a href="http://magicwt.com/wp-content/uploads/2015/10/11.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/10/11-300x17.png" alt="1"></a><br><a href="http://magicwt.com/wp-content/uploads/2015/10/12.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/10/12-300x127.png" alt="1"></a></p>
<h3 id="启动supervisor进程"><a href="#启动supervisor进程" class="headerlink" title="启动supervisor进程"></a>启动supervisor进程</h3><p>与nimbus节点类似，在supervisor节点的/service目录，创建supervisor子目录，并在supervisor目录中创建名称为run的脚本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#!/bin/sh</span><br><span class="line">. /etc/profile</span><br><span class="line">/usr/local/bin/python2.7 /opt/software/storm/bin/storm supervisor</span><br></pre></td></tr></table></figure></p>
<p>配置完成后，可以通过ui看到所有节点已启动：<br><a href="http://magicwt.com/wp-content/uploads/2015/10/3_副本.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2015/10/3_副本-300x178.png" alt="3_副本"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">magicwt</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">90</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">49</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/magicwt" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:wang-t04@mails.tsinghua.edu.cn" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">magicwt</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
