<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="magicwt的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="magicwt的博客">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="magicwt的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>magicwt的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">magicwt的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/29/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/29/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-29T23:01:01+08:00">
                2018-11-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/18/e5-9f-ba-e4-ba-8ewebsocket-e5-ae-9e-e7-8e-b0-e5-be-ae-e4-bf-a1-e5-b0-8f-e7-a8-8b-e5-ba-8f-e7-9a-84-e6-b6-88-e6-81-af-e6-8e-a8-e9-80-81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/18/e5-9f-ba-e4-ba-8ewebsocket-e5-ae-9e-e7-8e-b0-e5-be-ae-e4-bf-a1-e5-b0-8f-e7-a8-8b-e5-ba-8f-e7-9a-84-e6-b6-88-e6-81-af-e6-8e-a8-e9-80-81/" itemprop="url">基于WebSocket实现微信小程序的消息推送</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-18T17:33:58+08:00">
                2017-03-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>微信小程序支持通过基于WebSocket进行消息推送，提供了相应的API，例如创建连接示例代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wx.connectSocket(&#123;</span><br><span class="line">  url: &apos;test.php&apos;,</span><br><span class="line">  data:&#123;</span><br><span class="line">    x: &apos;&apos;,</span><br><span class="line">    y: &apos;&apos;</span><br><span class="line">  &#125;,</span><br><span class="line">  header:&#123; </span><br><span class="line">    &apos;content-type&apos;: &apos;application/json&apos;</span><br><span class="line">  &#125;,</span><br><span class="line">  method:&quot;GET&quot;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>API详细说明可参见：<a href="https://mp.weixin.qq.com/debug/wxadoc/dev/api/network-socket.html#wxconnectsocketobject，这里主要讲解服务端如何实现基于WebSocket的消息推送。" target="_blank" rel="noopener">https://mp.weixin.qq.com/debug/wxadoc/dev/api/network-socket.html#wxconnectsocketobject，这里主要讲解服务端如何实现基于WebSocket的消息推送。</a><br>服务端整体部署架构为Nginx+Tomcat，因为微信小程序要求使用WSS协议进行通信，因此，需要配置Nginx支持SSL，可以通过阿里云的证书服务申请免费证书：<br><a href="http://magicwt.com/wp-content/uploads/2017/03/证书申请.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2017/03/证书申请-300x169.png" alt=""></a><br>按照提示操作即可，证书申请成功后，在Nginx中配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">upstream websocket-server &#123;</span><br><span class="line">    server 127.0.0.1:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name  xxx.com;</span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_certificate /usr/local/nginx/conf/server.pem;</span><br><span class="line">    ssl_certificate_key /usr/local/nginx/conf/server.key;</span><br><span class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line"></span><br><span class="line">    location ^~/websocket/ &#123;</span><br><span class="line">        proxy_pass http://websocket-server;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection &quot;Upgrade&quot;;</span><br><span class="line">        proxy_connect_timeout       3600s;</span><br><span class="line">        proxy_read_timeout          3600s;</span><br><span class="line">        proxy_send_timeout          3600s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中需要注意的是：</p>
<ul>
<li>使用“proxy_set_header”设置转发后HTTP报文头的Upgrade和Connection属性；</li>
<li>使用“proxy_connect_timeout”、“proxy_read_timeout”、“proxy_send_timeout”设置连接超时时间，因为WebSocket是长连接，而Nginx反向代理默认超时时间是60秒，这里需要将超时时间设置长一些。<br>WebSocket服务是使用Spring Boot实现的。<br>配置类代码如下：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class WebSocketConfig implements WebSocketConfigurer &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) &#123;</span><br><span class="line">        registry.addHandler(onlineWebSocketHandler(), &quot;/websocket&quot;).setAllowedOrigins(&quot;*&quot;).addInterceptors(onlineHandshakeInterceptor()).withSockJS();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public WebSocketHandler onlineWebSocketHandler() &#123;</span><br><span class="line">        return new PerConnectionWebSocketHandler(OnlineWebSocketHandler.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public HandshakeInterceptor onlineHandshakeInterceptor() &#123;</span><br><span class="line">        return new OnlineHandshakeInterceptor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public ServerEndpointExporter serverEndpointExporter() &#123;</span><br><span class="line">        return new ServerEndpointExporter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>其中通过WebSocketHandlerRegistry实例注册WebSocket处理器，并注册拦截器进行权限控制。需要注意的是，在创建处理器时，使用了PerConnectionWebSocketHandler进行了封装，保证每个WebSocket连接使用一个处理器进行处理，这样处理器就可以是有状态的。<br>WebSocket处理器代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public class OnlineWebSocketHandler extends TextWebSocketHandler &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(OnlineWebSocketHandler.class);</span><br><span class="line"></span><br><span class="line">    private static Map&lt;Integer, WebSocketSession&gt; sessionMap = Maps.newConcurrentMap();</span><br><span class="line"></span><br><span class="line">    private Integer userId;</span><br><span class="line">    private WebSocketSession session;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void afterConnectionEstablished(WebSocketSession session) throws Exception &#123;</span><br><span class="line">        this.userId = (Integer) session.getAttributes().get(Constant.USER_ID);</span><br><span class="line">        this.session = session;</span><br><span class="line">        sessionMap.put(this.userId, this.session);</span><br><span class="line">        logger.info(&quot;add session, userId=&#123;&#125;, total=&#123;&#125;&quot;, this.userId, sessionMap.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void afterConnectionClosed(WebSocketSession session, CloseStatus status)</span><br><span class="line">            throws Exception &#123;</span><br><span class="line">        sessionMap.remove(this.userId);</span><br><span class="line">        logger.info(&quot;remove session, userId=&#123;&#125;, total=&#123;&#125;&quot;, this.userId, sessionMap.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception &#123;</span><br><span class="line">        logger.info(message.getPayload());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void sendMessage(Integer userId, String message) throws IOException &#123;</span><br><span class="line">        if (sessionMap.containsKey(userId)) &#123;</span><br><span class="line">            sessionMap.get(userId).sendMessage(new TextMessage(message));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中，实现了WebSocketHandler接口的afterConnectionEstablished和afterConnectionClosed方法，在afterConnectionEstablished方法中，当WebSocket连接创建后，将连接所对应处理器实例的userId和session注册到静态Map对象中，在 afterConnectionClosed中，当WebSocket连接关闭后，将连接所对应处理器实例的userId和session从静态Map对象中删除。OnlineWebSocketHandler提供了一个静态方法sendMessage，通过调用这个方法，可以向某个指定用户推送消息，其内部是根据userId从静态Map对象查找session，并调用session的sendMessage方法推送消息。<br>WebSocket拦截器代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public class OnlineHandshakeInterceptor implements HandshakeInterceptor &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(OnlineHandshakeInterceptor.class);</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserService userService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean beforeHandshake(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler, Map&lt;String, Object&gt; attributes) throws Exception &#123;</span><br><span class="line">        HttpServletRequest httpRequest = ((ServletServerHttpRequest) request).getServletRequest();</span><br><span class="line">        String userIdStr = httpRequest.getParameter(Constant.USER_ID);</span><br><span class="line">        String session = httpRequest.getParameter(Constant.SESSION);</span><br><span class="line">        if (StringUtils.isBlank(userIdStr) || StringUtils.isBlank(session)) &#123;</span><br><span class="line">            logger.info(&quot;userId and session needed, now useId=&#123;&#125;, session=&#123;&#125;&quot;, userIdStr, session);</span><br><span class="line">            throw new BaseException(BaseExceptionEnum.NOT_ALLOWED);</span><br><span class="line">        &#125;</span><br><span class="line">        int userId = Integer.valueOf(userIdStr);</span><br><span class="line">        if (!userService.checkLogin(userId, session)) &#123;</span><br><span class="line">            throw new BaseException(BaseExceptionEnum.NOT_ALLOWED);</span><br><span class="line">        &#125;</span><br><span class="line">        attributes.put(Constant.USER_ID, userId);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void afterHandshake(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler, Exception exception) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;``` </span><br><span class="line">其中，实现了HandshakeInterceptor接口的beforeHandshake方法，在连接创建开始时，从request中获取url参数userId和session进行权限判断。</span><br><span class="line">Spring Boot启动类代码如下：</span><br></pre></td></tr></table></figure>
<p>@SpringBootApplication<br>@EnableWebMvc<br>@EnableTransactionManagement<br>@EnableWebSocket<br>public class Application {</p>
<pre><code>public static void main(String[] args) throws Exception {
    SpringApplication.run(Application.class, args);
}
</code></pre><p><code>`</code><br>通过EnableWebSocket注解开启WebSocket。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/05/15/e5-9f-ba-e4-ba-8enginx-sticky-module-ng-e5-ae-9e-e7-8e-b0-e4-bc-9a-e8-af-9d-e4-bf-9d-e6-8c-81-ef-bc-88sticky-sessions-ef-bc-89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/15/e5-9f-ba-e4-ba-8enginx-sticky-module-ng-e5-ae-9e-e7-8e-b0-e4-bc-9a-e8-af-9d-e4-bf-9d-e6-8c-81-ef-bc-88sticky-sessions-ef-bc-89/" itemprop="url">基于nginx-sticky-module-ng实现会话保持（Sticky Sessions）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-05-15T14:28:51+08:00">
                2016-05-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>对服务进行集群部署，前端进行负载均衡时，需要实现会话保持，对于同一会话的多个请求，通过集群中的一个节点来提供服务。系统的部署结构如图所示，通过Resin部署Web应用提供服务，通过Nginx进行负载均衡。基于nginx-sticky-module-ng实现会话保持。<br><a href="http://magicwt.com/wp-content/uploads/2016/05/未命名.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/05/未命名.png" alt="未命名"></a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>Nginx已安装（版本为1.7.9），此处介绍如何添加nginx-sticky-module-ng。<br>1）从<a href="https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng下载源码压缩包并解压；" target="_blank" rel="noopener">https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng下载源码压缩包并解压；</a><br>2）“nginx -V”查看原先安装Nginx时的配置信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># /usr/local/nginx/sbin/nginx -V</span><br><span class="line">nginx version: nginx/1.7.9</span><br><span class="line">built by gcc 4.8.2 20140120 (Red Hat 4.8.2-16) (GCC) </span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --with-pcre=/opt/soft/pcre-8.36 --with-zlib=/opt/soft/zlib-1.2.8</span><br><span class="line">``` </span><br><span class="line">3）在Nginx源码目录下使用上述配置信息进行配置，并添加nginx-sticky-module-ng：</span><br></pre></td></tr></table></figure></p>
<p>./configure –prefix=/usr/local/nginx –with-pcre=/opt/soft/pcre-8.36 –with-zlib=/opt/soft/zlib-1.2.8 –add-module=/opt/soft/nginx-sticky-module-1.1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">4）“make”进行编译，若编译时报“src/core/ngx_sha1.h:19:17: fatal error: sha.h: No such file or directory”错误，则先执行“yum install openssl-devel”安装OpenSSL包再配置；</span><br><span class="line">5）编译成功后，备份/usr/local/nginx/sbin/nginx，并使用objs/nginx覆盖/usr/local/nginx/sbin/nginx：</span><br></pre></td></tr></table></figure></p>
<p>mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.backup<br>cp objs/nginx /usr/local/nginx/sbin/<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 配置</span><br><span class="line"></span><br><span class="line">使用Resin启动两个Web应用进程，端口分别是8082和8089，两个Web应用中都包含一个jsp页面session_sticky/test.jsp：</span><br></pre></td></tr></table></figure></p>
<p>&lt;%@ page contentType=”text/html;charset=UTF-8” language=”java” %&gt;</p>
<p><html></html></p>
<p><head><meta name="generator" content="Hexo 3.8.0"><br>    <title>测试Session Sticky</title><br></head></p>
<p><body><br>Service 1</body></p>
<p>Session Id: &lt;%=request.getSession().getId()%&gt;<br><br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">test.jsp在两个Web应用中的不同在于一个输出“Service 1”，另一个输出“Service 2”。</span><br><span class="line">在Nginx中配置upstream和location，实现反向代理和会话保持：</span><br></pre></td></tr></table></figure></p>
<p>upstream session_sticky-server {<br>    sticky;<br>    server xx.xx.xx.xx:8082;<br>    server xx.xx.xx.xx:8089;<br>}</p>
<p>location ^~/session_sticky/ {<br>    proxy_pass <a href="http://session_sticky-server" target="_blank" rel="noopener">http://session_sticky-server</a>;<br>}<br><code>`</code> </p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>1）删除upstream中的“sticky”，使用默认的轮询方式进行反向代理，访问test.jsp，页面输出中交替出现“Service 1”和“Service 2”，说明请求交替发往两个Web应用，会话未保持：<br><a href="http://magicwt.com/wp-content/uploads/2016/05/1.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/05/1-300x142.png" alt="1"></a><br><a href="http://magicwt.com/wp-content/uploads/2016/05/2.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/05/2-300x142.png" alt="2"></a><br>2）在upstream中添加“sticky”，访问test.jsp，页面输出中一直出现“Service 1”，说明请求发往第一个应用，会话保持：<br><a href="http://magicwt.com/wp-content/uploads/2016/05/1.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/05/1-300x142.png" alt="1"></a><br>3）在2）的基础上，停掉第一个应用，继续访问test.jsp，页面仍有响应，输出中一直出现“Service 2”，说明请求在检测到失败后，会自动发往第二个应用，并在第二个应用会话保持：<br><a href="http://magicwt.com/wp-content/uploads/2016/05/2.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/05/2-300x142.png" alt="2"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/06/activemq-e5-9f-ba-e4-ba-8ezookeeper-e5-92-8cleveldb-e5-ae-9e-e7-8e-b0masterslave/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/06/activemq-e5-9f-ba-e4-ba-8ezookeeper-e5-92-8cleveldb-e5-ae-9e-e7-8e-b0masterslave/" itemprop="url">ActiveMQ基于Zookeeper和LevelDB实现Master/Slave</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-03-06T14:44:03+08:00">
                2016-03-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>ActiveMQ的Master/Slave目前支持三种实现方式：</p>
<ol>
<li>Shared File System Master Slave；</li>
<li>JDBC Master Slave；</li>
<li>Replicated LevelDB Store。<br>对于第三种方式，ActiveMQ使用LevelDB持久化数据，并使用Zookeeper协调集群中各节点选举Master，如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2016/03/replicated-leveldb-store.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/03/replicated-leveldb-store.png" alt="replicated-leveldb-store"></a></li>
</ol>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/03/06/activemq-e5-9f-ba-e4-ba-8ezookeeper-e5-92-8cleveldb-e5-ae-9e-e7-8e-b0masterslave/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/05/keepalivedssdb-e5-8f-8c-e4-b8-bb-e9-ab-98-e5-8f-af-e7-94-a8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/05/keepalivedssdb-e5-8f-8c-e4-b8-bb-e9-ab-98-e5-8f-af-e7-94-a8/" itemprop="url">Keepalived+SSDB双主高可用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-03-05T15:52:30+08:00">
                2016-03-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务器/" itemprop="url" rel="index">
                    <span itemprop="name">服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>SSDB是一个C/C++语言开发的高性能NoSQL数据库，支持KV，list，map（hash），zset（sorted set）等数据结构，用来替代或者与Redis配合存储十亿级别列表的数据。与Redis相比，SSDB的存储基于文件，因此可以存储更多的数据，而不受限于内存的大小。在实际应用中，我们使用SSDB存储网站实时流量数据。本文主要介绍如何搭建SSDB双主，并使用Keepalived做IP漂移，使得双主对客户端透明。只要双主中有一个服务正常，客户端就可以正常读写，并保证数据不会丢失。其结构如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2016/03/keepalivedssdb.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/03/keepalivedssdb.png" alt="keepalived+ssdb"></a></p>
<h2 id="安装SSDB"><a href="#安装SSDB" class="headerlink" title="安装SSDB"></a>安装SSDB</h2><p>在两台服务器上下载SSDB源码包master.zip（<a href="https://github.com/ideawu/ssdb/archive/master.zip），解压后先后执行“make”和“make" target="_blank" rel="noopener">https://github.com/ideawu/ssdb/archive/master.zip），解压后先后执行“make”和“make</a> install”完成安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">unzip master.zip </span><br><span class="line">cd ssdb-master</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">``` </span><br><span class="line">SSDB默认安装至/usr/local/ssdb。</span><br><span class="line"></span><br><span class="line">## 配置SSDB</span><br><span class="line"></span><br><span class="line">修改/usr/local/ssdb中的配置文件ssdb.conf：</span><br></pre></td></tr></table></figure></p>
<h1 id="ssdb-server-config"><a href="#ssdb-server-config" class="headerlink" title="ssdb-server config"></a>ssdb-server config</h1><h1 id="MUST-indent-by-TAB"><a href="#MUST-indent-by-TAB" class="headerlink" title="MUST indent by TAB!"></a>MUST indent by TAB!</h1><h1 id="配置目录"><a href="#配置目录" class="headerlink" title="配置目录"></a>配置目录</h1><p>work_dir = /data/ssdb-shard<br>pidfile = /data/ssdb-shard/ssdb.pid</p>
<h1 id="配置访问"><a href="#配置访问" class="headerlink" title="配置访问"></a>配置访问</h1><p>server:</p>
<pre><code># IP配置为0.0.0.0，则任何一个IP都可以访问
ip: 0.0.0.0
port: 8888
# 可以配置访问IP和访问密码，我们使用iptables配置访问IP，因此不在此处配置
# format: allow|deny: all|ip_prefix
# multiple allows or denys is supported
#deny: all
#allow: 127.0.0.1
#allow: 192.168
# auth password must be at least 32 characters
#auth: very-strong-password
</code></pre><h1 id="配置同步和复制"><a href="#配置同步和复制" class="headerlink" title="配置同步和复制"></a>配置同步和复制</h1><h1 id="双主下，当前SSDB是另一个SSDB的从，需要从另一个SSDB同步和复制数据"><a href="#双主下，当前SSDB是另一个SSDB的从，需要从另一个SSDB同步和复制数据" class="headerlink" title="双主下，当前SSDB是另一个SSDB的从，需要从另一个SSDB同步和复制数据"></a>双主下，当前SSDB是另一个SSDB的从，需要从另一个SSDB同步和复制数据</h1><p>replication:<br>        binlog: yes</p>
<pre><code># Limit sync speed to *MB/s, -1: no limit
sync_speed: -1
slaveof:
        # to identify a master even if it moved(ip, port changed)
        # if set to empty or not defined, ip:port will be used.
        id: svc_2
        # sync|mirror, default is sync
        # 由于双主是双向同步，如果使用sync，则会造成双主重复一直同步，死循环
        type: mirror
        ip: xx.xx.xx.xx
        port: 8888
</code></pre><h1 id="配置日志"><a href="#配置日志" class="headerlink" title="配置日志"></a>配置日志</h1><p>logger:<br>        level: error<br>        output: log.txt<br>        rotate:<br>                size: 1000000000</p>
<h1 id="配置LevelDB，SSDB使用LevelDB作为底层存储引擎"><a href="#配置LevelDB，SSDB使用LevelDB作为底层存储引擎" class="headerlink" title="配置LevelDB，SSDB使用LevelDB作为底层存储引擎"></a>配置LevelDB，SSDB使用LevelDB作为底层存储引擎</h1><p>leveldb:</p>
<pre><code># in MB
cache_size: 500
# in KB
block_size: 32
# in MB
write_buffer_size: 64
# in MB
compaction_speed: 1000
# yes|no
compression: yes
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 启动SSDB</span><br><span class="line"></span><br><span class="line">启动两台服务器上的SSDB：</span><br></pre></td></tr></table></figure>
<h1 id="启动为后台进程-不阻塞命令行"><a href="#启动为后台进程-不阻塞命令行" class="headerlink" title="启动为后台进程(不阻塞命令行)"></a>启动为后台进程(不阻塞命令行)</h1><p>/usr/local/ssdb/ssdb-server -d ssdb.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">使用/usr/local/ssdb/ssdb-cli进入命令行，使用info命令查看SSDB信息：</span><br><span class="line">[![1](http://magicwt.com/wp-content/uploads/2016/03/1.png)](http://magicwt.com/wp-content/uploads/2016/03/1.png)</span><br><span class="line">从replication信息可以看到当前SSDB作为另一个SSDB的从，而在另一个SSDB中通过info命令也可以看到其是当前SSDB的从。而在某个SSDB使用set命令写入一个键值时，在另一个SSDB使用get命令可读出这个键值，说明SSDB双主搭建成功，这两个SSDB只要有一个服务正常，就可以正常对外提供读写，并保证数据不会丢失。</span><br><span class="line"></span><br><span class="line">## 配置Keepalived</span><br><span class="line"></span><br><span class="line">对于客户端，在访问SSDB双主时，需要知道各个SSDB的地址，并且自己实现fail-over机制，在无法读写某个SSDB时，重新尝试读写另一个SSDB。我们使用Keepalived监控SSDB，对外提供虚IP供客户端连接读写，虚IP初始映射到某个SSDB，当该SSDB不可用时，将虚IP漂移到另一个SSDB，这样，双主对于客户端是透明的，客户端只要连接虚IP即可。此处不再介绍Keepalived的安装和运行，可参见《Keepalived介绍》(http://magicwt.com/2013/06/30/keepalived%E4%BB%8B%E7%BB%8D/)，Keepalived的主配置keepalived.conf如下：</span><br></pre></td></tr></table></figure></p>
<p>! Configuration File for keepalived</p>
<p>global_defs {<br>   router_id ssdb_1<br>}</p>
<p>vrrp_script chk_ssdb {<br>    script “/usr/local/keepalived/scripts/ssdb_check.sh 127.0.0.1 8888”<br>    interval 5<br>    weight -2<br>}</p>
<p>vrrp_instance VI_1 {<br>    state BACKUP<br>    interface eth0<br>    virtual_router_id 225<br>    priority 101<br>    advert_int 1<br>    nopreempt<br>    authentication {<br>        auth_type PASS<br>        auth_pass 1111<br>    }<br>    virtual_ipaddress {<br>        xx.xx.xx.xx<br>    }<br>    track_script {<br>        chk_ssdb<br>    }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">其中每隔5秒执行一个脚本检查SSDB服务是否可用，如不可用，则将权重减小2至99，而Keepalived从配置中权重为100，因此，从切换为主，并配置虚IP，保证了虚IP所在的SSDB服务一直可用。ssdb_check.sh脚本如下所示：</span><br></pre></td></tr></table></figure></p>
<p>#!/bin/bash<br>LOGFILE=”/var/log/keepalived-ssdb-check.log”<br>if [ “<code>/usr/local/bin/redis-cli -h $1 -p $2 PING</code>“ == “PONG” ]; then :<br>   exit 0<br>else<br>   sleep 1<br>   if [ “<code>/usr/local/bin/redis-cli -h $1 -p $2 PING</code>“ == “PONG” ]; then :<br>      exit 0<br>   else<br>      date &gt;&gt; $LOGFILE<br>      echo “Failed:redis-cli -h $1 -p $2 PING” &gt;&gt; $LOGFILE 2&gt;&amp;1<br>      exit 1<br>   fi<br>fi<br><code>`</code><br>由于SSDB兼容Redis部分协议，因此此处使用Redis的命令行工具PING SSDB检查服务是否可用。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/02/26/e8-bd-ac-e5-88-86-e5-b8-83-e5-bc-8f-e7-bc-93-e5-ad-98-e9-9b-86-e7-be-a4-e6-96-b9-e6-a1-88-e7-89-b9-e6-80-a7-e3-80-81-e5-ba-94-e7-94-a8-e5-9c-ba-e6-99-af-e3-80-81-e4-bc-98-e7-bc-ba-e7-82-b9-e5-af-b9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/02/26/e8-bd-ac-e5-88-86-e5-b8-83-e5-bc-8f-e7-bc-93-e5-ad-98-e9-9b-86-e7-be-a4-e6-96-b9-e6-a1-88-e7-89-b9-e6-80-a7-e3-80-81-e5-ba-94-e7-94-a8-e5-9c-ba-e6-99-af-e3-80-81-e4-bc-98-e7-bc-ba-e7-82-b9-e5-af-b9/" itemprop="url">[转]分布式缓存集群方案特性、应用场景、优缺点对比及选型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-02-26T16:57:21+08:00">
                2016-02-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/缓存-NoSQL/" itemprop="url" rel="index">
                    <span itemprop="name">缓存/NoSQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文地址：<a href="http://blog.csdn.net/tantexian/article/details/49994753" target="_blank" rel="noopener">http://blog.csdn.net/tantexian/article/details/49994753</a></p>
<h2 id="分布式缓存特性："><a href="#分布式缓存特性：" class="headerlink" title="分布式缓存特性："></a>分布式缓存特性：</h2><p>1) 高性能：当传统数据库面临大规模数据访问时，磁盘I/O往往成为性能瓶颈，从而导致过高的响应延迟。分布式缓存将高速内存作为数据对象的存储介质，数据以key/value形式存储，理想情况下可以获得DRAM级的读写性能；<br>2) 动态扩展性：支持弹性扩展，通过动态增加或减少节点应对变化的数据访问负载，提供可预测的性能与扩展性；同时，最大限度地提高资源利用率；<br>3) 高可用性：可用性包含数据可用性与服务可用性两方面。基于冗余机制实现高可用性，无单点失效（single point of failure），支持故障的自动发现，透明地实施故障切换，不会因服务器故障而导致缓存服务中断或数据丢失。动态扩展时自动均衡数据分区，同时保障缓存服务持续可用；<br>4) 易用性：提供单一的数据与管理视图；API接口简单，且与拓扑结构无关；动态扩展或失效恢复时无需人工配置；自动选取备份节点；多数缓存系统提供了图形化的管理控制台，便于统一维护；<br>5) 分布式代码执行（distributed code execution）：将任务代码转移到各数据节点并行执行，客户端聚合返回结果，从而有效避免了缓存数据的移动与传输。最新的Java数据网格规范JSR-347中加入了分布式代码执行与Map/reduce的API支持，各主流分布式缓存产品，如IBM WebSphere eXtreme Scale，VMware GemFire，GigaSpaces XAP和Red Hat Infinispan等也都支持这一新的编程模型。</p>
<h2 id="分布式缓存应用场景："><a href="#分布式缓存应用场景：" class="headerlink" title="分布式缓存应用场景："></a>分布式缓存应用场景：</h2><p>1) 页面缓存。用来缓存Web页面的内容片段，包括HTML、CSS和图片等，多应用于社交网站等；<br>2) 应用对象缓存。缓存系统作为ORM框架的二级缓存对外提供服务，目的是减轻数据库的负载压力，加速应用访问；<br>3) 状态缓存。缓存包括Session会话状态及应用横向扩展时的状态数据等，这类数据一般是难以恢复的，对可用性要求较高，多应用于高可用集群（解决分布式Web部署的session同步问题）；<br>4) 并行处理。通常涉及大量中间计算结果需要共享；<br>5) 事件处理。分布式缓存提供了针对事件流的连续查询（continuous query）处理技术，满足实时性需求；<br>6) 极限事务处理。分布式缓存为事务型应用提供高吞吐率、低延时的解决方案，支持高并发事务请求处理，多应用于铁路、金融服务和电信等领域；<br>7) 云计算领域提供分布式缓存服务（例如：青云、UnitedStack等）；<br>8) 任何需要用到缓存的地方，解决本地缓存数据量太小问题。分布式缓存能有效防止本地缓存失效数据库雪崩现象。</p>
<h2 id="两大开源缓存系统对比，Memcache-VS-Redis："><a href="#两大开源缓存系统对比，Memcache-VS-Redis：" class="headerlink" title="两大开源缓存系统对比，Memcache VS Redis："></a>两大开源缓存系统对比，Memcache VS Redis：</h2><p>1) Redis不仅仅支持简单的k/v类型的数据，同时还提供list，set，zset，hash等数据结构的存储。而Memcache只支持简单数据类型，需要客户端自己处理复杂对象。<br>2) Redis支持数据的持久化，可以将内存中的数据保持在磁盘中，重启的时候可以再次加载进行使用（PS：持久化在RDB、AOF）。Redis借助了fork命令的copy on write机制。在生成快照时，将当前进程fork出一个子进程，然后在子进程中循环所有的数据，将数据写成为RDB文件。AOF日志的全称是append only file，从名字上我们就能看出来，它是一个追加写入的日志文件。与一般数据库的binlog不同的是，AOF文件是可识别的纯文本，它的内容就是一个个的Redis标准命令。当然，并不是发送到Redis的所有命令都要记录到AOF日志里面，只有那些会导致数据发生修改的命令才会追加到AOF文件。那么每一条修改数据的命令都生成一条日志。（PS：Memcache不支持数据持久存储）。<br>3) 由于Memcache没有持久化机制，因此宕机所有缓存数据失效。Redis配置为持久化，宕机重启后，将自动加载宕机时刻的数据到缓存系统中。具有更好的灾备机制。<br>4) Memcache可以使用Magent在客户端进行一致性hash做分布式。Redis支持在服务器端做分布式（PS：Twemproxy/Codis/Redis-cluster多种分布式实现方式）<br>5) Memcache的简单限制就是键（key）和value的限制。最大键长为250个字符。可以接受的储存数据不能超过1MB（可修改配置文件变大），因为这是典型slab的最大值，不适合虚拟机使用。而Redis的key长度支持到512k。<br>6) Redis使用的是单线程模型，保证了数据按顺序提交。Memcache需要使用CAS保证数据一致性。CAS（Check and Set）是一个确保并发一致性的机制，属于“乐观锁”范畴；原理很简单：拿版本号，操作，对比版本号，如果一致就操作，不一致就放弃任何操作。<br>7) CPU利用。由于Redis只使用单核，而Memcache可以使用多核，所以平均每一个核上Redis在存储小数据时比Memcache性能更高。而在100k以上的数据中，Memcache性能要高于Redis。（PS：Redis可以通过开启多个实例来提高CPU利用率，Memcache默认是单线程，需要编译指定参数才能支持多线程。由于分布式缓存是IO密集型系统，所以性能很大程度受限于网络通信，Memcache使用了libevent网络库，Redis自己实现了一套通信库。线程也不是影响吞吐量的重要因素。如第一点来说，一般情况下，程序处理内存数据的速度远高于网卡接收的速度。使用线程好处是可以同时处理多条连接，在极端情况下，可能会提高响应速度。但是单线程有时候比多线程或多进程更快，不需要考虑并发、锁，也不会增加上下文切换等开销，代码更加简洁，执行效率更高。）<br>8) Memcache内存管理：使用Slab Allocation。原理相当简单，预先分配一系列大小固定的组，然后根据数据大小选择最合适的块存储。避免了内存碎片。（缺点：不能变长，浪费了一定空间）Memcache默认情况下下一个slab的最大值为前一个的1.25倍。<br>9) Redis内存管理：Redis通过定义一个数组来记录所有的内存分配情况， Redis采用的是包装的malloc/free，相较于Memcache的内存管理方法来说，要简单很多。由于malloc首先以链表的方式搜索已管理的内存中可用的空间分配，导致内存碎片比较多。<br>总结：<br>其实对于企业选型Memcache、Redis而言，更多还是应该看业务使用场景（因为Memcache、Redis两者都具有足够高的性能和稳定性）。假若业务场景需要用到持久化缓存功能、或者支持多种数据结构的缓存功能，那么Redis则是最佳选择。<br>（PS：Redis集群解决方式也优于Memcache，Memcache在客户端一致性hash的集群解决方案，Redis采用无中心的服务器端集群解决方案）<br>综上所述：为了让缓存系统能够支持更多的业务场景，选择Redis会更优。（目前也越来越多的厂商选择Redis）。</p>
<h2 id="Redis三大集群解决方案对比，Twemproxy-VS-Codis-VS-Redis-Cluster"><a href="#Redis三大集群解决方案对比，Twemproxy-VS-Codis-VS-Redis-Cluster" class="headerlink" title="Redis三大集群解决方案对比，Twemproxy VS Codis VS Redis-Cluster"></a>Redis三大集群解决方案对比，Twemproxy VS Codis VS Redis-Cluster</h2><h3 id="Redis集群三种常见的解决方案："><a href="#Redis集群三种常见的解决方案：" class="headerlink" title="Redis集群三种常见的解决方案："></a>Redis集群三种常见的解决方案：</h3><p>1) 客户端分片：这种方案将分片工作放在业务程序端，程序代码根据预先设置的路由规则，直接对多个Redis实例进行分布式访问。这样的好处是，不依赖于第三方分布式中间件，实现方法和代码都自己掌控，可随时调整，不用担心踩到坑。这实际上是一种静态分片技术。Redis实例的增减，都得手工调整分片程序。基于此分片机制的开源产品，现在仍不多见。这种分片机制的性能比代理式更好（少了一个中间分发环节）。但缺点是升级麻烦，对研发人员的个人依赖性强——需要有较强的程序开发能力做后盾。如果主力程序员离职，可能新的负责人，会选择重写一遍。所以，这种方式下，可运维性较差。出现故障，定位和解决都得研发和运维配合着解决，故障时间变长。因此这种方案，难以进行标准化运维，不太适合中小公司（除非有足够的DevOPS）。<br>2) 代理分片：这种方案，将分片工作交给专门的代理程序来做。代理程序接收到来自业务程序的数据请求，根据路由规则，将这些请求分发给正确的Redis实例并返回给业务程序。这种机制下，一般会选用第三方代理程序（而不是自己研发），因为后端有多个Redis实例，所以这类程序又称为分布式中间件。这样的好处是，业务程序不用关心后端Redis实例，运维起来也方便。虽然会因此带来些性能损耗，但对于Redis这种内存读写型应用，相对而言是能容忍的。这是我们推荐的集群实现方案。像基于该机制的开源产品Twemproxy，Codis便是其中代表，应用非常广泛。<br>3) 服务器端分片：建立在基于无中心分布式架构之上（没有代理节点性能瓶颈问题）。Redis-Cluster即为官方基于该架构的解决方案。Redis Cluster将所有Key映射到16384个Slot中，集群中每个Redis实例负责一部分，业务程序通过集成的Redis Cluster客户端进行操作。客户端可以向任一实例发出请求，如果所需数据不在该实例中，则该实例引导客户端自动去对应实例读写数据。Redis Cluster的成员管理（节点名称、IP、端口、状态、角色）等，都通过节点之间两两通讯，定期交换并更新。</p>
<h3 id="各解决方案代表产品实现方式优缺点："><a href="#各解决方案代表产品实现方式优缺点：" class="headerlink" title="各解决方案代表产品实现方式优缺点："></a>各解决方案代表产品实现方式优缺点：</h3><p>Twemproxy：<br>Twemproxy是一种代理分片机制，由Twitter开源。Twemproxy作为代理，可接受来自多个程序的访问，按照路由规则，转发给后台的各个Redis服务器，再原路返回。这个方案顺理成章地解决了单个Redis实例承载能力的问题。当然，Twemproxy本身也是单点，需要用Keepalived做高可用方案。这么些年来，Twemproxy是应用范围最广、稳定性最高、最久经考验的分布式中间件。只是，他还有诸多不方便之处。Twemproxy最大的痛点在于，无法平滑地扩容/缩容。这样增加了运维难度：业务量突增，需增加Redis服务器；业务量萎缩，需要减少Redis服务器。但对Twemproxy而言，基本上都很难操作。或者说，Twemproxy更加像服务器端静态sharding。有时为了规避业务量突增导致的扩容需求，甚至被迫新开一个基于Twemproxy的Redis集群。Twemproxy另一个痛点是，运维不友好，甚至没有控制面板。<br>Codis：<br>Codis由豌豆荚于2014年11月开源，基于Go和C开发，是近期涌现的、国人开发的优秀开源软件之一。现已广泛用于豌豆荚的各种Redis业务场景，从各种压力测试来看，稳定性符合高效运维的要求。性能更是改善很多，最初比Twemproxy慢20%；现在比Twemproxy快近100%（条件：多实例，一般value长度）。Codis具有可视化运维管理界面。Codis无疑是为解决Twemproxy缺点而出的新解决方案。因此综合方面会优于Twemproxy很多。目前也越来越多公司选择Codis。Codis引入了Group的概念，每个Group包括1个Redis Master及至少1个Redis Slave，这是和Twemproxy的区别之一。这样做的好处是，如果当前Master有问题，则运维人员可通过Dashboard“自助式”切换到Slave，而不需要小心翼翼地修改程序配置文件。为支持数据热迁移（Auto Rebalance），出品方修改了Redis Server源码，并称之为Codis Server。Codis采用预先分片（Pre-Sharding）机制，事先规定好了，分成1024个slots（也就是说，最多能支持后端1024个Codis Server），这些路由信息保存在ZooKeeper中。<br>Redis-Cluster：<br>Reids-Cluster在Redis3.0中推出，支持Redis分布式集群部署模式。采用无中心分布式架构。所有的Redis节点彼此互联（PING-PONG机制），内部使用二进制协议优化传输速度和带宽。节点的fail是通过集群中超过半数的节点检测失效时才生效。客户端与Redis节点直连，不需要中间proxy层。客户端不需要连接集群所有节点，连接集群中任何一个可用节点即可，减少了代理层，大大提高了性能。Redis-Cluster把所有的物理节点映射到[0-16383]slot上，cluster负责维护node<->slot<->key之间的关系。目前Jedis已经支持Redis-Cluster。从计算架构或者性能方面无疑Redis-Cluster是最佳的选择方案。（PS：虽然Redis-Cluster从方案选型上面比较占据优势，但是由于Redis-Cluster刚推出不久，虽然官方宣传已经发布的是文档版本，但稳定性方面还有待验证）。</-></-></p>
<script>// <![CDATA[
jQuery(function(){jQuery(".copyright").hide();});
// ]]></script>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/02/23/keepalivedredis-e9-ab-98-e5-8f-af-e7-94-a8-e4-b8-bb-e4-bb-8e-e8-99-9aip-e7-bb-8f-e5-b8-b8-e6-bc-82-e7-a7-bb-e7-9a-84-e9-97-ae-e9-a2-98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/02/23/keepalivedredis-e9-ab-98-e5-8f-af-e7-94-a8-e4-b8-bb-e4-bb-8e-e8-99-9aip-e7-bb-8f-e5-b8-b8-e6-bc-82-e7-a7-bb-e7-9a-84-e9-97-ae-e9-a2-98/" itemprop="url">Keepalived+Redis高可用主从虚IP经常漂移的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-02-23T23:18:51+08:00">
                2016-02-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务器/" itemprop="url" rel="index">
                    <span itemprop="name">服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用Keepalived+Redis搭建Redis高可用主从，其中Keepalived配置为每隔2秒执行脚本检查Redis服务是否可用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">vrrp_script chk_redis &#123;</span><br><span class="line">    script &quot;/usr/local/keepalived/scripts/redis_check.sh 127.0.0.1 6379&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight -2</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line">redis_check.sh脚本如下所示：</span><br></pre></td></tr></table></figure></p>
<p>#!/bin/bash<br>LOGFILE=”/var/log/keepalived-redis-check.log”<br>if [ “<code>/usr/local/bin/redis-cli -h $1 -p $2 PING</code>“ == “PONG” ]; then :<br>   exit 0<br>else<br>   sleep 1<br>   if [ “<code>/usr/local/bin/redis-cli -h $1 -p $2 PING</code>“ == “PONG” ]; then :<br>      exit 0<br>   else<br>      date &gt;&gt; $LOGFILE<br>      echo “Failed:redis-cli -h $1 -p $2 PING” &gt;&gt; $LOGFILE 2&gt;&amp;1<br>      exit 1<br>   fi<br>fi<br><code>`</code><br>使用过程中发现虚IP会经常从主服务器漂移至从服务器，而此时主服务器Keepalived和Redis进程都在。查看/var/log/messages中的Keepalived日志：<br><a href="http://magicwt.com/wp-content/uploads/2016/02/1-7.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/02/1-7.png" alt="1"></a><br>发现是由于检查Redis服务是否可用的脚本超时，减少了主服务器Keepalived的权重，从而导致主从服务器状态切换、虚IP漂移，而脚本执行超时时间默认与执行间隔相等（2秒）。脚本主要执行Redis的PING操作，为什么有时候执行PING操作会超过2秒，进一步检查发现是该Redis在某些时间段读写频率非常高，QPS达到6万，造成PING操作响应慢。<br>针对这个问题，解决方法就是搭建多个Redis主从，通过代理或直接在客户端将请求分摊到各个Redis主从上，减少单个Redis主从压力，避免PING操作响应慢，另外就是增大脚本执行间隔，增大执行超时时间。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/02/15/e4-b8-80-e4-b8-aa-e7-ae-80-e5-8d-95-e7-9a-84dubbo-e7-a4-ba-e4-be-8b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/02/15/e4-b8-80-e4-b8-aa-e7-ae-80-e5-8d-95-e7-9a-84dubbo-e7-a4-ba-e4-be-8b/" itemprop="url">一个简单的Dubbo示例</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-02-15T13:05:46+08:00">
                2016-02-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="定义服务接口及其实现"><a href="#定义服务接口及其实现" class="headerlink" title="定义服务接口及其实现"></a>定义服务接口及其实现</h2><p>服务接口TestService：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.magicwt.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">greet</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>服务实现TestServiceImpl：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.magicwt.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.magicwt.service.TestService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServiceImpl</span> <span class="keyword">implements</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">greet</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hi, "</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/02/15/e4-b8-80-e4-b8-aa-e7-ae-80-e5-8d-95-e7-9a-84dubbo-e7-a4-ba-e4-be-8b/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/02/14/dubbo-e7-ae-80-e4-bb-8b-e4-b8-8e-e5-ae-9e-e8-b7-b5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/02/14/dubbo-e7-ae-80-e4-bb-8b-e4-b8-8e-e5-ae-9e-e8-b7-b5/" itemprop="url">Dubbo简介与实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-02-14T17:08:54+08:00">
                2016-02-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Dubbo（<a href="http://dubbo.io/）" target="_blank" rel="noopener">http://dubbo.io/）</a> 是阿里开源的分布式服务框架，架构如图所示：<br><a href="http://magicwt.com/wp-content/uploads/2016/02/1-12.jpg" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/02/1-12.jpg" alt="1"></a><br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/02/14/dubbo-e7-ae-80-e4-bb-8b-e4-b8-8e-e5-ae-9e-e8-b7-b5/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/02/05/docker-e7-ae-80-e4-bb-8b-e4-b8-8e-e5-ae-9e-e8-b7-b5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magicwt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magicwt的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/02/05/docker-e7-ae-80-e4-bb-8b-e4-b8-8e-e5-ae-9e-e8-b7-b5/" itemprop="url">Docker简介与实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-02-05T11:34:20+08:00">
                2016-02-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务器/" itemprop="url" rel="index">
                    <span itemprop="name">服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>Docker（<a href="http://www.docker.com/）" target="_blank" rel="noopener">http://www.docker.com/）</a> 是一个开源的应用容器引擎。Docker可以将应用程序及其依赖打包成镜像（Image），并在同一个服务器中启动多个容器（Container）共享操作系统内核，分别独立运行镜像（Image）。<br><a href="http://magicwt.com/wp-content/uploads/2016/02/1-1.png" target="_blank" rel="noopener"><img src="http://magicwt.com/wp-content/uploads/2016/02/1-1.png" alt="1"></a><br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/02/05/docker-e7-ae-80-e4-bb-8b-e4-b8-8e-e5-ae-9e-e8-b7-b5/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">magicwt</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">90</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">49</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/magicwt" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:wang-t04@mails.tsinghua.edu.cn" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">magicwt</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
